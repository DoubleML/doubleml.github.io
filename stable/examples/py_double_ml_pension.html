

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Python: Impact of 401(k) on Financial Wealth &#8212; DoubleML  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=e353d410970836974a52" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=e353d410970836974a52" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=e353d410970836974a52" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=e353d410970836974a52" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52" />

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/py_double_ml_pension';</script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python: Cluster Robust Double Machine Learning" href="py_double_ml_multiway_cluster.html" />
    <link rel="prev" title="R: Cluster Robust Double Machine Learning" href="r_double_ml_multiway_cluster.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  <div class="navbar-header-items__start">
    
      <div class="navbar-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    <p class="title logo__title">DoubleML  documentation</p>
  
</a></div>
    
  </div>
  
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../intro/install.html">
                         Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../intro/intro.html">
                         Getting started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../workflow/workflow.html">
                         Workflow
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../guide/guide.html">
                         User guide
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                         Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/api.html">
                         Python API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://docs.doubleml.org/r/stable/">
                         R API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../literature/literature.html">
                         Literature
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../release/release.html">
                         Release notes
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
        </div>
      
      
        <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
  </button>
`);
</script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item"><nav class="navbar-nav">
  <p class="sidebar-header-items__title"
     role="heading"
     aria-level="1"
     aria-label="Site Navigation">
    Site Navigation
  </p>
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../intro/install.html">
                         Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../intro/intro.html">
                         Getting started
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../workflow/workflow.html">
                         Workflow
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../guide/guide.html">
                         User guide
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                         Examples
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../api/api.html">
                         Python API
                      </a>
                    </li>
                
            <div class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    More
                </button>
                <div class="dropdown-menu">
                    
                    <li class="nav-item">
                      <a class="nav-link nav-external" href="https://docs.doubleml.org/r/stable/">
                         R API
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../literature/literature.html">
                         Literature
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../release/release.html">
                         Release notes
                      </a>
                    </li>
                
                </div>
            </div>
            
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">
<script>
document.write(`
  <button class="theme-switch-button btn btn-sm btn-outline-primary navbar-btn rounded-circle" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch" data-mode="light"><i class="fa-solid fa-sun"></i></span>
    <span class="theme-switch" data-mode="dark"><i class="fa-solid fa-moon"></i></span>
    <span class="theme-switch" data-mode="auto"><i class="fa-solid fa-circle-half-stroke"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><p class="logo" style="text-align:center;"><a href="../index.html">
    <img class="logo" src="../logo.png" alt="Logo" width="65%" height="65%">
</a></p>

<script type="text/javascript">
    // Change the logo depending on the theme
    var logo = document.querySelector('img.logo');
    var observer = new MutationObserver(function(mutations) {
        const dark = document.documentElement.dataset.theme == 'dark';
        if (dark) {
            logo.src = "../logo_dark.png";
        } else {
            logo.src = "../logo.png";
        }
    });
    observer.observe(document.documentElement, {attributes: true, attributeFilter: ['data-theme']});
</script></div>
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item"><nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_pension.html">R: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="r_double_ml_multiway_cluster.html">R: Cluster Robust Double Machine Learning</a></li>
</ul>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Python: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_multiway_cluster.html">Python: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate.html">Python: Group Average Treatment Effects (GATEs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cate.html">Python: Conditional Average Treatment Effects (CATEs)</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_did.html">Python: Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_did_pretest.html">Python: Difference-in-Differences Pre-Testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pension_qte.html">Python: Impact of 401(k) on Financial Wealth (Quantile Effects)</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pq.html">Python: Potential Quantiles and Quantile Treatment Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cvar.html">Python: Conditional Value at Risk of potential outcomes</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_learner.html">Python: Choice of learners</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_sensitivity.html">Python: Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_policy_tree.html">Python: Policy Learning with Trees</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_pipeline.html">R: Ensemble Learners and More with <code class="docutils literal notranslate"><span class="pre">mlr3pipelines</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="double_ml_bonus_data.html">DML: Bonus Data</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumbs">
  <ul class="bd-breadcrumbs" role="navigation" aria-label="Breadcrumb">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Python: Impact of 401(k) on Financial Wealth</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
      <div class="admonition note">
    <p class="admonition-title">Note</p>
    <ul class="simple">

Download Jupyter notebook:
<a class="reference external" href="https://docs.doubleml.org/stable/examples/py_double_ml_pension.ipynb">https://docs.doubleml.org/stable/examples/py_double_ml_pension.ipynb</a>.

    </ul>
    </div><section id="Python:-Impact-of-401(k)-on-Financial-Wealth">
<h1>Python: Impact of 401(k) on Financial Wealth<a class="headerlink" href="#Python:-Impact-of-401(k)-on-Financial-Wealth" title="Permalink to this heading">#</a></h1>
<p>In this real-data example, we illustrate how the <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> package can be used to estimate the effect of 401(k) eligibility and participation on accumulated assets. The 401(k) data set has been analyzed in several studies, among others <a class="reference external" href="https://arxiv.org/abs/1608.00060">Chernozhukov et al. (2018)</a>.</p>
<p>401(k) plans are pension accounts sponsored by employers. The key problem in determining the effect of participation in 401(k) plans on accumulated assets is saver heterogeneity coupled with the fact that the decision to enroll in a 401(k) is non-random. It is generally recognized that some people have a higher preference for saving than others. It also seems likely that those individuals with high unobserved preference for saving would be most likely to choose to participate in tax-advantaged
retirement savings plans and would tend to have otherwise high amounts of accumulated assets. The presence of unobserved savings preferences with these properties then implies that conventional estimates that do not account for saver heterogeneity and endogeneity of participation will be biased upward, tending to overstate the savings effects of 401(k) participation.</p>
<p>One can argue that eligibility for enrolling in a 401(k) plan in this data can be taken as exogenous after conditioning on a few observables of which the most important for their argument is income. The basic idea is that, at least around the time 401(k)’s initially became available, people were unlikely to be basing their employment decisions on whether an employer offered a 401(k) but would instead focus on income and other aspects of the job.</p>
<section id="Data">
<h2>Data<a class="headerlink" href="#Data" title="Permalink to this heading">#</a></h2>
<p>The preprocessed data can be fetched by calling <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.datasets.fetch_401K.html#doubleml.datasets.fetch_401K">fetch_401K()</a>. Note that an internet connection is required for loading the data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">doubleml</span> <span class="k">as</span> <span class="nn">dml</span>
<span class="kn">from</span> <span class="nn">doubleml.datasets</span> <span class="kn">import</span> <span class="n">fetch_401K</span>

<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LassoCV</span><span class="p">,</span> <span class="n">LogisticRegressionCV</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">RandomForestClassifier</span><span class="p">,</span> <span class="n">RandomForestRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.tree</span> <span class="kn">import</span> <span class="n">DecisionTreeClassifier</span><span class="p">,</span> <span class="n">DecisionTreeRegressor</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>

<span class="kn">from</span> <span class="nn">xgboost</span> <span class="kn">import</span> <span class="n">XGBClassifier</span><span class="p">,</span> <span class="n">XGBRegressor</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">7.5</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set_style</span><span class="p">(</span><span class="s1">&#39;whitegrid&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;axes.spines.top&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;axes.spines.bottom&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;axes.spines.left&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s1">&#39;axes.spines.right&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">fetch_401K</span><span class="p">(</span><span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;DataFrame&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Temporary fix for https://github.com/DoubleML/doubleml-docs/issues/45 / https://github.com/scikit-learn/scikit-learn/issues/21997</span>
<span class="c1"># Can be removed when scikit-learn version 1.2.0 is released</span>
<span class="n">dtypes</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dtypes</span>
<span class="n">dtypes</span><span class="p">[</span><span class="s1">&#39;nifa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
<span class="n">dtypes</span><span class="p">[</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
<span class="n">dtypes</span><span class="p">[</span><span class="s1">&#39;tw&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
<span class="n">dtypes</span><span class="p">[</span><span class="s1">&#39;inc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;float64&#39;</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtypes</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
      nifa  net_tfa        tw  age      inc  fsize  educ  db  marr  twoearn  \
0      0.0      0.0    4500.0   47   6765.0      2     8   0     0        0
1   6215.0   1015.0   22390.0   36  28452.0      1    16   0     0        0
2      0.0  -2000.0   -2000.0   37   3300.0      6    12   1     0        0
3  15000.0  15000.0  155000.0   58  52590.0      2    16   0     1        1
4      0.0      0.0   58000.0   32  21804.0      1    11   0     0        0

   e401  p401  pira  hown
0     0     0     0     1
1     0     0     0     1
2     0     0     0     0
3     0     0     0     1
4     0     0     0     1
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">describe</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
               nifa       net_tfa            tw          age            inc  \
count  9.915000e+03  9.915000e+03  9.915000e+03  9915.000000    9915.000000
mean   1.392864e+04  1.805153e+04  6.381685e+04    41.060212   37200.623197
std    5.490488e+04  6.352250e+04  1.115297e+05    10.344505   24774.288006
min    0.000000e+00 -5.023020e+05 -5.023020e+05    25.000000   -2652.000000
25%    2.000000e+02 -5.000000e+02  3.291500e+03    32.000000   19413.000000
50%    1.635000e+03  1.499000e+03  2.510000e+04    40.000000   31476.000000
75%    8.765500e+03  1.652450e+04  8.148750e+04    48.000000   48583.500000
max    1.430298e+06  1.536798e+06  2.029910e+06    64.000000  242124.000000

             fsize         educ           db         marr      twoearn  \
count  9915.000000  9915.000000  9915.000000  9915.000000  9915.000000
mean      2.865860    13.206253     0.271004     0.604841     0.380837
std       1.538937     2.810382     0.444500     0.488909     0.485617
min       1.000000     1.000000     0.000000     0.000000     0.000000
25%       2.000000    12.000000     0.000000     0.000000     0.000000
50%       3.000000    12.000000     0.000000     1.000000     0.000000
75%       4.000000    16.000000     1.000000     1.000000     1.000000
max      13.000000    18.000000     1.000000     1.000000     1.000000

              e401         p401         pira         hown
count  9915.000000  9915.000000  9915.000000  9915.000000
mean      0.371357     0.261624     0.242158     0.635199
std       0.483192     0.439541     0.428411     0.481399
min       0.000000     0.000000     0.000000     0.000000
25%       0.000000     0.000000     0.000000     0.000000
50%       0.000000     0.000000     0.000000     1.000000
75%       1.000000     1.000000     0.000000     1.000000
max       1.000000     1.000000     1.000000     1.000000
</pre></div></div>
</div>
<p>The data consist of 9,915 observations at the household level drawn from the 1991 Survey of Income and Program Participation (SIPP). All the variables are referred to 1990. We use net financial assets (<em>net_tfa</em>) as the outcome variable, <span class="math notranslate nohighlight">\(Y\)</span>, in our analysis. The net financial assets are computed as the sum of IRA balances, 401(k) balances, checking accounts, saving bonds, other interest-earning accounts, other interest-earning assets, stocks, and mutual funds less non mortgage debts.</p>
<p>Among the <span class="math notranslate nohighlight">\(9915\)</span> individuals, <span class="math notranslate nohighlight">\(3682\)</span> are eligible to participate in the program. The variable <em>e401</em> indicates eligibility and <em>p401</em> indicates participation, respectively.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;e401&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Eligibility, 401(k)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;e401&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_12_0.png" src="../_images/examples_py_double_ml_pension_12_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;p401&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Participation, 401(k)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;p401&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_13_0.png" src="../_images/examples_py_double_ml_pension_13_0.png" />
</div>
</div>
<p>Eligibility is highly associated with financial wealth:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">displot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s2">&quot;net_tfa&quot;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s2">&quot;e401&quot;</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="s2">&quot;e401&quot;</span><span class="p">,</span>
                <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;kde&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_15_0.png" src="../_images/examples_py_double_ml_pension_15_0.png" />
</div>
</div>
<p>As a first estimate, we calculate the unconditional average predictive effect (APE) of 401(k) eligibility on accumulated assets. This effect corresponds to the average treatment effect if 401(k) eligibility would be assigned to individuals in an entirely randomized way. The unconditional APE of e401 is about <span class="math notranslate nohighlight">\(19559\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="s1">&#39;net_tfa&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;e401&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
          net_tfa
e401
0             NaN
1     19559.34475
</pre></div></div>
</div>
<p>Among the <span class="math notranslate nohighlight">\(3682\)</span> individuals that are eligible, <span class="math notranslate nohighlight">\(2594\)</span> decided to participate in the program. The unconditional APE of p401 is about <span class="math notranslate nohighlight">\(27372\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="s1">&#39;net_tfa&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;p401&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
           net_tfa
p401
0              NaN
1     27371.583404
</pre></div></div>
</div>
<p>As discussed, these estimates are biased since they do not account for saver heterogeneity and endogeneity of participation.</p>
</section>
<section id="The-DoubleML-package">
<h2>The <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code> package<a class="headerlink" href="#The-DoubleML-package" title="Permalink to this heading">#</a></h2>
<p>Let’s use the package <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> to estimate the average treatment effect of 401(k) eligibility, i.e. <code class="docutils literal notranslate"><span class="pre">e401</span></code>, and participation, i.e. <code class="docutils literal notranslate"><span class="pre">p401</span></code>, on net financial assets <code class="docutils literal notranslate"><span class="pre">net_tfa</span></code>.</p>
</section>
<section id="Estimating-the-Average-Treatment-Effect-of-401(k)-Eligibility-on-Net-Financial-Assets">
<h2>Estimating the Average Treatment Effect of 401(k) Eligibility on Net Financial Assets<a class="headerlink" href="#Estimating-the-Average-Treatment-Effect-of-401(k)-Eligibility-on-Net-Financial-Assets" title="Permalink to this heading">#</a></h2>
<p>We first look at the treatment effect of <code class="docutils literal notranslate"><span class="pre">e401</span></code> on net total financial assets. We give estimates of the ATE in the linear model</p>
<div class="math notranslate nohighlight">
\[\begin{equation*}
Y = D \alpha + f(X)'\beta+ \epsilon,
\end{equation*}\]</div>
<p>where <span class="math notranslate nohighlight">\(f(X)\)</span> is a dictonary applied to the raw regressors. <span class="math notranslate nohighlight">\(X\)</span> contains variables on marital status, two-earner status, defined benefit pension status, IRA participation, home ownership, family size, education, age, and income.</p>
<p>In the following, we will consider two different models,</p>
<ul class="simple">
<li><p>a basic model specification that includes the raw regressors, i.e., <span class="math notranslate nohighlight">\(f(X) = X\)</span>, and</p></li>
<li><p>a flexible model specification, where <span class="math notranslate nohighlight">\(f(X)\)</span> includes the raw regressors <span class="math notranslate nohighlight">\(X\)</span> and the orthogonal polynomials of degree 2 for the variables family size education, age, and income.</p></li>
</ul>
<p>We will use the basic model specification whenever we use nonlinear methods, for example regression trees or random forests, and use the flexible model for linear methods such as the lasso. There are, of course, multiple ways how the model can be specified even more flexibly, for example including interactions of variable and higher order interaction. However, for the sake of simplicity we stick to the specification above. Users who are interested in varying the model can adapt the code below
accordingly, for example to implement the orignal specification in <a class="reference external" href="https://arxiv.org/abs/1608.00060">Chernozhukov et al. (2018)</a>.</p>
<p>In the first step, we report estimates of the average treatment effect (ATE) of 401(k) eligibility on net financial assets both in the partially linear regression (PLR) model and in the interactive regression model (IRM) allowing for heterogeneous treatment effects.</p>
<section id="The-Data-Backend:-DoubleMLData">
<h3>The Data Backend: <code class="docutils literal notranslate"><span class="pre">DoubleMLData</span></code><a class="headerlink" href="#The-Data-Backend:-DoubleMLData" title="Permalink to this heading">#</a></h3>
<p>To start our analysis, we initialize the data backend, i.e., a new instance of a <a class="reference external" href="https://docs.doubleml.org/dev/api/generated/doubleml.DoubleMLData.html#doubleml.DoubleMLData">DoubleMLData</a> object. We implement the regression model by using scikit-learn’s <code class="docutils literal notranslate"><span class="pre">PolynomialFeatures</span></code> class.</p>
<p>To implement both models (basic and flexible), we generate two data backends: <code class="docutils literal notranslate"><span class="pre">data_dml_base</span></code> and <code class="docutils literal notranslate"><span class="pre">data_dml_flex</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up basic model: Specify variables for data-backend</span>
<span class="n">features_base</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">,</span> <span class="s1">&#39;inc&#39;</span><span class="p">,</span> <span class="s1">&#39;educ&#39;</span><span class="p">,</span> <span class="s1">&#39;fsize&#39;</span><span class="p">,</span> <span class="s1">&#39;marr&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;twoearn&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;pira&#39;</span><span class="p">,</span> <span class="s1">&#39;hown&#39;</span><span class="p">]</span>

<span class="c1"># Initialize DoubleMLData (data-backend of DoubleML)</span>
<span class="n">data_dml_base</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                 <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span>
                                 <span class="n">d_cols</span><span class="o">=</span><span class="s1">&#39;e401&#39;</span><span class="p">,</span>
                                 <span class="n">x_cols</span><span class="o">=</span><span class="n">features_base</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLData Object ==================

------------------ Data summary      ------------------
Outcome variable: net_tfa
Treatment variable(s): [&#39;e401&#39;]
Covariates: [&#39;age&#39;, &#39;inc&#39;, &#39;educ&#39;, &#39;fsize&#39;, &#39;marr&#39;, &#39;twoearn&#39;, &#39;db&#39;, &#39;pira&#39;, &#39;hown&#39;]
Instrument variable(s): None
No. Observations: 9915

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 9915 entries, 0 to 9914
Columns: 14 entries, nifa to hown
dtypes: float64(4), int8(10)
memory usage: 406.8 KB

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set up a model according to regression formula with polynomials</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;marr&#39;</span><span class="p">,</span> <span class="s1">&#39;twoearn&#39;</span><span class="p">,</span> <span class="s1">&#39;db&#39;</span><span class="p">,</span> <span class="s1">&#39;pira&#39;</span><span class="p">,</span> <span class="s1">&#39;hown&#39;</span><span class="p">]]</span>

<span class="n">poly_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;age&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
             <span class="s1">&#39;inc&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
             <span class="s1">&#39;educ&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
             <span class="s1">&#39;fsize&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">}</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">poly_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">data</span><span class="p">[[</span><span class="n">key</span><span class="p">]])</span>
    <span class="n">x_cols</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">([</span><span class="n">key</span><span class="p">])</span>
    <span class="n">data_transf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_transf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x_cols</span><span class="p">)</span>

    <span class="n">features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">features</span><span class="p">,</span> <span class="n">data_transf</span><span class="p">),</span>
                          <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">]],</span> <span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># Initialize DoubleMLData (data-backend of DoubleML)</span>
<span class="n">data_dml_flex</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> <span class="n">d_cols</span><span class="o">=</span><span class="s1">&#39;e401&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">data_dml_flex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLData Object ==================

------------------ Data summary      ------------------
Outcome variable: net_tfa
Treatment variable(s): [&#39;e401&#39;]
Covariates: [&#39;marr&#39;, &#39;twoearn&#39;, &#39;db&#39;, &#39;pira&#39;, &#39;hown&#39;, &#39;age&#39;, &#39;age^2&#39;, &#39;inc&#39;, &#39;inc^2&#39;, &#39;educ&#39;, &#39;educ^2&#39;, &#39;fsize&#39;, &#39;fsize^2&#39;]
Instrument variable(s): None
No. Observations: 9915

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 9915 entries, 0 to 9914
Columns: 15 entries, net_tfa to fsize^2
dtypes: float64(9), int8(6)
memory usage: 755.4 KB

</pre></div></div>
</div>
</section>
<section id="Partially-Linear-Regression-Model-(PLR)">
<h3>Partially Linear Regression Model (PLR)<a class="headerlink" href="#Partially-Linear-Regression-Model-(PLR)" title="Permalink to this heading">#</a></h3>
<p>We start using lasso to estimate the function <span class="math notranslate nohighlight">\(g_0\)</span> and <span class="math notranslate nohighlight">\(m_0\)</span> in the following PLR model:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
&amp; Y = D\theta_0 + g_0(X) + \zeta, &amp;\quad E[\zeta \mid D,X]= 0,\\
&amp; D = m_0(X) +  V, &amp;\quad E[V \mid X] = 0.
\end{aligned}\end{split}\]</div>
<p>To estimate the causal parameter <span class="math notranslate nohighlight">\(\theta_0\)</span> here, we use double machine learning with 3-fold cross-fitting.</p>
<p>Estimation of the nuisance components <span class="math notranslate nohighlight">\(g_0\)</span> and <span class="math notranslate nohighlight">\(m_0\)</span>, is based on the lasso with cross-validated choice of the penalty term , <span class="math notranslate nohighlight">\(\lambda\)</span>, as provided by <a class="reference external" href="https://scikit-learn.org">scikit-learn</a>. We load the learner by initializing instances from the classes <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LassoCV.html">LassoCV</a> and
<a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.linear_model.LogisticRegressionCV.html">LogisticRegressionCV</a>. Hyperparameters and options can be set during instantiation of the learner. Here we specify that the lasso should use that value of <span class="math notranslate nohighlight">\(\lambda\)</span> that minimizes the cross-validated mean squared error which is based on 5-fold cross validation.</p>
<p>We start by estimation the ATE in the basic model and then repeat the estimation in the flexible model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize learners</span>
<span class="n">Cs</span> <span class="o">=</span> <span class="mf">0.0001</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">10000</span><span class="p">))</span>
<span class="n">lasso_class</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span>
                            <span class="n">LogisticRegressionCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l1&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;liblinear&#39;</span><span class="p">,</span>
                                                 <span class="n">Cs</span> <span class="o">=</span> <span class="n">Cs</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">))</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="c1"># Initialize DoubleMLPLR model</span>
<span class="n">dml_plr_lasso</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                                <span class="n">ml_l</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                                <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_plr_lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_plr_lasso</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t     P&gt;|t|        2.5 %       97.5 %
e401  5722.474846  1380.619177  4.144861  0.000034  3016.510982  8428.438709
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate the ATE in the flexible model with lasso</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_plr_lasso</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_dml_flex</span><span class="p">,</span>
                                <span class="n">ml_l</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                                <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="n">dml_plr_lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lasso_summary</span> <span class="o">=</span> <span class="n">dml_plr_lasso</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lasso_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            coef      std err         t         P&gt;|t|        2.5 %  \
e401  8974.79122  1324.323622  6.776887  1.227931e-11  6379.164617

            97.5 %
e401  11570.417822
</pre></div></div>
</div>
<p>Alternatively, we can repeat this procedure with other machine learning methods, for example a random forest learner as provided by the <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestRegressor.html">RandomForestRegressor</a> and <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.RandomForestClassifier.html">RandomForestClassifier</a> class in <a class="reference external" href="https://scikit-learn.org">scikit-learn</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random Forest</span>
<span class="n">randomForest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">randomForest_class</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span>
    <span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_features</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_plr_forest</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                                 <span class="n">ml_l</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                                 <span class="n">ml_m</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                 <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_plr_forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">forest_summary</span> <span class="o">=</span> <span class="n">dml_plr_forest</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">forest_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8909.634078  1321.822289  6.740417  1.579322e-11  6318.909997

            97.5 %
e401  11500.358158
</pre></div></div>
</div>
<p>Now, let’s use a regression tree as provided in <a class="reference external" href="https://scikit-learn.org">scikit-learn</a>’s <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeRegressor.html">DecisionTreeRegressor</a> and <a class="reference external" href="https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html">DecisionTreeClassifier</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trees</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ccp_alpha</span><span class="o">=</span><span class="mf">0.0047</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">203</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">67</span><span class="p">)</span>
<span class="n">trees_class</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span>
    <span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">ccp_alpha</span><span class="o">=</span><span class="mf">0.0042</span><span class="p">,</span> <span class="n">min_samples_split</span><span class="o">=</span><span class="mi">104</span><span class="p">,</span> <span class="n">min_samples_leaf</span><span class="o">=</span><span class="mi">34</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_plr_tree</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                               <span class="n">ml_l</span> <span class="o">=</span> <span class="n">trees</span><span class="p">,</span>
                               <span class="n">ml_m</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                               <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_plr_tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tree_summary</span> <span class="o">=</span> <span class="n">dml_plr_tree</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            coef      std err         t         P&gt;|t|        2.5 %  \
e401  8260.06428  1348.624798  6.124805  9.079458e-10  5616.808246

            97.5 %
e401  10903.320314
</pre></div></div>
</div>
<p>We can also experiment with extreme gradient boosting as provided by <a class="reference external" href="https://xgboost.readthedocs.io/en/latest/">xgboost</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boosted Trees</span>
<span class="n">boost</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;reg:squarederror&quot;</span><span class="p">,</span>
                     <span class="n">eta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">35</span><span class="p">)</span>
<span class="n">boost_class</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s2">&quot;logloss&quot;</span><span class="p">,</span>
                            <span class="n">eta</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">34</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_plr_boost</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLPLR</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                                <span class="n">ml_l</span> <span class="o">=</span> <span class="n">boost</span><span class="p">,</span>
                                <span class="n">ml_m</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_plr_boost</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">boost_summary</span> <span class="o">=</span> <span class="n">dml_plr_boost</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">boost_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef    std err         t         P&gt;|t|       2.5 %        97.5 %
e401  8688.511293  1390.8893  6.246731  4.191320e-10  5962.41836  11414.604227
</pre></div></div>
</div>
<p>Let’s sum up the results:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plr_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">lasso_summary</span><span class="p">,</span> <span class="n">forest_summary</span><span class="p">,</span> <span class="n">tree_summary</span><span class="p">,</span> <span class="n">boost_summary</span><span class="p">))</span>
<span class="n">plr_summary</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lasso&#39;</span><span class="p">,</span> <span class="s1">&#39;forest&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">plr_summary</span><span class="p">[[</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 %&#39;</span><span class="p">,</span> <span class="s1">&#39;97.5 %&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                coef        2.5 %        97.5 %
lasso    8974.791220  6379.164617  11570.417822
forest   8909.634078  6318.909997  11500.358158
tree     8260.064280  5616.808246  10903.320314
xgboost  8688.511293  5962.418360  11414.604227
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">plr_summary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">plr_summary</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">plr_summary</span><span class="p">[</span><span class="s1">&#39;2.5 %&#39;</span><span class="p">]</span>
<span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">plr_summary</span><span class="p">[</span><span class="s1">&#39;97.5 %&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">plr_summary</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">plr_summary</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">plr_summary</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12500</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Partially Linear Regression Model (PLR)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ML method&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span>  <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coefficients and 95%-CI&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_45_0.png" src="../_images/examples_py_double_ml_pension_45_0.png" />
</div>
</div>
</section>
<section id="Interactive-Regression-Model-(IRM)">
<h3>Interactive Regression Model (IRM)<a class="headerlink" href="#Interactive-Regression-Model-(IRM)" title="Permalink to this heading">#</a></h3>
<p>Next, we consider estimation of average treatment effects when treatment effects are fully heterogeneous:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
&amp; Y = g_0(D,X) + U, &amp;\quad E[U\mid X,D] = 0,\\
&amp; D = m_0(X) + V, &amp;\quad E[V\mid X] = 0.
\end{aligned}\end{split}\]</div>
<p>To reduce the disproportionate impact of extreme propensity score weights in the interactive model we trim the propensity scores which are close to the bounds.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lasso</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">))</span>

<span class="c1"># Initialize DoubleMLIRM model</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm_lasso</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_dml_flex</span><span class="p">,</span>
                          <span class="n">ml_g</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                          <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                          <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                          <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_irm_lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lasso_summary</span> <span class="o">=</span> <span class="n">dml_irm_lasso</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lasso_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            coef      std err         t         P&gt;|t|        2.5 %  \
e401  7918.27028  1206.438355  6.563344  5.261418e-11  5553.694555

            97.5 %
e401  10282.846006
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random Forest</span>
<span class="n">randomForest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">randomForest_class</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm_forest</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                                 <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                                 <span class="n">ml_m</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                 <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                 <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Set nuisance-part specific parameters</span>
<span class="n">dml_irm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>
<span class="n">dml_irm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="n">dml_irm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_m&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>

<span class="n">dml_irm_forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">forest_summary</span> <span class="o">=</span> <span class="n">dml_irm_forest</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">forest_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8020.190199  1140.240133  7.033773  2.010222e-12  5785.360605

            97.5 %
e401  10255.019793
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trees</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">trees_class</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm_tree</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                               <span class="n">ml_g</span> <span class="o">=</span> <span class="n">trees</span><span class="p">,</span>
                               <span class="n">ml_m</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                               <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                               <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Set nuisance-part specific parameters</span>
<span class="n">dml_irm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0016</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
<span class="n">dml_irm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0018</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">})</span>
<span class="n">dml_irm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_m&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0028</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">167</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">})</span>

<span class="n">dml_irm_tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tree_summary</span> <span class="o">=</span> <span class="n">dml_irm_tree</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8054.077008  1184.437455  6.799918  1.046791e-11  5732.622255

            97.5 %
e401  10375.531761
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boosted Trees</span>
<span class="n">boost</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;reg:squarederror&quot;</span><span class="p">)</span>
<span class="n">boost_class</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s2">&quot;logloss&quot;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_irm_boost</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIRM</span><span class="p">(</span><span class="n">data_dml_base</span><span class="p">,</span>
                                <span class="n">ml_g</span> <span class="o">=</span> <span class="n">boost</span><span class="p">,</span>
                                <span class="n">ml_m</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Set nuisance-part specific parameters</span>
<span class="n">dml_irm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">})</span>
<span class="n">dml_irm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">29</span><span class="p">})</span>
<span class="n">dml_irm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_m&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">})</span>

<span class="n">dml_irm_boost</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">boost_summary</span> <span class="o">=</span> <span class="n">dml_irm_boost</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">boost_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t         P&gt;|t|        2.5 %  \
e401  8092.091951  1191.839718  6.789581  1.124599e-11  5756.129029

            97.5 %
e401  10428.054873
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">irm_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">lasso_summary</span><span class="p">,</span> <span class="n">forest_summary</span><span class="p">,</span> <span class="n">tree_summary</span><span class="p">,</span> <span class="n">boost_summary</span><span class="p">))</span>
<span class="n">irm_summary</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lasso&#39;</span><span class="p">,</span> <span class="s1">&#39;forest&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">irm_summary</span><span class="p">[[</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 %&#39;</span><span class="p">,</span> <span class="s1">&#39;97.5 %&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                coef        2.5 %        97.5 %
lasso    7918.270280  5553.694555  10282.846006
forest   8020.190199  5785.360605  10255.019793
tree     8054.077008  5732.622255  10375.531761
xgboost  8092.091951  5756.129029  10428.054873
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">irm_summary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">irm_summary</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">irm_summary</span><span class="p">[</span><span class="s1">&#39;2.5 %&#39;</span><span class="p">]</span>
<span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">irm_summary</span><span class="p">[</span><span class="s1">&#39;97.5 %&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">irm_summary</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">irm_summary</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">irm_summary</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12500</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Interactive Regression Model (IRM)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ML method&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coefficients and 95%-CI&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_55_0.png" src="../_images/examples_py_double_ml_pension_55_0.png" />
</div>
</div>
<p>These estimates that flexibly account for confounding are substantially attenuated relative to the baseline estimate (<em>19559</em>) that does not account for confounding. They suggest much smaller causal effects of 401(k) eligiblity on financial asset holdings.</p>
</section>
</section>
<section id="Local-Average-Treatment-Effects-of-401(k)-Participation-on-Net-Financial-Assets">
<h2>Local Average Treatment Effects of 401(k) Participation on Net Financial Assets<a class="headerlink" href="#Local-Average-Treatment-Effects-of-401(k)-Participation-on-Net-Financial-Assets" title="Permalink to this heading">#</a></h2>
<section id="Interactive-IV-Model-(IIVM)">
<h3>Interactive IV Model (IIVM)<a class="headerlink" href="#Interactive-IV-Model-(IIVM)" title="Permalink to this heading">#</a></h3>
<p>In the examples above, we estimated the average treatment effect of <em>eligibility</em> on financial asset holdings. Now, we consider estimation of local average treatment effects (LATE) of <em>participation</em> using eligibility as an instrument for the participation decision. Under appropriate assumptions, the LATE identifies the treatment effect for so-called compliers, i.e., individuals who would only participate if eligible and otherwise not participate in the program.</p>
<p>As before, <span class="math notranslate nohighlight">\(Y\)</span> denotes the outcome <code class="docutils literal notranslate"><span class="pre">net_tfa</span></code>, and <span class="math notranslate nohighlight">\(X\)</span> is the vector of covariates. We use <code class="docutils literal notranslate"><span class="pre">e401</span></code> as a binary instrument for the treatment variable <code class="docutils literal notranslate"><span class="pre">p401</span></code>. Here the structural equation model is:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
&amp; Y = g_0(Z,X) + U, &amp;\quad E[U\mid Z,X] = 0,\\
&amp; D = r_0(Z,X) + V, &amp;\quad E[V\mid Z, X] = 0,\\
&amp; Z = m_0(X) + \zeta, &amp;\quad E[\zeta \mid X] = 0.
\end{aligned}\end{split}\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize DoubleMLData with an instrument</span>

<span class="c1"># Basic model</span>
<span class="n">data_dml_base_iv</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span>
                                    <span class="n">d_cols</span><span class="o">=</span><span class="s1">&#39;p401&#39;</span><span class="p">,</span>
                                    <span class="n">z_cols</span><span class="o">=</span><span class="s1">&#39;e401&#39;</span><span class="p">,</span>
                                    <span class="n">x_cols</span><span class="o">=</span><span class="n">features_base</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data_dml_base_iv</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLData Object ==================

------------------ Data summary      ------------------
Outcome variable: net_tfa
Treatment variable(s): [&#39;p401&#39;]
Covariates: [&#39;age&#39;, &#39;inc&#39;, &#39;educ&#39;, &#39;fsize&#39;, &#39;marr&#39;, &#39;twoearn&#39;, &#39;db&#39;, &#39;pira&#39;, &#39;hown&#39;]
Instrument variable(s): [&#39;e401&#39;]
No. Observations: 9915

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 9915 entries, 0 to 9914
Columns: 14 entries, nifa to hown
dtypes: float64(4), int8(10)
memory usage: 406.8 KB

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Flexible model</span>
<span class="n">model_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()[[</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span> <span class="s1">&#39;e401&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">]],</span> <span class="n">features</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span>
                        <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">data_dml_iv_flex</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">model_data</span><span class="p">,</span>
                                    <span class="n">y_col</span><span class="o">=</span><span class="s1">&#39;net_tfa&#39;</span><span class="p">,</span>
                                    <span class="n">d_cols</span><span class="o">=</span><span class="s1">&#39;p401&#39;</span><span class="p">,</span>
                                    <span class="n">z_cols</span><span class="o">=</span><span class="s1">&#39;e401&#39;</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">data_dml_iv_flex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLData Object ==================

------------------ Data summary      ------------------
Outcome variable: net_tfa
Treatment variable(s): [&#39;p401&#39;]
Covariates: [&#39;marr&#39;, &#39;twoearn&#39;, &#39;db&#39;, &#39;pira&#39;, &#39;hown&#39;, &#39;age&#39;, &#39;age^2&#39;, &#39;inc&#39;, &#39;inc^2&#39;, &#39;educ&#39;, &#39;educ^2&#39;, &#39;fsize&#39;, &#39;fsize^2&#39;]
Instrument variable(s): [&#39;e401&#39;]
No. Observations: 9915

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 9915 entries, 0 to 9914
Columns: 16 entries, net_tfa to fsize^2
dtypes: float64(9), int8(7)
memory usage: 765.1 KB

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Lasso</span>
<span class="n">lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">20000</span><span class="p">))</span>

<span class="c1"># Initialize DoubleMLIRM model</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_iivm_lasso</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_dml_iv_flex</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">lasso</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">lasso_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                             <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">dml_iivm_lasso</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lasso_summary</span> <span class="o">=</span> <span class="n">dml_iivm_lasso</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">lasso_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t         P&gt;|t|       2.5 %  \
p401  11489.25238  1747.417737  6.574989  4.865677e-11  8064.37655

           97.5 %
p401  14914.12821
</pre></div></div>
</div>
<p>Again, we repeat the procedure for the other machine learning methods:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Random Forest</span>
<span class="n">randomForest</span> <span class="o">=</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
<span class="n">randomForest_class</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_iivm_forest</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_dml_base_iv</span><span class="p">,</span>
                                   <span class="n">ml_g</span> <span class="o">=</span> <span class="n">randomForest</span><span class="p">,</span>
                                   <span class="n">ml_m</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                   <span class="n">ml_r</span> <span class="o">=</span> <span class="n">randomForest_class</span><span class="p">,</span>
                                   <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                                <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                   <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                   <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Set nuisance-part specific parameters</span>
<span class="n">dml_iivm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">})</span>
<span class="n">dml_iivm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
<span class="n">dml_iivm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_m&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>
<span class="n">dml_iivm_forest</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;max_features&#39;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span>

<span class="n">dml_iivm_forest</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">forest_summary</span> <span class="o">=</span> <span class="n">dml_iivm_forest</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">forest_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
             coef      std err         t         P&gt;|t|        2.5 %  \
p401  11550.03435  1638.022642  7.051206  1.773742e-12  8339.568966

            97.5 %
p401  14760.499734
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Trees</span>
<span class="n">trees</span> <span class="o">=</span> <span class="n">DecisionTreeRegressor</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
<span class="n">trees_class</span> <span class="o">=</span> <span class="n">DecisionTreeClassifier</span><span class="p">(</span><span class="n">max_depth</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_iivm_tree</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_dml_base_iv</span><span class="p">,</span>
                                 <span class="n">ml_g</span> <span class="o">=</span> <span class="n">trees</span><span class="p">,</span>
                                 <span class="n">ml_m</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                                 <span class="n">ml_r</span> <span class="o">=</span> <span class="n">trees_class</span><span class="p">,</span>
                                 <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                              <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                 <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                 <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Set nuisance-part specific parameters</span>
<span class="n">dml_iivm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0016</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">74</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">24</span><span class="p">})</span>
<span class="n">dml_iivm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0018</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">70</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">23</span><span class="p">})</span>
<span class="n">dml_iivm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_m&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0028</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">167</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">})</span>
<span class="n">dml_iivm_tree</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;ccp_alpha&#39;</span><span class="p">:</span> <span class="mf">0.0576</span><span class="p">,</span> <span class="s1">&#39;min_samples_split&#39;</span><span class="p">:</span> <span class="mi">55</span><span class="p">,</span> <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">})</span>

<span class="n">dml_iivm_tree</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">tree_summary</span> <span class="o">=</span> <span class="n">dml_iivm_tree</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tree_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              coef      std err         t         P&gt;|t|       2.5 %  \
p401  11512.640404  1689.239802  6.815279  9.408106e-12  8201.79123

            97.5 %
p401  14823.489578
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Boosted Trees</span>
<span class="n">boost</span> <span class="o">=</span> <span class="n">XGBRegressor</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;reg:squarederror&quot;</span><span class="p">)</span>
<span class="n">boost_class</span> <span class="o">=</span> <span class="n">XGBClassifier</span><span class="p">(</span><span class="n">use_label_encoder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">objective</span> <span class="o">=</span> <span class="s2">&quot;binary:logistic&quot;</span><span class="p">,</span> <span class="n">eval_metric</span> <span class="o">=</span> <span class="s2">&quot;logloss&quot;</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">dml_iivm_boost</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLIIVM</span><span class="p">(</span><span class="n">data_dml_base_iv</span><span class="p">,</span>
                                  <span class="n">ml_g</span> <span class="o">=</span> <span class="n">boost</span><span class="p">,</span>
                                  <span class="n">ml_m</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                  <span class="n">ml_r</span> <span class="o">=</span> <span class="n">boost_class</span><span class="p">,</span>
                                  <span class="n">subgroups</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;always_takers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="s1">&#39;never_takers&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                                  <span class="n">trimming_threshold</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                                  <span class="n">n_folds</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># Set nuisance-part specific parameters</span>
<span class="n">dml_iivm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">9</span><span class="p">})</span>
<span class="n">dml_iivm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">33</span><span class="p">})</span>
<span class="n">dml_iivm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_m&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
<span class="n">dml_iivm_boost</span><span class="o">.</span><span class="n">set_ml_nuisance_params</span><span class="p">(</span><span class="s1">&#39;ml_r1&#39;</span><span class="p">,</span> <span class="s1">&#39;p401&#39;</span><span class="p">,</span> <span class="p">{</span>
    <span class="s1">&#39;eta&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span> <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">25</span><span class="p">})</span>

<span class="n">dml_iivm_boost</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_predictions</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">boost_summary</span> <span class="o">=</span> <span class="n">dml_iivm_boost</span><span class="o">.</span><span class="n">summary</span>

<span class="nb">print</span><span class="p">(</span><span class="n">boost_summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              coef      std err         t         P&gt;|t|        2.5 %  \
p401  12305.619781  1685.922466  7.299043  2.898227e-13  9001.272467

            97.5 %
p401  15609.967095
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iivm_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">lasso_summary</span><span class="p">,</span> <span class="n">forest_summary</span><span class="p">,</span> <span class="n">tree_summary</span><span class="p">,</span> <span class="n">boost_summary</span><span class="p">))</span>
<span class="n">iivm_summary</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;lasso&#39;</span><span class="p">,</span> <span class="s1">&#39;forest&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">,</span> <span class="s1">&#39;xgboost&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">iivm_summary</span><span class="p">[[</span><span class="s1">&#39;coef&#39;</span><span class="p">,</span> <span class="s1">&#39;2.5 %&#39;</span><span class="p">,</span> <span class="s1">&#39;97.5 %&#39;</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                 coef        2.5 %        97.5 %
lasso    11489.252380  8064.376550  14914.128210
forest   11550.034350  8339.568966  14760.499734
tree     11512.640404  8201.791230  14823.489578
xgboost  12305.619781  9001.272467  15609.967095
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">iivm_summary</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">iivm_summary</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">iivm_summary</span><span class="p">[</span><span class="s1">&#39;2.5 %&#39;</span><span class="p">]</span>
<span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">iivm_summary</span><span class="p">[</span><span class="s1">&#39;97.5 %&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">iivm_summary</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">iivm_summary</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">iivm_summary</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errors</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16500</span><span class="p">])</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Interactive IV Model (IIVM)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ML method&#39;</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coefficients and 95%-CI&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_69_0.png" src="../_images/examples_py_double_ml_pension_69_0.png" />
</div>
</div>
</section>
</section>
<section id="Summary-of-Results">
<h2>Summary of Results<a class="headerlink" href="#Summary-of-Results" title="Permalink to this heading">#</a></h2>
<p>To sum up, let’s merge all our results so far and illustrate them in a plot.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">plr_summary</span><span class="p">,</span> <span class="n">irm_summary</span><span class="p">,</span> <span class="n">iivm_summary</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;ML&#39;</span><span class="p">})</span>
<span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;PLR&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;IRM&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="s1">&#39;IIVM&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_summary</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="s1">&#39;ML&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
                       coef      std err         t         P&gt;|t|        2.5 %  \
Model ML
PLR   lasso     8974.791220  1324.323622  6.776887  1.227931e-11  6379.164617
      forest    8909.634078  1321.822289  6.740417  1.579322e-11  6318.909997
      tree      8260.064280  1348.624798  6.124805  9.079458e-10  5616.808246
      xgboost   8688.511293  1390.889300  6.246731  4.191320e-10  5962.418360
IRM   lasso     7918.270280  1206.438355  6.563344  5.261418e-11  5553.694555
      forest    8020.190199  1140.240133  7.033773  2.010222e-12  5785.360605
      tree      8054.077008  1184.437455  6.799918  1.046791e-11  5732.622255
      xgboost   8092.091951  1191.839718  6.789581  1.124599e-11  5756.129029
IIVM  lasso    11489.252380  1747.417737  6.574989  4.865677e-11  8064.376550
      forest   11550.034350  1638.022642  7.051206  1.773742e-12  8339.568966
      tree     11512.640404  1689.239802  6.815279  9.408106e-12  8201.791230
      xgboost  12305.619781  1685.922466  7.299043  2.898227e-13  9001.272467

                     97.5 %
Model ML
PLR   lasso    11570.417822
      forest   11500.358158
      tree     10903.320314
      xgboost  11414.604227
IRM   lasso    10282.846006
      forest   10255.019793
      tree     10375.531761
      xgboost  10428.054873
IIVM  lasso    14914.128210
      forest   14760.499734
      tree     14823.489578
      xgboost  15609.967095
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">15</span><span class="p">))</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">()</span>
<span class="k">for</span> <span class="n">ind</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;PLR&#39;</span><span class="p">,</span> <span class="s1">&#39;IRM&#39;</span><span class="p">,</span> <span class="s1">&#39;IIVM&#39;</span><span class="p">]):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ind</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">this_df</span> <span class="o">=</span> <span class="n">df_summary</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s1">&#39;Model == @model&#39;</span><span class="p">)</span>
    <span class="n">errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="n">this_df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">errors</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">this_df</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">this_df</span><span class="p">[</span><span class="s1">&#39;2.5 %&#39;</span><span class="p">]</span>
    <span class="n">errors</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">this_df</span><span class="p">[</span><span class="s1">&#39;97.5 %&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">this_df</span><span class="p">[</span><span class="s1">&#39;coef&#39;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">this_df</span><span class="o">.</span><span class="n">ML</span><span class="p">,</span> <span class="n">this_df</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">yerr</span><span class="o">=</span><span class="n">errors</span><span class="p">,</span>
                 <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">16500</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Coefficients and 95%-CI&#39;</span><span class="p">)</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;ML method&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_pension_73_0.png" src="../_images/examples_py_double_ml_pension_73_0.png" />
</div>
</div>
<p>We report results based on four ML methods for estimating the nuisance functions used in forming the orthogonal estimating equations. We find again that the estimates of the treatment effect are stable across ML methods. The estimates are highly significant, hence we would reject the hypothesis that 401(k) participation has no effect on financial wealth.</p>
<hr class="docutils" />
<p><strong>Acknowledgement</strong></p>
<p>We would like to thank <a class="reference external" href="https://www.dice.hhu.de/en/dice/people/professors-1/kueck">Jannis Kueck</a> for sharing <a class="reference external" href="https://www.kaggle.com/janniskueck/pm5-401k">the kaggle notebook</a>. The pension data set has been analyzed in several studies, among others <a class="reference external" href="https://arxiv.org/abs/1608.00060">Chernozhukov et al. (2018)</a>.</p>
</section>
</section>


                </article>
              
              
              
                <footer class="bd-footer-article">
                  
<div class="footer-article-items footer-article__inner">
  
    <div class="footer-article-item"><!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="r_double_ml_multiway_cluster.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">R: Cluster Robust Double Machine Learning</p>
      </div>
    </a>
    <a class="right-next"
       href="py_double_ml_multiway_cluster.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Python: Cluster Robust Double Machine Learning</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div></div>
  
</div>

                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#The-DoubleML-package">The <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code> package</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Estimating-the-Average-Treatment-Effect-of-401(k)-Eligibility-on-Net-Financial-Assets">Estimating the Average Treatment Effect of 401(k) Eligibility on Net Financial Assets</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#The-Data-Backend:-DoubleMLData">The Data Backend: <code class="docutils literal notranslate"><span class="pre">DoubleMLData</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Partially-Linear-Regression-Model-(PLR)">Partially Linear Regression Model (PLR)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Interactive-Regression-Model-(IRM)">Interactive Regression Model (IRM)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Local-Average-Treatment-Effects-of-401(k)-Participation-on-Net-Financial-Assets">Local Average Treatment Effects of 401(k) Participation on Net Financial Assets</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Interactive-IV-Model-(IIVM)">Interactive IV Model (IIVM)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Summary-of-Results">Summary of Results</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">
  <div class="tocsection sourcelink">
    <a href="../_sources/examples/py_double_ml_pension.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=e353d410970836974a52"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=e353d410970836974a52"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">
  <p class="copyright">
    
      © Copyright 2023, Bach, P., Chernozhukov, V., Klaassen, S., Kurz, M. S., and Spindler, M..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">
  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
    <div class="footer-items__end">
      
        <div class="footer-item"><p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.13.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>