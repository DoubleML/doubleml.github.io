
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Python: Cluster Robust Double Machine Learning &#8212; DoubleML  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=c49bcd98" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=1ecd1175"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/py_double_ml_multiway_cluster';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.doubleml.org/dev/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python: Sample Selection Models" href="py_double_ml_ssm.html" />
    <link rel="prev" title="Python: First Stage and Causal Estimation" href="py_double_ml_firststage.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">Interested to learn more? We offer <a href='https://trainings.doubleml.org/'>DoubleML Trainings!</a></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/logo_dark.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">DoubleML</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/install.html">
     Install
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/intro.html">
     Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../workflow/workflow.html">
     Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../guide/guide.html">
     User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
     Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/api.html">
     Python API
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://docs.doubleml.org/r/stable/">
     R API
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://docs.doubleml.org/doubleml-coverage/">
     Coverage Repository
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../literature/literature.html">
     Literature
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../release/release.html">
     Release notes
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/DoubleML/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py/discussions" title="Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discussions</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/install.html">
     Install
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/intro.html">
     Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../workflow/workflow.html">
     Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../guide/guide.html">
     User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
     Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/api.html">
     Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://docs.doubleml.org/r/stable/">
     R API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://docs.doubleml.org/doubleml-coverage/">
     Coverage Repository
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../literature/literature.html">
     Literature
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release/release.html">
     Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/DoubleML/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py/discussions" title="Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discussions</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><p class="logo" style="text-align:center;"><a href="../index.html">
    <img class="logo" src="../logo.png" alt="Logo" width="65%" height="65%">
</a></p>

<script type="text/javascript">
    // Change the logo depending on the theme
    var logo = document.querySelector('img.logo');
    var observer = new MutationObserver(function(mutations) {
        const dark = document.documentElement.dataset.theme == 'dark';
        if (dark) {
            logo.src = "../logo_dark.png";
        } else {
            logo.src = "../logo.png";
        }
    });
    observer.observe(document.documentElement, {attributes: true, attributeFilter: ['data-theme']});
</script></div>
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_basics.html">Python: Basics of Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pension.html">Python: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_sensitivity.html">Python: Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_apo.html">Python: Average Potential Outcome (APO) Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_irm_vs_apo.html">Python: IRM and APO Model Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_learner.html">Python: Choice of learners</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_firststage.html">Python: First Stage and Causal Estimation</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Python: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_ssm.html">Python: Sample Selection Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_sensitivity_booking.html">Example: Sensitivity Analysis for Causal ML</a></li>




<li class="toctree-l1"><a class="reference internal" href="learners/py_tabpfn.html">Python: Causal Machine Learning with TabPFN</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_basic_iv.html">Python: Basic Instrumental Variables calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_robust_iv.html">Python: Confidence Intervals for Instrumental Variables Models That Are Robust to Weak Instruments</a></li>


<li class="toctree-l1"><a class="reference internal" href="py_double_ml_plm_irm_hetfx.html">Python: PLM and IRM for Multiple Treatments</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_meets_flaml.html">DoubleML meets FLAML - How to tune learners automatically within <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_rdflex.html">Flexible Covariate Adjustment in Regression Discontinuity Designs (RDD)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate.html">Python: Group Average Treatment Effects (GATEs) for IRM models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate_plr.html">Python: Group Average Treatment Effects (GATEs) for PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cate.html">Python: Conditional Average Treatment Effects (CATEs) for IRM models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cate_plr.html">Python: Conditional Average Treatment Effects (CATEs) for PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate_sensitivity.html">Python: GATE Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_policy_tree.html">Python: Policy Learning with Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pension_qte.html">Python: Impact of 401(k) on Financial Wealth (Quantile Effects)</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pq.html">Python: Potential Quantiles and Quantile Treatment Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cvar.html">Python: Conditional Value at Risk of potential outcomes</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="did/py_panel_simple.html">Python: Panel Data Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_panel.html">Python: Panel Data with Multiple Time Periods</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_panel_data_example.html">Python: Real-Data Example for Multi-Period Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_rep_cs.html">Python: Repeated Cross-Sectional Data with Multiple Time Periods</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_basics.html">R: Basics of Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_pension.html">R: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_did.html">R: DoubleML for Difference-in-Differences</a></li>

<li class="toctree-l1"><a class="reference internal" href="R_double_ml_multiway_cluster.html">R: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_ssm.html">R: Sample Selection Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_basic_iv.html">R: Basic Instrumental Variables Calculation</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_pipeline.html">R: Ensemble Learners and More with <code class="docutils literal notranslate"><span class="pre">mlr3pipelines</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="double_ml_bonus_data.html">DML: Bonus Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_did.html">Python: Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_did_pretest.html">Python: Difference-in-Differences Pre-Testing</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Python:...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
      <div class="admonition note">
    <p class="admonition-title">Note</p>
    <ul class="simple">

Download Jupyter notebook:
<a class="reference external" href="https://docs.doubleml.org/stable/examples/py_double_ml_multiway_cluster.ipynb">https://docs.doubleml.org/stable/examples/py_double_ml_multiway_cluster.ipynb</a>.

    </ul>
    </div><section id="Python:-Cluster-Robust-Double-Machine-Learning">
<h1>Python: Cluster Robust Double Machine Learning<a class="headerlink" href="#Python:-Cluster-Robust-Double-Machine-Learning" title="Link to this heading">#</a></h1>
<section id="Motivation">
<h2>Motivation<a class="headerlink" href="#Motivation" title="Link to this heading">#</a></h2>
<p>In many empirical applications, errors exhibit a clustered structure such that the usual i.i.d. assumption does not hold anymore. In order to perform valid statistical inference, researchers have to account for clustering. In this notebook, we will shortly emphasize the consequences of clustered data on inference based on the double machine learning (DML) approach as has been considered in <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a>. We will demonstrate how users of
the <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> package can account for one- and two-way clustering in their analysis.</p>
<p>Clustered errors in terms of one or multiple dimensions might arise in many empirical applications. For example, in a cross-sectional study, errors might be correlated (i) within regions (one-way clustering) or (ii) within regions and industries at the same time (two-way clustering). Another example for two-way clustering, discussed in <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a>, refers to market share data with market shares being subject to shocks on the market and
product level at the same time. We refer to <a class="reference external" href="https://doi.org/10.1198/jbes.2010.07136">Cameron et al. (2011)</a> for an introduction to multiway clustering and a illustrative list of empirical examples.</p>
</section>
<section id="Clustering-and-double-machine-learning">
<h2>Clustering and double machine learning<a class="headerlink" href="#Clustering-and-double-machine-learning" title="Link to this heading">#</a></h2>
<p>Clustering creates a challenge to the double machine learning (DML) approach in terms of</p>
<ol class="arabic simple">
<li><p>a necessary adjustment of the formulae used for estimation of the variance covariance matrix, standard errors, p-values etc., and,</p></li>
<li><p>an adjusted resampling scheme for the cross-fitting algorithm.</p></li>
</ol>
<p>The first point equally applies to classical statistical models, for example a linear regression model (see, for example <a class="reference external" href="https://doi.org/10.1198/jbes.2010.07136">Cameron et al. 2011</a>). The second point arises because the clustering implies a correlation of errors from train and test samples if the standard cross-fitting procedure suggested in <a class="reference external" href="https://doi.org/10.1111/ectj.12097">Chernozhukov et al. (2018)</a> was employed. The DML approach builds on independent sample splits into partitions
that are used for training of the machine learning (ML) model learners and generation of predictions that are eventually used for solving the score function. For a motivation of the necessity of sample splitting, we refer to the illustration example in the <a class="reference external" href="https://docs.doubleml.org/stable/guide/basics.html#sample-splitting-to-remove-bias-induced-by-overfitting">user guide</a> as well as to the explanation in <a class="reference external" href="https://doi.org/10.1111/ectj.12097">Chernozhukov et al. (2018)</a> .</p>
<p>In order to achieve independent data splits in a setting with one-way or multi-way clustering, <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a> develop an updated <span class="math notranslate nohighlight">\(K\)</span>-fold sample splitting procedure that ensures independent sample splits: The data set is split into disjoint partitions in terms of all clustering dimensions. For example, in a situation with two-way clustering, the data is split into <span class="math notranslate nohighlight">\(K^2\)</span> folds. The machine learning models are then trained on a
specific fold and used for generation of predictions in hold-out samples. Thereby, the sample splitting procedure ensures that the hold-out samples do not contain observations of the same clusters as used for training.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">matplotlib.colors</span><span class="w"> </span><span class="kn">import</span> <span class="n">ListedColormap</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">KFold</span><span class="p">,</span> <span class="n">RepeatedKFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">clone</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LassoCV</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">doubleml</span><span class="w"> </span><span class="kn">import</span> <span class="n">DoubleMLClusterData</span><span class="p">,</span> <span class="n">DoubleMLData</span><span class="p">,</span> <span class="n">DoubleMLPLIV</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">doubleml.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pliv_multiway_cluster_CKMS2021</span>
</pre></div>
</div>
</div>
</section>
<section id="A-Motivating-Example:-Two-Way-Cluster-Robust-DML">
<h2>A Motivating Example: Two-Way Cluster Robust DML<a class="headerlink" href="#A-Motivating-Example:-Two-Way-Cluster-Robust-DML" title="Link to this heading">#</a></h2>
<p>In a first part, we show how the two-way cluster robust double machine learning (DML) (<a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. 2021</a>) can be implemented with the <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> package. <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a> consider double-indexed data</p>
<p><span class="math">\begin{equation}
\lbrace W_{ij}: i \in \lbrace 1, \ldots, N \rbrace, j \in \lbrace 1, \ldots, M \rbrace \rbrace
\end{equation}</span></p>
<p>and the partially linear IV regression model (PLIV)</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
Y_{ij} = D_{ij} \theta_0 +  g_0(X_{ij}) + \epsilon_{ij}, &amp; &amp;\mathbb{E}(\epsilon_{ij} | X_{ij}, Z_{ij}) = 0, \\
Z_{ij} = m_0(X_{ij}) + v_{ij}, &amp; &amp;\mathbb{E}(v_{ij} | X_{ij}) = 0.
\end{aligned}\end{split}\]</div>
<section id="Simulate-two-way-cluster-data">
<h3>Simulate two-way cluster data<a class="headerlink" href="#Simulate-two-way-cluster-data" title="Link to this heading">#</a></h3>
<p>We use the PLIV data generating process described in Section 4.1 of <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a>. The DGP is defined as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
Z_{ij} &amp;= X_{ij}' \xi_0 + V_{ij}, \\
D_{ij} &amp;= Z_{ij}' \pi_{10} + X_{ij}' \pi_{20} + v_{ij}, \\
Y_{ij} &amp;= D_{ij} \theta + X_{ij}' \zeta_0 + \varepsilon_{ij},
\end{aligned}\end{split}\]</div>
<p>with</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
X_{ij} &amp;= (1 - \omega_1^X - \omega_2^X) \alpha_{ij}^X
+ \omega_1^X \alpha_{i}^X + \omega_2^X \alpha_{j}^X, \\
\varepsilon_{ij} &amp;= (1 - \omega_1^\varepsilon - \omega_2^\varepsilon) \alpha_{ij}^\varepsilon
+ \omega_1^\varepsilon \alpha_{i}^\varepsilon + \omega_2^\varepsilon \alpha_{j}^\varepsilon, \\
v_{ij} &amp;= (1 - \omega_1^v - \omega_2^v) \alpha_{ij}^v
+ \omega_1^v \alpha_{i}^v + \omega_2^v \alpha_{j}^v, \\
V_{ij} &amp;= (1 - \omega_1^V - \omega_2^V) \alpha_{ij}^V
+ \omega_1^V \alpha_{i}^V + \omega_2^V \alpha_{j}^V,
\end{aligned}\end{split}\]</div>
<p>and <span class="math notranslate nohighlight">\(\alpha_{ij}^X, \alpha_{i}^X, \alpha_{j}^X \sim \mathcal{N}(0, \Sigma)\)</span> where <span class="math notranslate nohighlight">\(\Sigma\)</span> is a <span class="math notranslate nohighlight">\(p_x \times p_x\)</span> matrix with entries <span class="math notranslate nohighlight">\(\Sigma_{kj} = s_X^{|j-k|}\)</span>. Further</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\left(\begin{matrix} \alpha_{ij}^\varepsilon \\ \alpha_{ij}^v \end{matrix}\right),
\left(\begin{matrix} \alpha_{i}^\varepsilon \\ \alpha_{i}^v \end{matrix}\right),
\left(\begin{matrix} \alpha_{j}^\varepsilon \\ \alpha_{j}^v \end{matrix}\right)
\sim \mathcal{N}\left(0, \left(\begin{matrix} 1 &amp; s_{\varepsilon v} \\
s_{\varepsilon v} &amp; 1 \end{matrix} \right) \right)
\end{aligned}\end{split}\]</div>
<p>and <span class="math notranslate nohighlight">\(\alpha_{ij}^V, \alpha_{i}^V, \alpha_{j}^V \sim \mathcal{N}(0, 1)\)</span>.</p>
<p>Data from this DGP can be generated with the <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.datasets.make_pliv_multiway_cluster_CKMS2021.html#doubleml.datasets.make_pliv_multiway_cluster_CKMS2021">make_pliv_multiway_cluster_CKMS2021()</a> function from <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a>. Analogously to <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021, Section 5)</a> we use the following parameter setting: <span class="math notranslate nohighlight">\(\theta=1.0\)</span>, <span class="math notranslate nohighlight">\(N=M=25\)</span>,
<span class="math notranslate nohighlight">\(p_x=100\)</span>, <span class="math notranslate nohighlight">\(\pi_{10}=1.0\)</span>, <span class="math notranslate nohighlight">\(\omega_X = \omega_{\varepsilon} = \omega_V = \omega_v = (0.25, 0.25)\)</span>, <span class="math notranslate nohighlight">\(s_X = s_{\varepsilon v} = 0.25\)</span> and the <span class="math notranslate nohighlight">\(j\)</span>-th entries of the <span class="math notranslate nohighlight">\(p_x\)</span>-vectors <span class="math notranslate nohighlight">\(\zeta_0 = \pi_{20} = \xi_0\)</span> are <span class="math notranslate nohighlight">\((\zeta_{0})_j = 0.5^j\)</span>. This are also the default values of
<a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.datasets.make_pliv_multiway_cluster_CKMS2021.html#doubleml.datasets.make_pliv_multiway_cluster_CKMS2021">make_pliv_multiway_cluster_CKMS2021()</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the simulation parameters</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">25</span>  <span class="c1"># number of observations (first dimension)</span>
<span class="n">M</span> <span class="o">=</span> <span class="mi">25</span>  <span class="c1"># number of observations (second dimension)</span>
<span class="n">dim_X</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># dimension of X</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">3141</span><span class="p">)</span> <span class="c1"># set seed</span>

<span class="n">obj_dml_data</span> <span class="o">=</span> <span class="n">make_pliv_multiway_cluster_CKMS2021</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">dim_X</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Data-Backend-for-Cluster-Data">
<h3>Data-Backend for Cluster Data<a class="headerlink" href="#Data-Backend-for-Cluster-Data" title="Link to this heading">#</a></h3>
<p>The implementation of cluster robust double machine learning is based on a special data-backend called <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.data.DoubleMLClusterData.html">DoubleMLClusterData</a>. As compared to the standard data-backend <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.data.DoubleMLData.html">DoubleMLData</a>, users can specify the clustering variables during instantiation of a
<a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.data.DoubleMLClusterData.html">DoubleMLClusterData</a> object. The estimation framework will subsequently account for the provided clustering options.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The simulated data is of type DoubleMLClusterData</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obj_dml_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLClusterData Object ==================

------------------ Data summary      ------------------
Outcome variable: Y
Treatment variable(s): [&#39;D&#39;]
Cluster variable(s): [&#39;cluster_var_i&#39;, &#39;cluster_var_j&#39;]
Covariates: [&#39;X1&#39;, &#39;X2&#39;, &#39;X3&#39;, &#39;X4&#39;, &#39;X5&#39;, &#39;X6&#39;, &#39;X7&#39;, &#39;X8&#39;, &#39;X9&#39;, &#39;X10&#39;, &#39;X11&#39;, &#39;X12&#39;, &#39;X13&#39;, &#39;X14&#39;, &#39;X15&#39;, &#39;X16&#39;, &#39;X17&#39;, &#39;X18&#39;, &#39;X19&#39;, &#39;X20&#39;, &#39;X21&#39;, &#39;X22&#39;, &#39;X23&#39;, &#39;X24&#39;, &#39;X25&#39;, &#39;X26&#39;, &#39;X27&#39;, &#39;X28&#39;, &#39;X29&#39;, &#39;X30&#39;, &#39;X31&#39;, &#39;X32&#39;, &#39;X33&#39;, &#39;X34&#39;, &#39;X35&#39;, &#39;X36&#39;, &#39;X37&#39;, &#39;X38&#39;, &#39;X39&#39;, &#39;X40&#39;, &#39;X41&#39;, &#39;X42&#39;, &#39;X43&#39;, &#39;X44&#39;, &#39;X45&#39;, &#39;X46&#39;, &#39;X47&#39;, &#39;X48&#39;, &#39;X49&#39;, &#39;X50&#39;, &#39;X51&#39;, &#39;X52&#39;, &#39;X53&#39;, &#39;X54&#39;, &#39;X55&#39;, &#39;X56&#39;, &#39;X57&#39;, &#39;X58&#39;, &#39;X59&#39;, &#39;X60&#39;, &#39;X61&#39;, &#39;X62&#39;, &#39;X63&#39;, &#39;X64&#39;, &#39;X65&#39;, &#39;X66&#39;, &#39;X67&#39;, &#39;X68&#39;, &#39;X69&#39;, &#39;X70&#39;, &#39;X71&#39;, &#39;X72&#39;, &#39;X73&#39;, &#39;X74&#39;, &#39;X75&#39;, &#39;X76&#39;, &#39;X77&#39;, &#39;X78&#39;, &#39;X79&#39;, &#39;X80&#39;, &#39;X81&#39;, &#39;X82&#39;, &#39;X83&#39;, &#39;X84&#39;, &#39;X85&#39;, &#39;X86&#39;, &#39;X87&#39;, &#39;X88&#39;, &#39;X89&#39;, &#39;X90&#39;, &#39;X91&#39;, &#39;X92&#39;, &#39;X93&#39;, &#39;X94&#39;, &#39;X95&#39;, &#39;X96&#39;, &#39;X97&#39;, &#39;X98&#39;, &#39;X99&#39;, &#39;X100&#39;]
Instrument variable(s): [&#39;Z&#39;]
No. Observations: 625

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 625 entries, 0 to 624
Columns: 105 entries, cluster_var_i to Z
dtypes: float64(103), int64(2)
memory usage: 512.8 KB

</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The cluster variables are part of the DataFrame</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obj_dml_data</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
   cluster_var_i  cluster_var_j        X1        X2        X3        X4  \
0              0              0 -0.261903 -0.195564 -0.118952  0.508459
1              0              1 -1.082973 -0.303835  0.760778 -0.542671
2              0              2 -0.110359 -0.679539  0.491245 -0.309772
3              0              3 -0.010940  1.003427  0.412653  0.784238
4              0              4 -0.073207 -0.370736 -0.005857 -0.833907

         X5        X6        X7        X8  ...       X94       X95       X96  \
0  0.226598 -0.544555  0.183888  1.694919  ... -0.205938 -0.996934 -1.136836
1 -0.601598 -0.201768  0.234910  0.212844  ...  0.427573  0.303324  0.247826
2 -0.552727  0.036729 -0.673302 -1.024604  ...  0.094381 -0.922996 -2.054068
3  0.014637  0.611269  0.323679 -0.557999  ...  0.698694  1.342992 -1.136089
4 -0.096337 -0.714240  0.094026  0.435401  ... -0.149714 -0.164864 -0.756805

        X97       X98       X99      X100         Y         D         Z
0  0.010269 -0.396985 -0.161141 -0.614188  0.256567 -0.113780  0.104787
1  0.109273 -0.410795 -0.128408  0.633433 -1.816318 -1.002983 -0.942661
2 -0.477474 -0.543380 -0.720664 -0.332996 -0.851366 -0.302648  0.628069
3 -0.632058 -0.509958 -0.456370 -0.557595  1.081488  0.438960  0.054162
4  0.518175  0.510385 -0.681176 -1.020271 -1.708190 -1.805007 -0.850321

[5 rows x 105 columns]
</pre></div></div>
</div>
</section>
<section id="Initialize-the-objects-of-class-DoubleMLPLIV">
<h3>Initialize the objects of class <code class="docutils literal notranslate"><span class="pre">DoubleMLPLIV</span></code><a class="headerlink" href="#Initialize-the-objects-of-class-DoubleMLPLIV" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set machine learning methods for l, m &amp; r</span>
<span class="n">learner</span> <span class="o">=</span> <span class="n">LassoCV</span><span class="p">()</span>
<span class="n">ml_l</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
<span class="n">ml_m</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
<span class="n">ml_r</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>

<span class="c1"># initialize the DoubleMLPLIV object</span>
<span class="n">dml_pliv_obj</span> <span class="o">=</span> <span class="n">DoubleMLPLIV</span><span class="p">(</span><span class="n">obj_dml_data</span><span class="p">,</span>
                            <span class="n">ml_l</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span>
                            <span class="n">n_folds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dml_pliv_obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLPLIV Object ==================

------------------ Data summary      ------------------
Outcome variable: Y
Treatment variable(s): [&#39;D&#39;]
Cluster variable(s): [&#39;cluster_var_i&#39;, &#39;cluster_var_j&#39;]
Covariates: [&#39;X1&#39;, &#39;X2&#39;, &#39;X3&#39;, &#39;X4&#39;, &#39;X5&#39;, &#39;X6&#39;, &#39;X7&#39;, &#39;X8&#39;, &#39;X9&#39;, &#39;X10&#39;, &#39;X11&#39;, &#39;X12&#39;, &#39;X13&#39;, &#39;X14&#39;, &#39;X15&#39;, &#39;X16&#39;, &#39;X17&#39;, &#39;X18&#39;, &#39;X19&#39;, &#39;X20&#39;, &#39;X21&#39;, &#39;X22&#39;, &#39;X23&#39;, &#39;X24&#39;, &#39;X25&#39;, &#39;X26&#39;, &#39;X27&#39;, &#39;X28&#39;, &#39;X29&#39;, &#39;X30&#39;, &#39;X31&#39;, &#39;X32&#39;, &#39;X33&#39;, &#39;X34&#39;, &#39;X35&#39;, &#39;X36&#39;, &#39;X37&#39;, &#39;X38&#39;, &#39;X39&#39;, &#39;X40&#39;, &#39;X41&#39;, &#39;X42&#39;, &#39;X43&#39;, &#39;X44&#39;, &#39;X45&#39;, &#39;X46&#39;, &#39;X47&#39;, &#39;X48&#39;, &#39;X49&#39;, &#39;X50&#39;, &#39;X51&#39;, &#39;X52&#39;, &#39;X53&#39;, &#39;X54&#39;, &#39;X55&#39;, &#39;X56&#39;, &#39;X57&#39;, &#39;X58&#39;, &#39;X59&#39;, &#39;X60&#39;, &#39;X61&#39;, &#39;X62&#39;, &#39;X63&#39;, &#39;X64&#39;, &#39;X65&#39;, &#39;X66&#39;, &#39;X67&#39;, &#39;X68&#39;, &#39;X69&#39;, &#39;X70&#39;, &#39;X71&#39;, &#39;X72&#39;, &#39;X73&#39;, &#39;X74&#39;, &#39;X75&#39;, &#39;X76&#39;, &#39;X77&#39;, &#39;X78&#39;, &#39;X79&#39;, &#39;X80&#39;, &#39;X81&#39;, &#39;X82&#39;, &#39;X83&#39;, &#39;X84&#39;, &#39;X85&#39;, &#39;X86&#39;, &#39;X87&#39;, &#39;X88&#39;, &#39;X89&#39;, &#39;X90&#39;, &#39;X91&#39;, &#39;X92&#39;, &#39;X93&#39;, &#39;X94&#39;, &#39;X95&#39;, &#39;X96&#39;, &#39;X97&#39;, &#39;X98&#39;, &#39;X99&#39;, &#39;X100&#39;]
Instrument variable(s): [&#39;Z&#39;]
No. Observations: 625

------------------ Score &amp; algorithm ------------------
Score function: partialling out
DML algorithm: dml2

------------------ Machine learner   ------------------
Learner ml_l: LassoCV()
Learner ml_m: LassoCV()
Learner ml_r: LassoCV()

------------------ Resampling        ------------------
No. folds per cluster: 3
No. folds: 9
No. repeated sample splits: 1
Apply cross-fitting: True

------------------ Fit summary       ------------------
Empty DataFrame
Columns: [coef, std err, t, P&gt;|t|]
Index: []
</pre></div></div>
</div>
</section>
<section id="Cluster-Robust-Cross-Fitting">
<h3>Cluster Robust Cross Fitting<a class="headerlink" href="#Cluster-Robust-Cross-Fitting" title="Link to this heading">#</a></h3>
<p>A key element of cluster robust DML (<a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. 2021</a>) is a special sample splitting used for the cross-fitting. In case of two-way clustering, we assume <span class="math notranslate nohighlight">\(N\)</span> clusters in the first dimension and <span class="math notranslate nohighlight">\(M\)</span> clusters in the second dimension.</p>
<p>For <span class="math notranslate nohighlight">\(K\)</span>-fold cross-fitting, <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a> proposed to randomly partition <span class="math notranslate nohighlight">\([N]:=\{1,\ldots,N\}\)</span> into <span class="math notranslate nohighlight">\(K\)</span> subsets <span class="math notranslate nohighlight">\(\{I_1, \ldots, I_K\}\)</span> and <span class="math notranslate nohighlight">\([M]:=\{1,\ldots,N\}\)</span> into <span class="math notranslate nohighlight">\(K\)</span> subsets <span class="math notranslate nohighlight">\(\{J_1, \ldots, J_K\}\)</span>. Effectively, one then considers <span class="math notranslate nohighlight">\(K^2\)</span> folds. Basically for each <span class="math notranslate nohighlight">\((k, \ell) \in \{1, \ldots, K\} \times \{1, \ldots, K\}\)</span>, the nuisance functions are estimated for all double-indexed
observations in <span class="math notranslate nohighlight">\(([N]\setminus I_K) \times ([M]\setminus J_\ell)\)</span>, i.e.,</p>
<div class="math notranslate nohighlight">
\[\hat{\eta}_{k\ell} = \hat{\eta}\left((W_{ij})_{(i,j)\in ([N]\setminus I_K) \times ([M]\setminus J_\ell)}\right)\]</div>
<p>The causal parameter is then estimated as usual by solving a moment condition with a Neyman orthogonal score function. For two-way cluster robust double machine learning with algorithm <a class="reference external" href="https://docs.doubleml.org/stable/guide/algorithms.html#algorithm-dml2">DML2</a> this results in solving</p>
<div class="math notranslate nohighlight">
\[\frac{1}{K^2} \sum_{k=1}^{K} \sum_{\ell=1}^{K} \frac{1}{|I_k| |J_\ell|} \sum_{(i,j) \in I_K \times J_\ell}
\psi(W_{ij}, \tilde{\theta}_0, \hat{\eta}_{k\ell}) = 0\]</div>
<p>for <span class="math notranslate nohighlight">\(\tilde{\theta}_0\)</span>. Here <span class="math notranslate nohighlight">\(|I_k|\)</span> denotes the cardinality, i.e., the number of clusters in the <span class="math notranslate nohighlight">\(k\)</span>-th fold for the first cluster variable.</p>
<p>We can visualize the sample splitting of the <span class="math notranslate nohighlight">\(N \cdot M = 625\)</span> observations into <span class="math notranslate nohighlight">\(K \cdot K = 9\)</span> folds. The following heat map illustrates the partitioned data set that is split into <span class="math notranslate nohighlight">\(K=9\)</span> folds. The horizontal axis corresponds to the fold indices and the vertical axis to the indices of the observations. A blue field indicates that the observation <span class="math notranslate nohighlight">\(i\)</span> is used for fitting the nuisance part, red indicates that the fold is used for prediction generation and white means that
an observation is left out from the sample splitting.</p>
<p>For example, the first observation as displayed on the very bottom of the figure (using Python indexing starting at <code class="docutils literal notranslate"><span class="pre">0</span></code>) is used for training of the nuisance parts in the first (<code class="docutils literal notranslate"><span class="pre">0</span></code>), the third (<code class="docutils literal notranslate"><span class="pre">2</span></code>), fourth (<code class="docutils literal notranslate"><span class="pre">3</span></code>) and sixth (<code class="docutils literal notranslate"><span class="pre">5</span></code>) fold and used for generation of the predictions in fold eight (<code class="docutils literal notranslate"><span class="pre">7</span></code>). At the same time the observation is left out from the sample splitting procedure in folds two (<code class="docutils literal notranslate"><span class="pre">1</span></code>), five (<code class="docutils literal notranslate"><span class="pre">4</span></code>), seven (<code class="docutils literal notranslate"><span class="pre">6</span></code>) and nine (<code class="docutils literal notranslate"><span class="pre">8</span></code>).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The function plt_smpls is defined at the end of the Notebook</span>
<span class="n">plt_smpls</span><span class="p">(</span><span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">smpls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">_n_folds_per_cluster</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_multiway_cluster_14_0.png" src="../_images/examples_py_double_ml_multiway_cluster_14_0.png" />
</div>
</div>
<p>If we visualize the sample splitting in terms of the cluster variables, the partitioning of the data into <span class="math notranslate nohighlight">\(9\)</span> folds <span class="math notranslate nohighlight">\(I_k \times J_\ell\)</span> becomes clear. The identifiers for the first cluster variable <span class="math notranslate nohighlight">\([N]:=\{1,\ldots,N\}\)</span> have been randomly partioned into <span class="math notranslate nohighlight">\(K=3\)</span> folds denoted by <span class="math notranslate nohighlight">\(\{I_1, I_2, I_3\}\)</span> and the identifiers for the second cluster variable <span class="math notranslate nohighlight">\([M]:=\{1,\ldots,M\}\)</span> have also been randomly partioned into <span class="math notranslate nohighlight">\(K=3\)</span> folds denoted by
<span class="math notranslate nohighlight">\(\{J_1, J_2, J_3\}\)</span>. By considering every combination <span class="math notranslate nohighlight">\(I_k \times J_\ell\)</span> for <span class="math notranslate nohighlight">\(1 \leq k, \ell \leq K = 3\)</span> we effectively base the cross-fitting on <span class="math notranslate nohighlight">\(9\)</span> folds.</p>
<p>We now want to focus on the top-left sub-plot showing the partitioning of the cluster data for the first fold. The <span class="math notranslate nohighlight">\(x\)</span>-axis corresponds to the first cluster variable and the <span class="math notranslate nohighlight">\(y\)</span>-axis to the second cluster variable. Observations with cluster variables <span class="math notranslate nohighlight">\((i,j) \in I_K \times J_\ell\)</span> are used for estimation of the target parameter <span class="math notranslate nohighlight">\(\tilde{\theta}_0\)</span> by solving a Neyman orthogonal score function. For estimation of the nuisance function, we only use observation where neither
the first cluster variable is in <span class="math notranslate nohighlight">\(I_K\)</span> nor the second cluster variable is in <span class="math notranslate nohighlight">\(J_\ell\)</span>, i.e., we use observations indexed by <span class="math notranslate nohighlight">\((i,j)\in ([N]\setminus I_K) \times ([M]\setminus J_\ell)\)</span> to estimate the nuisance functions</p>
<div class="math notranslate nohighlight">
\[\hat{\eta}_{k\ell} = \hat{\eta}\left((W_{ij})_{(i,j)\in ([N]\setminus I_K) \times ([M]\setminus J_\ell)}\right).\]</div>
<p>This way we guarantee that there are never observations from the same cluster (first and/or second cluster dimension) in the sample for the nuisance function estimation (blue) and at the same time in the sample for solving the score function (red). As a result of this special sample splitting proposed by <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a>, the observations in the score (red) and nuisance (blue) sample can be considered independent and the standard
cross-fitting approach for double machine learning can be applied.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># The function plt_smpls_cluster is defined at the end of the Notebook</span>
<span class="n">plt_smpls_cluster</span><span class="p">(</span><span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">smpls_cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">_n_folds_per_cluster</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_multiway_cluster_16_0.png" src="../_images/examples_py_double_ml_multiway_cluster_16_0.png" />
</div>
</div>
</section>
<section id="Cluster-Robust-Standard-Errors">
<h3>Cluster Robust Standard Errors<a class="headerlink" href="#Cluster-Robust-Standard-Errors" title="Link to this heading">#</a></h3>
<p>In the abstract base class <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code> the estimation of cluster robust standard errors is implemented for all supported double machine learning models. It is based on the assumption of a linear Neyman orthogonal score function. We use the notation <span class="math notranslate nohighlight">\(n \wedge m := \min\{n,m\}\)</span>. For the the asymptotic variance of <span class="math notranslate nohighlight">\(\sqrt{\underline{C}}(\tilde{\theta_0} - \theta_0)\)</span> with <span class="math notranslate nohighlight">\(\underline{C} := N \wedge M\)</span> <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a> then
propose the following estimator</p>
<div class="math notranslate nohighlight">
\[\hat{\sigma}^2 = \hat{J}^{-1} \hat{\Gamma} \hat{J}^{-1}\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{aligned}
\hat{\Gamma} = \frac{1}{K^2} \sum_{(k, \ell) \in[K]^2}
\Bigg[ \frac{|I_k| \wedge |J_\ell|}{(|I_k||J_\ell|)^2}
\bigg(&amp;\sum_{i \in I_k} \sum_{j \in J_\ell} \sum_{j' \in J_\ell}
\psi(W_{ij}; \tilde{\theta}, \hat{\eta}_{k \ell}) \psi(W_{ij'}; \tilde{\theta}_0, \hat{\eta}_{k \ell}) \\
&amp;+ \sum_{i \in I_k} \sum_{i' \in I_k} \sum_{j \in J_\ell}
\psi(W_{ij}; \tilde{\theta}, \hat{\eta}_{k \ell}) \psi(W_{i'j}; \tilde{\theta}_0, \hat{\eta}_{k \ell})
\bigg)
\Bigg]
\end{aligned}\end{split}\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
\hat{J} = \frac{1}{K^2} \sum_{(k, \ell) \in[K]^2} \frac{1}{|I_k||J_\ell|}
\sum_{i \in I_k} \sum_{j \in J_\ell}
\psi_a(W_{ij}; \tilde{\theta}_0, \hat{\eta}_{k \ell}).
\end{aligned}\]</div>
<p>A <span class="math notranslate nohighlight">\((1-\alpha)\)</span> confidence interval is then given by (<a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. 2021</a>)</p>
<div class="math notranslate nohighlight">
\[\begin{aligned}
\left[
\tilde{\theta} \pm \Phi^{-1}(1-\alpha/2) \sqrt{\hat{\sigma}^2 / \underline{C}}
\right]
\end{aligned}\]</div>
<p>with <span class="math notranslate nohighlight">\(\underline{C} = N \wedge M\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Estimate the PLIV model with cluster robust double machine learning</span>
<span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
       coef   std err         t         P&gt;|t|     2.5 %    97.5 %
D  1.135871  0.118601  9.577271  9.964261e-22  0.903418  1.368324
</pre></div></div>
</div>
</section>
</section>
<section id="(One-Way)-Cluster-Robust-Double-Machine-Learing">
<h2>(One-Way) Cluster Robust Double Machine Learing<a class="headerlink" href="#(One-Way)-Cluster-Robust-Double-Machine-Learing" title="Link to this heading">#</a></h2>
<p>We again use the PLIV data generating process described in Section 4.1 of <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a>. To obtain one-way clustered data, we set the following weights to zero</p>
<div class="math notranslate nohighlight">
\[\omega_2^X = \omega_2^\varepsilon = \omega_2^v = \omega_2^V = 0.\]</div>
<p>Again we can simulate this data with <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.datasets.make_pliv_multiway_cluster_CKMS2021.html#doubleml.datasets.make_pliv_multiway_cluster_CKMS2021">make_pliv_multiway_cluster_CKMS2021()</a>. To prepare the data-backend for one-way clustering, we only have to alter the <code class="docutils literal notranslate"><span class="pre">cluster_cols</span></code> to be <code class="docutils literal notranslate"><span class="pre">'cluster_var_i'</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj_dml_data</span> <span class="o">=</span> <span class="n">make_pliv_multiway_cluster_CKMS2021</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">dim_X</span><span class="p">,</span>
                                                   <span class="n">omega_X</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">omega_epsilon</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">omega_v</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">omega_V</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">obj_dml_data</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="s1">&#39;cluster_var_i&#39;</span>
<span class="nb">print</span><span class="p">(</span><span class="n">obj_dml_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLClusterData Object ==================

------------------ Data summary      ------------------
Outcome variable: Y
Treatment variable(s): [&#39;D&#39;]
Cluster variable(s): [&#39;cluster_var_i&#39;]
Covariates: [&#39;X1&#39;, &#39;X2&#39;, &#39;X3&#39;, &#39;X4&#39;, &#39;X5&#39;, &#39;X6&#39;, &#39;X7&#39;, &#39;X8&#39;, &#39;X9&#39;, &#39;X10&#39;, &#39;X11&#39;, &#39;X12&#39;, &#39;X13&#39;, &#39;X14&#39;, &#39;X15&#39;, &#39;X16&#39;, &#39;X17&#39;, &#39;X18&#39;, &#39;X19&#39;, &#39;X20&#39;, &#39;X21&#39;, &#39;X22&#39;, &#39;X23&#39;, &#39;X24&#39;, &#39;X25&#39;, &#39;X26&#39;, &#39;X27&#39;, &#39;X28&#39;, &#39;X29&#39;, &#39;X30&#39;, &#39;X31&#39;, &#39;X32&#39;, &#39;X33&#39;, &#39;X34&#39;, &#39;X35&#39;, &#39;X36&#39;, &#39;X37&#39;, &#39;X38&#39;, &#39;X39&#39;, &#39;X40&#39;, &#39;X41&#39;, &#39;X42&#39;, &#39;X43&#39;, &#39;X44&#39;, &#39;X45&#39;, &#39;X46&#39;, &#39;X47&#39;, &#39;X48&#39;, &#39;X49&#39;, &#39;X50&#39;, &#39;X51&#39;, &#39;X52&#39;, &#39;X53&#39;, &#39;X54&#39;, &#39;X55&#39;, &#39;X56&#39;, &#39;X57&#39;, &#39;X58&#39;, &#39;X59&#39;, &#39;X60&#39;, &#39;X61&#39;, &#39;X62&#39;, &#39;X63&#39;, &#39;X64&#39;, &#39;X65&#39;, &#39;X66&#39;, &#39;X67&#39;, &#39;X68&#39;, &#39;X69&#39;, &#39;X70&#39;, &#39;X71&#39;, &#39;X72&#39;, &#39;X73&#39;, &#39;X74&#39;, &#39;X75&#39;, &#39;X76&#39;, &#39;X77&#39;, &#39;X78&#39;, &#39;X79&#39;, &#39;X80&#39;, &#39;X81&#39;, &#39;X82&#39;, &#39;X83&#39;, &#39;X84&#39;, &#39;X85&#39;, &#39;X86&#39;, &#39;X87&#39;, &#39;X88&#39;, &#39;X89&#39;, &#39;X90&#39;, &#39;X91&#39;, &#39;X92&#39;, &#39;X93&#39;, &#39;X94&#39;, &#39;X95&#39;, &#39;X96&#39;, &#39;X97&#39;, &#39;X98&#39;, &#39;X99&#39;, &#39;X100&#39;]
Instrument variable(s): [&#39;Z&#39;]
No. Observations: 625

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 625 entries, 0 to 624
Columns: 105 entries, cluster_var_i to Z
dtypes: float64(103), int64(2)
memory usage: 512.8 KB

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set machine learning methods for l, m &amp; r</span>
<span class="n">learner</span> <span class="o">=</span> <span class="n">LassoCV</span><span class="p">()</span>
<span class="n">ml_l</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
<span class="n">ml_m</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
<span class="n">ml_r</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>

<span class="c1"># initialize the DoubleMLPLIV object</span>
<span class="n">dml_pliv_obj</span> <span class="o">=</span> <span class="n">DoubleMLPLIV</span><span class="p">(</span><span class="n">obj_dml_data</span><span class="p">,</span>
                            <span class="n">ml_l</span><span class="p">,</span> <span class="n">ml_m</span><span class="p">,</span> <span class="n">ml_r</span><span class="p">,</span>
                            <span class="n">n_folds</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_pliv_obj</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
       coef   std err          t         P&gt;|t|     2.5 %   97.5 %
D  0.951532  0.047954  19.842625  1.276189e-87  0.857544  1.04552
</pre></div></div>
</div>
</section>
<section id="Real-Data-Application">
<h2>Real-Data Application<a class="headerlink" href="#Real-Data-Application" title="Link to this heading">#</a></h2>
<p>As a real-data application we revist the consumer demand example from <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">Chiang et al. (2021)</a>. The U.S. automobile data of <a class="reference external" href="https://doi.org/10.2307/2171802">Berry, Levinsohn, and Pakes (1995)</a> is obtained from the <code class="docutils literal notranslate"><span class="pre">R</span></code> package <a class="reference external" href="https://cran.r-project.org/web/packages/hdm/index.html">hdm</a>. In this example, we consider different specifications for the cluster dimensions.</p>
<section id="Load-and-Process-Data">
<h3>Load and Process Data<a class="headerlink" href="#Load-and-Process-Data" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rpy2.robjects.packages</span><span class="w"> </span><span class="kn">import</span> <span class="n">PackageData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rpy2.robjects</span><span class="w"> </span><span class="kn">import</span> <span class="n">pandas2ri</span><span class="p">,</span> <span class="n">default_converter</span><span class="p">,</span> <span class="n">conversion</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r_df</span> <span class="o">=</span> <span class="n">PackageData</span><span class="p">(</span><span class="s1">&#39;hdm&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="s1">&#39;BLP&#39;</span><span class="p">)[</span><span class="s1">&#39;BLP&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<span class="k">with</span> <span class="n">conversion</span><span class="o">.</span><span class="n">localconverter</span><span class="p">(</span><span class="n">default_converter</span> <span class="o">+</span> <span class="n">pandas2ri</span><span class="o">.</span><span class="n">converter</span><span class="p">):</span>
    <span class="n">blp_data</span> <span class="o">=</span> <span class="n">conversion</span><span class="o">.</span><span class="n">rpy2py</span><span class="p">(</span><span class="n">r_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;hpwt&#39;</span><span class="p">,</span> <span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="s1">&#39;mpd&#39;</span><span class="p">,</span> <span class="s1">&#39;space&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">blp_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
     model.name  model.id  firm.id  cdid      id      price       mpd  air  \
1        AMGREM      23.0     15.0   1.0   129.0  -6.825617  1.888146  0.0
2        AMHORN      24.0     15.0   1.0   130.0  -6.245370  1.935989  0.0
3        AMJAVL      25.0     15.0   1.0   132.0  -4.652778  1.716799  0.0
4        AMMATA      26.0     15.0   1.0   134.0  -4.921913  1.687871  0.0
5        AMAMBS      18.0     15.0   1.0   136.0  -2.833024  1.504286  0.0
...         ...       ...      ...   ...     ...        ...       ...  ...
2213     VV740      526.0      6.0  20.0  5584.0   4.378596  2.639135  1.0
2214     VV760G     529.0      6.0  20.0  5585.0  14.225574  2.136442  1.0
2215     YGGVPL     555.0     23.0  20.0  5589.0  -8.368152  3.518846  0.0
2216     PS911C     425.0     12.0  20.0  5590.0  32.997571  3.016154  1.0
2217     PS944      438.0     12.0  20.0  5592.0  20.296729  3.267500  1.0

        mpg     space      hpwt  trend     share    outshr         y
1     1.697  1.150200  0.528997    0.0  0.001051  0.880106  0.820366
2     1.740  1.278000  0.494324    0.0  0.000670  0.880106  0.369981
3     1.543  1.459200  0.467613    0.0  0.000341  0.880106 -0.306915
4     1.517  1.606800  0.426540    0.0  0.000522  0.880106  0.120721
5     1.352  1.645800  0.452489    0.0  0.000442  0.880106 -0.045144
...     ...       ...       ...    ...       ...       ...       ...
2213  2.100  1.305612  0.385917   19.0  0.000488  0.907801  0.022915
2214  1.700  1.305612  0.435967   19.0  0.000091  0.907801 -1.652350
2215  2.800  0.843730  0.358289   19.0  0.000067  0.907801 -1.957375
2216  2.400  1.093950  0.814913   19.0  0.000039  0.907801 -2.512519
2217  2.600  1.153587  0.693796   19.0  0.000025  0.907801 -2.953683

[2217 rows x 15 columns]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">construct_iv</span><span class="p">(</span><span class="n">blp_data</span><span class="p">,</span> <span class="n">x_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hpwt&#39;</span><span class="p">,</span> <span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="s1">&#39;mpd&#39;</span><span class="p">,</span> <span class="s1">&#39;space&#39;</span><span class="p">]):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">blp_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">p</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x_cols</span><span class="p">)</span>

    <span class="n">firmid</span> <span class="o">=</span> <span class="n">blp_data</span><span class="p">[</span><span class="s1">&#39;firm.id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">cdid</span> <span class="o">=</span> <span class="n">blp_data</span><span class="p">[</span><span class="s1">&#39;cdid&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">id_var</span> <span class="o">=</span> <span class="n">blp_data</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">blp_data</span><span class="p">[</span><span class="n">x_cols</span><span class="p">]</span>

    <span class="n">sum_other</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sum.other.&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x_cols</span><span class="p">],</span>
                             <span class="n">index</span><span class="o">=</span><span class="n">blp_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="n">sum_rival</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sum.rival.&#39;</span> <span class="o">+</span> <span class="n">var</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">x_cols</span><span class="p">],</span>
                             <span class="n">index</span><span class="o">=</span><span class="n">blp_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">other_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmid</span> <span class="o">==</span> <span class="n">firmid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cdid</span> <span class="o">==</span> <span class="n">cdid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">id_var</span> <span class="o">!=</span> <span class="n">id_var</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">rival_ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">firmid</span> <span class="o">!=</span> <span class="n">firmid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">cdid</span> <span class="o">==</span> <span class="n">cdid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">sum_other</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">j</span><span class="p">][</span><span class="n">other_ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">sum_rival</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="n">j</span><span class="p">][</span><span class="n">rival_ind</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">sum_other</span><span class="p">,</span> <span class="n">sum_rival</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">iv_vars</span> <span class="o">=</span> <span class="n">construct_iv</span><span class="p">(</span><span class="n">blp_data</span><span class="p">,</span> <span class="n">x_cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hpwt&#39;</span><span class="p">,</span> <span class="s1">&#39;air&#39;</span><span class="p">,</span> <span class="s1">&#39;mpd&#39;</span><span class="p">,</span> <span class="s1">&#39;space&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">data_transf</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">blp_data</span><span class="p">[</span><span class="n">x_cols</span><span class="p">])</span>
<span class="n">x_cols_poly</span> <span class="o">=</span> <span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">x_cols</span><span class="p">)</span>
<span class="n">data_transf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data_transf</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">x_cols_poly</span><span class="p">)</span>
<span class="n">data_transf</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">blp_data</span><span class="o">.</span><span class="n">index</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sel_cols_chiang</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">data_transf</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                                    <span class="p">[</span><span class="s1">&#39;hpwt air mpd&#39;</span><span class="p">,</span> <span class="s1">&#39;hpwt air space&#39;</span><span class="p">,</span>
                                     <span class="s1">&#39;hpwt mpd space&#39;</span><span class="p">,</span> <span class="s1">&#39;air mpd space&#39;</span><span class="p">]))</span>
<span class="n">sel_cols_chiang</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[&#39;air&#39;,
 &#39;air mpd&#39;,
 &#39;air mpd^2&#39;,
 &#39;air space&#39;,
 &#39;air space^2&#39;,
 &#39;air^2&#39;,
 &#39;air^2 mpd&#39;,
 &#39;air^2 space&#39;,
 &#39;air^3&#39;,
 &#39;hpwt&#39;,
 &#39;hpwt air&#39;,
 &#39;hpwt air^2&#39;,
 &#39;hpwt mpd&#39;,
 &#39;hpwt mpd^2&#39;,
 &#39;hpwt space&#39;,
 &#39;hpwt space^2&#39;,
 &#39;hpwt^2&#39;,
 &#39;hpwt^2 air&#39;,
 &#39;hpwt^2 mpd&#39;,
 &#39;hpwt^2 space&#39;,
 &#39;hpwt^3&#39;,
 &#39;mpd&#39;,
 &#39;mpd space&#39;,
 &#39;mpd space^2&#39;,
 &#39;mpd^2&#39;,
 &#39;mpd^2 space&#39;,
 &#39;mpd^3&#39;,
 &#39;space&#39;,
 &#39;space^2&#39;,
 &#39;space^3&#39;]
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">blp_data</span><span class="p">[</span><span class="s1">&#39;log_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">blp_data</span><span class="p">[</span><span class="s1">&#39;price&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mf">11.761</span><span class="p">)</span>

<span class="n">y_col</span> <span class="o">=</span> <span class="s1">&#39;y&#39;</span>
<span class="n">d_col</span> <span class="o">=</span> <span class="s1">&#39;log_p&#39;</span>
<span class="n">cluster_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model.id&#39;</span><span class="p">,</span> <span class="s1">&#39;cdid&#39;</span><span class="p">]</span>
<span class="n">all_z_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;sum.other.hpwt&#39;</span><span class="p">,</span> <span class="s1">&#39;sum.other.mpd&#39;</span><span class="p">,</span> <span class="s1">&#39;sum.other.space&#39;</span><span class="p">]</span>
<span class="n">z_col</span> <span class="o">=</span> <span class="n">all_z_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">blp_data</span><span class="p">[[</span><span class="n">y_col</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">d_col</span><span class="p">]</span> <span class="o">+</span> <span class="n">cluster_cols</span><span class="p">],</span>
                    <span class="n">data_transf</span><span class="p">[</span><span class="n">sel_cols_chiang</span><span class="p">],</span>
                    <span class="n">iv_vars</span><span class="p">[</span><span class="n">all_z_cols</span><span class="p">]),</span>
                   <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_df</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(2217, 37)
</pre></div></div>
</div>
</section>
<section id="Initialize-DoubleMLClusterData-object">
<h3>Initialize <code class="docutils literal notranslate"><span class="pre">DoubleMLClusterData</span></code> object<a class="headerlink" href="#Initialize-DoubleMLClusterData-object" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_data</span> <span class="o">=</span> <span class="n">DoubleMLClusterData</span><span class="p">(</span><span class="n">dml_df</span><span class="p">,</span>
                               <span class="n">y_col</span><span class="o">=</span><span class="n">y_col</span><span class="p">,</span>
                               <span class="n">d_cols</span><span class="o">=</span><span class="n">d_col</span><span class="p">,</span>
                               <span class="n">z_cols</span><span class="o">=</span><span class="n">z_col</span><span class="p">,</span>
                               <span class="n">cluster_cols</span><span class="o">=</span><span class="n">cluster_cols</span><span class="p">,</span>
                               <span class="n">x_cols</span><span class="o">=</span><span class="n">sel_cols_chiang</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dml_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLClusterData Object ==================

------------------ Data summary      ------------------
Outcome variable: y
Treatment variable(s): [&#39;log_p&#39;]
Cluster variable(s): [&#39;model.id&#39;, &#39;cdid&#39;]
Covariates: [&#39;air&#39;, &#39;air mpd&#39;, &#39;air mpd^2&#39;, &#39;air space&#39;, &#39;air space^2&#39;, &#39;air^2&#39;, &#39;air^2 mpd&#39;, &#39;air^2 space&#39;, &#39;air^3&#39;, &#39;hpwt&#39;, &#39;hpwt air&#39;, &#39;hpwt air^2&#39;, &#39;hpwt mpd&#39;, &#39;hpwt mpd^2&#39;, &#39;hpwt space&#39;, &#39;hpwt space^2&#39;, &#39;hpwt^2&#39;, &#39;hpwt^2 air&#39;, &#39;hpwt^2 mpd&#39;, &#39;hpwt^2 space&#39;, &#39;hpwt^3&#39;, &#39;mpd&#39;, &#39;mpd space&#39;, &#39;mpd space^2&#39;, &#39;mpd^2&#39;, &#39;mpd^2 space&#39;, &#39;mpd^3&#39;, &#39;space&#39;, &#39;space^2&#39;, &#39;space^3&#39;]
Instrument variable(s): [&#39;sum.other.hpwt&#39;]
No. Observations: 2217

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 2217 entries, 1 to 2217
Columns: 37 entries, y to sum.other.space
dtypes: float64(34), object(3)
memory usage: 658.2+ KB

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learner</span> <span class="o">=</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">50000</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">n_rep</span> <span class="o">=</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
</section>
<section id="Two-Way-Clustering-with-Respect-to-Product-and-Market">
<h3>Two-Way Clustering with Respect to Product and Market<a class="headerlink" href="#Two-Way-Clustering-with-Respect-to-Product-and-Market" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span> <span class="o">=</span> <span class="n">z_col</span>
<span class="n">dml_data</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;model.id&#39;</span><span class="p">,</span> <span class="s1">&#39;cdid&#39;</span><span class="p">]</span>
<span class="n">dml_pliv</span> <span class="o">=</span> <span class="n">DoubleMLPLIV</span><span class="p">(</span><span class="n">dml_data</span><span class="p">,</span>
                        <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span>
                        <span class="n">n_folds</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">)</span>
<span class="n">dml_pliv</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">dml_pliv</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;z_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;clustering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;two-way&#39;</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
c:\Users\svenk\.conda\envs\dml_base\lib\site-packages\sklearn\linear_model\_coordinate_descent.py:617: ConvergenceWarning: Objective did not converge. You might want to increase the number of iterations. Duality gap: 3.5154789948092002, tolerance: 1.1187339840850312
  model = cd_fast.enet_coordinate_descent_gram(
</pre></div></div>
</div>
</section>
<section id="One-Way-Clustering-with-Respect-to-the-Product">
<h3>One-Way Clustering with Respect to the Product<a class="headerlink" href="#One-Way-Clustering-with-Respect-to-the-Product" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span> <span class="o">=</span> <span class="n">z_col</span>
<span class="n">dml_data</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="s1">&#39;model.id&#39;</span>
<span class="n">dml_pliv</span> <span class="o">=</span> <span class="n">DoubleMLPLIV</span><span class="p">(</span><span class="n">dml_data</span><span class="p">,</span>
                        <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span>
                        <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">)</span>
<span class="n">dml_pliv</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">dml_pliv</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;z_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;clustering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;one-way-product&#39;</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="One-Way-Clustering-with-Respect-to-the-Market">
<h3>One-Way Clustering with Respect to the Market<a class="headerlink" href="#One-Way-Clustering-with-Respect-to-the-Market" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span> <span class="o">=</span> <span class="n">z_col</span>
<span class="n">dml_data</span><span class="o">.</span><span class="n">cluster_cols</span> <span class="o">=</span> <span class="s1">&#39;cdid&#39;</span>
<span class="n">dml_pliv</span> <span class="o">=</span> <span class="n">DoubleMLPLIV</span><span class="p">(</span><span class="n">dml_data</span><span class="p">,</span>
                        <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span>
                        <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">)</span>
<span class="n">dml_pliv</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">dml_pliv</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;z_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;clustering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;one-way-market&#39;</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="No-Clustering-/-Zero-Way-Clustering">
<h3>No Clustering / Zero-Way Clustering<a class="headerlink" href="#No-Clustering-/-Zero-Way-Clustering" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_data</span> <span class="o">=</span> <span class="n">DoubleMLData</span><span class="p">(</span><span class="n">dml_df</span><span class="p">,</span>
                        <span class="n">y_col</span><span class="o">=</span><span class="n">y_col</span><span class="p">,</span>
                        <span class="n">d_cols</span><span class="o">=</span><span class="n">d_col</span><span class="p">,</span>
                        <span class="n">z_cols</span><span class="o">=</span><span class="n">z_col</span><span class="p">,</span>
                        <span class="n">x_cols</span><span class="o">=</span><span class="n">sel_cols_chiang</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">dml_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLData Object ==================

------------------ Data summary      ------------------
Outcome variable: y
Treatment variable(s): [&#39;log_p&#39;]
Covariates: [&#39;air&#39;, &#39;air mpd&#39;, &#39;air mpd^2&#39;, &#39;air space&#39;, &#39;air space^2&#39;, &#39;air^2&#39;, &#39;air^2 mpd&#39;, &#39;air^2 space&#39;, &#39;air^3&#39;, &#39;hpwt&#39;, &#39;hpwt air&#39;, &#39;hpwt air^2&#39;, &#39;hpwt mpd&#39;, &#39;hpwt mpd^2&#39;, &#39;hpwt space&#39;, &#39;hpwt space^2&#39;, &#39;hpwt^2&#39;, &#39;hpwt^2 air&#39;, &#39;hpwt^2 mpd&#39;, &#39;hpwt^2 space&#39;, &#39;hpwt^3&#39;, &#39;mpd&#39;, &#39;mpd space&#39;, &#39;mpd space^2&#39;, &#39;mpd^2&#39;, &#39;mpd^2 space&#39;, &#39;mpd^3&#39;, &#39;space&#39;, &#39;space^2&#39;, &#39;space^3&#39;]
Instrument variable(s): [&#39;sum.other.hpwt&#39;]
No. Observations: 2217

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 2217 entries, 1 to 2217
Columns: 37 entries, y to sum.other.space
dtypes: float64(34), object(3)
memory usage: 658.2+ KB

</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span> <span class="o">=</span> <span class="n">z_col</span>
<span class="n">dml_pliv</span> <span class="o">=</span> <span class="n">DoubleMLPLIV</span><span class="p">(</span><span class="n">dml_data</span><span class="p">,</span>
                        <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">),</span>
                        <span class="n">n_folds</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">)</span>
<span class="n">dml_pliv</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">dml_pliv</span><span class="o">.</span><span class="n">summary</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;z_col&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dml_data</span><span class="o">.</span><span class="n">z_cols</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">res</span><span class="p">[</span><span class="s1">&#39;clustering&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;zero-way&#39;</span>
<span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_df</span><span class="p">,</span> <span class="n">res</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Application-Results">
<h3>Application Results<a class="headerlink" href="#Application-Results" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">res_df</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
       coef   std err          t         P&gt;|t|     2.5 %    97.5 %  \
0 -5.450152  1.262621  -4.316540  1.584942e-05 -7.924843 -2.975461
1 -5.757819  0.928947  -6.198218  5.710586e-10 -7.578523 -3.937116
2 -5.811825  0.784483  -7.408479  1.277561e-13 -7.349383 -4.274267
3 -5.754870  0.464284 -12.395136  2.776728e-35 -6.664850 -4.844889

            z_col       clustering
0  sum.other.hpwt          two-way
1  sum.other.hpwt  one-way-product
2  sum.other.hpwt   one-way-market
3  sum.other.hpwt         zero-way
</pre></div></div>
</div>
</section>
</section>
<section id="References">
<h2>References<a class="headerlink" href="#References" title="Link to this heading">#</a></h2>
<p>Berry, S., Levinsohn, J., and Pakes, A. (1995), Automobile Prices in Market Equilibrium, Econometrica: Journal of the Econometric Society, 63, 841-890, doi: <a class="reference external" href="https://doi.org/10.2307/2171802">10.2307/2171802</a>.</p>
<p>Cameron, A. C., Gelbach, J. B. and Miller, D. L. (2011), Robust Inference with Multiway Clustering, Journal of Business &amp; Economic Statistics, 29:2, 238-249, doi: <a class="reference external" href="https://doi.org/10.1198/jbes.2010.07136">10.1198/jbes.2010.07136</a>.</p>
<p>Chernozhukov, V., Chetverikov, D., Demirer, M., Duflo, E., Hansen, C., Newey, W. and Robins, J. (2018), Double/debiased machine learning for treatment and structural parameters. The Econometrics Journal, 21: C1-C68, doi: <a class="reference external" href="https://doi.org/10.1111/ectj.12097">10.1111/ectj.12097</a>.</p>
<p>Chiang, H. D., Kato K., Ma, Y. and Sasaki, Y. (2021), Multiway Cluster Robust Double/Debiased Machine Learning, Journal of Business &amp; Economic Statistics, doi: <a class="reference external" href="https://doi.org/10.1080/07350015.2021.1895815">10.1080/07350015.2021.1895815</a>, arXiv: <a class="reference external" href="https://arxiv.org/abs/1909.03489">1909.03489</a>.</p>
</section>
<section id="Define-Helper-Functions-for-Plotting">
<h2>Define Helper Functions for Plotting<a class="headerlink" href="#Define-Helper-Functions-for-Plotting" title="Link to this heading">#</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#discrete color scheme</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;RdBu_r&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span>
<span class="n">cMap</span> <span class="o">=</span> <span class="n">ListedColormap</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">6</span><span class="p">]])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.figsize&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">12</span>
<span class="n">sns</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">font_scale</span><span class="o">=</span><span class="mf">1.3</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plt_smpls</span><span class="p">(</span><span class="n">smpls</span><span class="p">,</span> <span class="n">n_folds_per_cluster</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="o">*</span><span class="n">M</span><span class="p">,</span> <span class="n">n_folds_per_cluster</span><span class="o">*</span><span class="n">n_folds_per_cluster</span><span class="p">]))</span>
    <span class="k">for</span> <span class="n">i_split</span><span class="p">,</span> <span class="n">this_split_ind</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">smpls</span><span class="p">):</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_split_ind</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">i_split</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">this_split_ind</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">i_split</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>

    <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cMap</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">();</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">N</span><span class="o">*</span><span class="n">M</span><span class="p">]);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fold&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Observation&#39;</span><span class="p">)</span>
    <span class="n">colorbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
    <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="o">-</span><span class="mf">0.667</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">])</span>
    <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;Nuisance&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Score&#39;</span><span class="p">])</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plt_smpls_cluster</span><span class="p">(</span><span class="n">smpls_cluster</span><span class="p">,</span> <span class="n">n_folds_per_cluster</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i_split</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">smpls_cluster</span><span class="p">)):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="n">n_folds_per_cluster</span><span class="p">,</span> <span class="n">n_folds_per_cluster</span><span class="p">,</span> <span class="n">i_split</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">N</span><span class="o">*</span><span class="n">M</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                      <span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">M</span><span class="p">)]),</span>
                      <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>

        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span><span class="n">smpls_cluster</span><span class="p">[</span><span class="n">i_split</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">(</span><span class="n">smpls_cluster</span><span class="p">[</span><span class="n">i_split</span><span class="p">][</span><span class="mi">1</span><span class="p">]),</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">1.</span>

        <span class="n">df_wide</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;level_0&quot;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;level_1&quot;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s2">&quot;value&quot;</span><span class="p">)</span>
        <span class="n">df_wide</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
        <span class="n">df_wide</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;&#39;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">df_wide</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cMap</span><span class="p">);</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">();</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="n">M</span><span class="p">]);</span>
        <span class="n">colorbar</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">colorbar</span>
        <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticks</span><span class="p">([</span><span class="o">-</span><span class="mf">0.667</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.667</span><span class="p">])</span>

        <span class="n">l</span> <span class="o">=</span> <span class="n">i_split</span> <span class="o">%</span> <span class="n">n_folds_per_cluster</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor_divide</span><span class="p">(</span><span class="n">i_split</span><span class="p">,</span> <span class="n">n_folds_per_cluster</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;Nuisance: $I_</span><span class="se">{{</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">}}</span><span class="s1">^C </span><span class="se">\\</span><span class="s1">times J_</span><span class="se">{{</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="se">}}</span><span class="s1">^C$; Score: $I_</span><span class="se">{{</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="se">}}</span><span class="s1"> </span><span class="se">\\</span><span class="s1">times J_</span><span class="se">{{</span><span class="si">{</span><span class="n">l</span><span class="si">}</span><span class="se">}}</span><span class="s1">$&#39;</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">n_folds_per_cluster</span><span class="p">:</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;Nuisance&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;Score&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">colorbar</span><span class="o">.</span><span class="n">set_ticklabels</span><span class="p">([</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;First Cluster Variable $k$&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Second Cluster Variable $\ell$&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="py_double_ml_firststage.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Python: First Stage and Causal Estimation</p>
      </div>
    </a>
    <a class="right-next"
       href="py_double_ml_ssm.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Python: Sample Selection Models</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Motivation">Motivation</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Clustering-and-double-machine-learning">Clustering and double machine learning</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#A-Motivating-Example:-Two-Way-Cluster-Robust-DML">A Motivating Example: Two-Way Cluster Robust DML</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Simulate-two-way-cluster-data">Simulate two-way cluster data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Data-Backend-for-Cluster-Data">Data-Backend for Cluster Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Initialize-the-objects-of-class-DoubleMLPLIV">Initialize the objects of class <code class="docutils literal notranslate"><span class="pre">DoubleMLPLIV</span></code></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Cluster-Robust-Cross-Fitting">Cluster Robust Cross Fitting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Cluster-Robust-Standard-Errors">Cluster Robust Standard Errors</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#(One-Way)-Cluster-Robust-Double-Machine-Learing">(One-Way) Cluster Robust Double Machine Learing</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Real-Data-Application">Real-Data Application</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Load-and-Process-Data">Load and Process Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Initialize-DoubleMLClusterData-object">Initialize <code class="docutils literal notranslate"><span class="pre">DoubleMLClusterData</span></code> object</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Two-Way-Clustering-with-Respect-to-Product-and-Market">Two-Way Clustering with Respect to Product and Market</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#One-Way-Clustering-with-Respect-to-the-Product">One-Way Clustering with Respect to the Product</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#One-Way-Clustering-with-Respect-to-the-Market">One-Way Clustering with Respect to the Market</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#No-Clustering-/-Zero-Way-Clustering">No Clustering / Zero-Way Clustering</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Application-Results">Application Results</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#References">References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Define-Helper-Functions-for-Plotting">Define Helper Functions for Plotting</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/DoubleML/doubleml-docs/edit/dev/doc/examples/py_double_ml_multiway_cluster.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/examples/py_double_ml_multiway_cluster.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, Bach, P., Chernozhukov, V., Klaassen, S., Kurz, M. S., and Spindler, M..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>