
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Python: Causal Machine Learning with TabPFN &#8212; DoubleML  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=c49bcd98" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=1ecd1175"></script>
    <script src="../../_static/thebelab-helper.js"></script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/learners/py_tabpfn';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.doubleml.org/dev/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Python: Basic Instrumental Variables calculation" href="../py_double_ml_basic_iv.html" />
    <link rel="prev" title="Python: Sensitivity Analysis for Causal ML" href="../py_double_ml_sensitivity_booking.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">Interested to learn more? We offer <a href='https://trainings.doubleml.org/'>DoubleML Trainings!</a></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../_static/logo_dark.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">DoubleML</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro/install.html">
     Install
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro/intro.html">
     Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../workflow/workflow.html">
     Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../guide/guide.html">
     User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
     Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/api.html">
     Python API
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://docs.doubleml.org/r/stable/">
     R API
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://docs.doubleml.org/doubleml-coverage/">
     Coverage Repository
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../literature/literature.html">
     Literature
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../../release/release.html">
     Release notes
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/DoubleML/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py/discussions" title="Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discussions</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro/install.html">
     Install
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../intro/intro.html">
     Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../workflow/workflow.html">
     Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../guide/guide.html">
     User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="../index.html">
     Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../api/api.html">
     Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://docs.doubleml.org/r/stable/">
     R API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://docs.doubleml.org/doubleml-coverage/">
     Coverage Repository
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../literature/literature.html">
     Literature
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../release/release.html">
     Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/DoubleML/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py/discussions" title="Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discussions</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><p class="logo" style="text-align:center;"><a href="../../index.html">
    <img class="logo" src="../../logo.png" alt="Logo" width="65%" height="65%">
</a></p>

<script type="text/javascript">
    // Change the logo depending on the theme
    var logo = document.querySelector('img.logo');
    var observer = new MutationObserver(function(mutations) {
        const dark = document.documentElement.dataset.theme == 'dark';
        if (dark) {
            logo.src = "../../logo_dark.png";
        } else {
            logo.src = "../../logo.png";
        }
    });
    observer.observe(document.documentElement, {attributes: true, attributeFilter: ['data-theme']});
</script></div>
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_basics.html">Python: Basics of Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_pension.html">Python: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_sensitivity.html">Python: Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_apo.html">Python: Average Potential Outcome (APO) Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_irm_vs_apo.html">Python: IRM and APO Model Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_lplr.html">Python: Log-Odds Effects for Logistic PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_plpr.html">Python: Static Panel Models with Fixed Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_ssm.html">Python: Sample Selection Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_optuna.html">Python: Hyperparametertuning with Optuna</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_learner.html">Python: Choice of learners</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_firststage.html">Python: First Stage and Causal Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_multiway_cluster.html">Python: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_sensitivity_booking.html">Python: Sensitivity Analysis for Causal ML</a></li>




<li class="toctree-l1 current active"><a class="current reference internal" href="#">Python: Causal Machine Learning with TabPFN</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_basic_iv.html">Python: Basic Instrumental Variables calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_robust_iv.html">Python: Confidence Intervals for Instrumental Variables Models That Are Robust to Weak Instruments</a></li>


<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_plm_irm_hetfx.html">Python: PLM and IRM for Multiple Treatments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_meets_flaml.html">DoubleML meets FLAML - How to tune learners automatically within <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_rdflex.html">Flexible Covariate Adjustment in Regression Discontinuity Designs (RDD)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_gate.html">Python: Group Average Treatment Effects (GATEs) for IRM models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_gate_plr.html">Python: Group Average Treatment Effects (GATEs) for PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_cate.html">Python: Conditional Average Treatment Effects (CATEs) for IRM models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_cate_plr.html">Python: Conditional Average Treatment Effects (CATEs) for PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_gate_sensitivity.html">Python: GATE Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_policy_tree.html">Python: Policy Learning with Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_pension_qte.html">Python: Impact of 401(k) on Financial Wealth (Quantile Effects)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_pq.html">Python: Potential Quantiles and Quantile Treatment Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../py_double_ml_cvar.html">Python: Conditional Value at Risk of potential outcomes</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../did/py_panel_simple.html">Python: Panel Data Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../did/py_panel.html">Python: Panel Data with Multiple Time Periods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../did/py_panel_data_example.html">Python: Real-Data Example for Multi-Period Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../did/py_rep_cs.html">Python: Repeated Cross-Sectional Data with Multiple Time Periods</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_basics.html">R: Basics of Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_pension.html">R: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_did.html">R: DoubleML for Difference-in-Differences</a></li>

<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_multiway_cluster.html">R: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_ssm.html">R: Sample Selection Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_basic_iv.html">R: Basic Instrumental Variables Calculation</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../R_double_ml_pipeline.html">R: Ensemble Learners and More with <code class="docutils literal notranslate"><span class="pre">mlr3pipelines</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="../double_ml_bonus_data.html">DML: Bonus Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../did/py_did.html">Python: Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="../did/py_did_pretest.html">Python: Difference-in-Differences Pre-Testing</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Python:...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
      <div class="admonition note">
    <p class="admonition-title">Note</p>
    <ul class="simple">

Download Jupyter notebook:
<a class="reference external" href="https://docs.doubleml.org/stable/examples/learners/py_tabpfn.ipynb">https://docs.doubleml.org/stable/examples/learners/py_tabpfn.ipynb</a>.

    </ul>
    </div><section id="Python:-Causal-Machine-Learning-with-TabPFN">
<h1>Python: Causal Machine Learning with TabPFN<a class="headerlink" href="#Python:-Causal-Machine-Learning-with-TabPFN" title="Link to this heading">#</a></h1>
<p>In this example, we demonstrate how to use <a class="reference external" href="https://github.com/automl/TabPFN">TabPFN</a> (Tabular Prior-data Fitted Network) as a machine learning estimator within the <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> framework for causal inference. We compare TabPFN’s performance against (untuned) traditional machine learning methods including Random Forest, Linear models, and LightGBM.</p>
<p>TabPFN is a foundation model specifically designed for tabular data that can perform inference without traditional training. It leverages a transformer architecture trained on a vast collection of synthetic tabular datasets, making it particularly effective for small to medium-sized datasets commonly encountered in causal inference applications.</p>
<p>We will estimate <strong>Average Potential Outcomes (APOs)</strong> using the <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.irm.DoubleMLAPOS.html">DoubleMLAPOS</a> model, which allows us to estimate:</p>
<div class="math notranslate nohighlight">
\[\theta_d = \mathbb{E}[Y(d)]\]</div>
<p>for different treatment levels <span class="math notranslate nohighlight">\(d\)</span> in a discrete treatment setting.</p>
<section id="Imports-and-Setup">
<h2>Imports and Setup<a class="headerlink" href="#Imports-and-Setup" title="Link to this heading">#</a></h2>
<p>We start by importing the necessary libraries. Note that TabPFN requires a separate installation, see <a class="reference external" href="https://docs.priorlabs.ai/overview">documentation</a>.</p>
<p>For GPU acceleration (recommended), ensure you have CUDA-enabled PyTorch installed. Instead you can also use the <a class="reference external" href="https://github.com/PriorLabs/tabpfn-client">TabPFN API Client</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.ensemble</span><span class="w"> </span><span class="kn">import</span> <span class="n">RandomForestRegressor</span><span class="p">,</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinearRegression</span><span class="p">,</span> <span class="n">LogisticRegression</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">lightgbm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">lgbm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tabpfn</span><span class="w"> </span><span class="kn">import</span> <span class="n">TabPFNRegressor</span><span class="p">,</span> <span class="n">TabPFNClassifier</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tabpfn.constants</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelVersion</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">doubleml</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">dml</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">doubleml.irm.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_irm_data_discrete_treatments</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Running on CPU*&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s2">&quot;tabpfn&quot;</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;.*does not have valid feature names.*&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Data-Generating-Process-(DGP)">
<h2>Data Generating Process (DGP)<a class="headerlink" href="#Data-Generating-Process-(DGP)" title="Link to this heading">#</a></h2>
<p>We generate synthetic data using DoubleML’s discrete treatment data generating process. This creates:</p>
<ul class="simple">
<li><p>A continuous treatment variable that is subsequently discretized into multiple levels <span class="math notranslate nohighlight">\(D\)</span></p></li>
<li><p>True individual treatment effects (ITEs) for comparison with our estimates</p></li>
<li><p>Covariates <span class="math notranslate nohighlight">\(X\)</span> that affect both treatment assignment <span class="math notranslate nohighlight">\(D\)</span> and outcomes <span class="math notranslate nohighlight">\(Y\)</span></p></li>
</ul>
<p>The discretization allows us to compare estimated Average Potential Outcomes (APOs) and Average Treatment Effects (ATEs) against their true values, providing a clear benchmark for evaluating different machine learning methods. For more details on the data generating process and the APO model, we refer to the <a class="reference external" href="https://docs.doubleml.org/stable/examples/py_double_ml_apo.html">APO Model Example Notebook</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Parameters</span>
<span class="n">n_obs</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">n_levels</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">linear</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">n_rep</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">data_apo</span> <span class="o">=</span> <span class="n">make_irm_data_discrete_treatments</span><span class="p">(</span><span class="n">n_obs</span><span class="o">=</span><span class="n">n_obs</span><span class="p">,</span> <span class="n">n_levels</span><span class="o">=</span><span class="n">n_levels</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="n">linear</span><span class="p">)</span>

<span class="n">y0</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;oracle_values&#39;</span><span class="p">][</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
<span class="n">cont_d</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;oracle_values&#39;</span><span class="p">][</span><span class="s1">&#39;cont_d&#39;</span><span class="p">]</span>
<span class="n">ite</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;oracle_values&#39;</span><span class="p">][</span><span class="s1">&#39;ite&#39;</span><span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
<span class="n">potential_level</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;oracle_values&#39;</span><span class="p">][</span><span class="s1">&#39;potential_level&#39;</span><span class="p">]</span>
<span class="n">level_bounds</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;oracle_values&#39;</span><span class="p">][</span><span class="s1">&#39;level_bounds&#39;</span><span class="p">]</span>

<span class="n">average_ites</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">apos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="n">mid_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_levels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">average_ites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">ite</span><span class="p">[</span><span class="n">d</span> <span class="o">==</span> <span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">apos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y0</span><span class="p">)</span> <span class="o">+</span> <span class="n">average_ites</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average treatment effects in each group:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">average_ites</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average potential outcomes in each group:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">apos</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Levels and their counts:</span><span class="se">\n</span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">d</span><span class="p">,</span><span class="w"> </span><span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Average treatment effects in each group:
[ 0.    1.46  6.67  9.31 10.36 10.47]

Average potential outcomes in each group:
[209.9  211.36 216.56 219.2  220.26 220.37]

Levels and their counts:
(array([0., 1., 2., 3., 4., 5.]), array([183, 165, 154, 162, 175, 161]))
</pre></div></div>
</div>
<section id="Visualizing-the-Treatment-Effect-Structure">
<h3>Visualizing the Treatment Effect Structure<a class="headerlink" href="#Visualizing-the-Treatment-Effect-Structure" title="Link to this heading">#</a></h3>
<p>To better understand our data, let’s visualize the relationship between the continuous treatment variable and the individual treatment effects, along with how the treatment is discretized into levels.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get a colorblind-friendly palette</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;cont_d&#39;</span><span class="p">:</span> <span class="n">cont_d</span><span class="p">,</span> <span class="s1">&#39;ite&#39;</span><span class="p">:</span> <span class="n">ite</span><span class="p">})</span>
<span class="n">df_sorted</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;cont_d&#39;</span><span class="p">)</span>

<span class="n">mid_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">n_levels</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_levels</span><span class="p">):</span>
    <span class="n">mid_points</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">level_bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">level_bounds</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>

<span class="n">df_apos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;mid_points&#39;</span><span class="p">:</span> <span class="n">mid_points</span><span class="p">,</span> <span class="s1">&#39;treatment effects&#39;</span><span class="p">:</span> <span class="n">apos</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">apos</span><span class="p">[</span><span class="mi">0</span><span class="p">]})</span>

<span class="c1"># Create the primary plot with scatter and line plots</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">sns</span><span class="o">.</span><span class="n">lineplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_sorted</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;cont_d&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;ite&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;ITE&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_apos</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;mid_points&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;treatment effects&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Grouped Treatment Effects&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax1</span><span class="p">)</span>

<span class="c1"># Add vertical dashed lines at level_bounds</span>
<span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">level_bounds</span><span class="p">:</span>
    <span class="n">ax1</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">bound</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;grey&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Grouped Effects vs. Continuous Treatment&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Continuous Treatment&#39;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Effects&#39;</span><span class="p">)</span>

<span class="c1"># Create a secondary y-axis for the histogram</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

<span class="c1"># Plot the histogram on the secondary y-axis</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="s1">&#39;cont_d&#39;</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="s1">&#39;cont_d&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">df_sorted</span><span class="p">[</span><span class="s1">&#39;cont_d&#39;</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>

<span class="c1"># Make sure the legend includes all plots</span>
<span class="n">lines</span><span class="p">,</span> <span class="n">labels</span> <span class="o">=</span> <span class="n">ax1</span><span class="o">.</span><span class="n">get_legend_handles_labels</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_learners_py_tabpfn_6_0.png" src="../../_images/examples_learners_py_tabpfn_6_0.png" />
</div>
</div>
</section>
<section id="Creating-the-DoubleMLData-Object">
<h3>Creating the DoubleMLData Object<a class="headerlink" href="#Creating-the-DoubleMLData-Object" title="Link to this heading">#</a></h3>
<p>As with all DoubleML models, we need to create a <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.data.DoubleMLData.html">DoubleMLData</a> object to properly structure our data for causal inference. This object handles the separation of outcome variables, treatment variables, and covariates.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
<span class="n">d</span> <span class="o">=</span> <span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span>
<span class="n">df_apo</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">y</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">x</span><span class="p">)),</span>
    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data_apo</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span>
<span class="p">)</span>

<span class="n">dml_data</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLData</span><span class="p">(</span><span class="n">df_apo</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;d&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLData Object ==================

------------------ Data summary      ------------------
Outcome variable: y
Treatment variable(s): [&#39;d&#39;]
Covariates: [&#39;x0&#39;, &#39;x1&#39;, &#39;x2&#39;, &#39;x3&#39;, &#39;x4&#39;]
Instrument variable(s): None
No. Observations: 1000

------------------ DataFrame info    ------------------
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 1000 entries, 0 to 999
Columns: 7 entries, y to x4
dtypes: float64(7)
memory usage: 54.8 KB

</pre></div></div>
</div>
</section>
</section>
<section id="DoubleML-with-TabPFN">
<h2>DoubleML with TabPFN<a class="headerlink" href="#DoubleML-with-TabPFN" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://github.com/PriorLabs/tabpfn">TabPFN package</a> integrates seamlessly with the <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> framework for causal inference tasks.</p>
<p>For fitting <a class="reference external" href="https://docs.doubleml.org/stable/guide/models.html#average-potential-outcomes-apos">average potential outcome models</a>, the <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code> interface requires to specify the <code class="docutils literal notranslate"><span class="pre">ml_g</span></code> and <code class="docutils literal notranslate"><span class="pre">ml_m</span></code> learners:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ml_g</span></code>: A regressor for the outcome model <span class="math notranslate nohighlight">\(g_0(D,X) = \mathbb{E}[Y|X,D]\)</span></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ml_m</span></code>: A classifier for the propensity score model <span class="math notranslate nohighlight">\(m_{0,d}(X) = \mathbb{E}[1\{D=d\}|X]\)</span></p></li>
</ul>
<p><strong>Note</strong>: TabPFN works best with CUDA acceleration. If CUDA is not available, it will fall back to CPU computation. Instead you can use <a class="reference external" href="https://github.com/PriorLabs/tabpfn-client">TabPFN API Client</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;cpu&#39;</span>
<span class="n">ml_g</span> <span class="o">=</span> <span class="n">TabPFNRegressor</span><span class="o">.</span><span class="n">create_default_for_version</span><span class="p">(</span><span class="n">ModelVersion</span><span class="o">.</span><span class="n">V2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">ml_m</span> <span class="o">=</span> <span class="n">TabPFNClassifier</span><span class="o">.</span><span class="n">create_default_for_version</span><span class="p">(</span><span class="n">ModelVersion</span><span class="o">.</span><span class="n">V2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>To model average potential outcomes, we initialize the <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.irm.DoubleMLAPOS.html#doubleml.irm.DoubleMLAPOS">DoubleMLAPOS</a> object with the specified machine learning methods and treatment levels.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">treatment_levels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">dml_data</span><span class="o">.</span><span class="n">d</span><span class="p">)</span>
<span class="n">dml_obj</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLAPOS</span><span class="p">(</span>
    <span class="n">dml_data</span><span class="p">,</span>
    <span class="n">ml_g</span><span class="o">=</span><span class="n">ml_g</span><span class="p">,</span>
    <span class="n">ml_m</span><span class="o">=</span><span class="n">ml_m</span><span class="p">,</span>
    <span class="n">treatment_levels</span><span class="o">=</span><span class="n">treatment_levels</span><span class="p">,</span>
    <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>As usual, you can estimate the parameters by calling the <code class="docutils literal notranslate"><span class="pre">fit</span></code> method on the <code class="docutils literal notranslate"><span class="pre">dml_obj</span></code> instance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_obj</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_obj</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLAPOS Object ==================

------------------ Fit summary       ------------------
           coef   std err           t  P&gt;|t|       2.5 %      97.5 %
0.0  209.309952  1.208485  173.200225    0.0  206.941364  211.678540
1.0  210.984368  1.359622  155.178751    0.0  208.319559  213.649177
2.0  216.506080  1.265888  171.030964    0.0  214.024985  218.987175
3.0  219.259184  1.316197  166.585402    0.0  216.679486  221.838883
4.0  219.891299  1.279140  171.905612    0.0  217.384232  222.398367
5.0  219.380538  1.195920  183.440790    0.0  217.036577  221.724498
</pre></div></div>
</div>
</section>
<section id="Machine-Learning-Methods-Comparison">
<h2>Machine Learning Methods Comparison<a class="headerlink" href="#Machine-Learning-Methods-Comparison" title="Link to this heading">#</a></h2>
<p>We compare four different machine learning approaches for estimating the nuisance functions in our causal model:</p>
<ul class="simple">
<li><p><em>Random Forest</em></p></li>
<li><p><em>Linear Models</em></p></li>
<li><p><em>Boosted Trees (LightGBM)</em></p></li>
<li><p><em>Foundation Model (TabPFN)</em></p></li>
</ul>
<p>Remark that we did not tune the machine learning models in detail.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rf_arguments</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="s1">&#39;min_samples_leaf&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span>
<span class="p">}</span>

<span class="n">lgbm_arguments</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s1">&#39;min_data_in_leaf&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
    <span class="s1">&#39;lambda_l1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;lambda_l2&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s1">&#39;random_state&#39;</span><span class="p">:</span> <span class="mi">42</span><span class="p">,</span>
    <span class="s1">&#39;verbose&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learner_dict</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;RandomForest&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ml_g&#39;</span><span class="p">:</span> <span class="n">RandomForestRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">rf_arguments</span><span class="p">),</span>
        <span class="s1">&#39;ml_m&#39;</span><span class="p">:</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">rf_arguments</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s1">&#39;Linear&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ml_g&#39;</span><span class="p">:</span> <span class="n">LinearRegression</span><span class="p">(),</span>
        <span class="s1">&#39;ml_m&#39;</span><span class="p">:</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s1">&#39;LightGBM&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ml_g&#39;</span><span class="p">:</span> <span class="n">lgbm</span><span class="o">.</span><span class="n">LGBMRegressor</span><span class="p">(</span><span class="o">**</span><span class="n">lgbm_arguments</span><span class="p">),</span>
        <span class="s1">&#39;ml_m&#39;</span><span class="p">:</span> <span class="n">lgbm</span><span class="o">.</span><span class="n">LGBMClassifier</span><span class="p">(</span><span class="o">**</span><span class="n">lgbm_arguments</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s1">&#39;TabPFN&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ml_g&#39;</span><span class="p">:</span> <span class="n">TabPFNRegressor</span><span class="o">.</span><span class="n">create_default_for_version</span><span class="p">(</span><span class="n">ModelVersion</span><span class="o">.</span><span class="n">V2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">),</span>
        <span class="s1">&#39;ml_m&#39;</span><span class="p">:</span> <span class="n">TabPFNClassifier</span><span class="o">.</span><span class="n">create_default_for_version</span><span class="p">(</span><span class="n">ModelVersion</span><span class="o">.</span><span class="n">V2</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<section id="Estimation-of-Average-Potential-Outcomes">
<h3>Estimation of Average Potential Outcomes<a class="headerlink" href="#Estimation-of-Average-Potential-Outcomes" title="Link to this heading">#</a></h3>
<p>Now we estimate the Average Potential Outcomes (APOs) for each treatment level using all four machine learning methods. We use the <a class="reference external" href="https://docs.doubleml.org/dev/api/generated/doubleml.irm.DoubleMLAPOS.html">DoubleMLAPOS</a> class, which:</p>
<ol class="arabic simple">
<li><p><strong>Estimates nuisance functions</strong>: Uses cross-fitting to estimate <span class="math notranslate nohighlight">\(g_0(D,X)\)</span> and <span class="math notranslate nohighlight">\(m_{0,d}(X)\)</span></p></li>
<li><p><strong>Computes APO estimates</strong>: Uses the efficient influence function to estimate <span class="math notranslate nohighlight">\(\theta_d = \mathbb{E}[Y(d)]\)</span></p></li>
<li><p><strong>Provides confidence intervals</strong>: Based on the asymptotic distribution of the estimator</p></li>
</ol>
<p>We also compute <strong>causal contrasts</strong> (Average Treatment Effects) as differences between treatment levels and the reference level (no treatment).</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">reference_level</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">apo_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">causal_contrast_results</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">model_list</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">learner_name</span><span class="p">,</span> <span class="n">learner_pair</span> <span class="ow">in</span> <span class="n">learner_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Fitting model: </span><span class="si">{</span><span class="n">learner_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;=&#39;</span><span class="o">*</span><span class="mi">60</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">dml_obj</span> <span class="o">=</span> <span class="n">dml</span><span class="o">.</span><span class="n">DoubleMLAPOS</span><span class="p">(</span>
        <span class="n">dml_data</span><span class="p">,</span>
        <span class="n">learner_pair</span><span class="p">[</span><span class="s1">&#39;ml_g&#39;</span><span class="p">],</span>
        <span class="n">learner_pair</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">],</span>
        <span class="n">treatment_levels</span><span class="o">=</span><span class="n">treatment_levels</span><span class="p">,</span>
        <span class="n">n_rep</span><span class="o">=</span><span class="n">n_rep</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dml_obj</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">end_time</span> <span class="o">-</span> <span class="n">start_time</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">learner_name</span><span class="si">}</span><span class="s2"> fitted in </span><span class="si">{</span><span class="n">elapsed_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds&quot;</span><span class="p">)</span>

    <span class="n">model_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dml_obj</span><span class="p">)</span>

    <span class="c1"># APO confidence intervals</span>
    <span class="n">ci_pointwise</span> <span class="o">=</span> <span class="n">dml_obj</span><span class="o">.</span><span class="n">confint</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    <span class="n">df_apos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;learner&#39;</span><span class="p">:</span> <span class="n">learner_name</span><span class="p">,</span>
        <span class="s1">&#39;treatment_level&#39;</span><span class="p">:</span> <span class="n">treatment_levels</span><span class="p">,</span>
        <span class="s1">&#39;apo&#39;</span><span class="p">:</span> <span class="n">dml_obj</span><span class="o">.</span><span class="n">coef</span><span class="p">,</span>
        <span class="s1">&#39;ci_lower&#39;</span><span class="p">:</span> <span class="n">ci_pointwise</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span>
        <span class="s1">&#39;ci_upper&#39;</span><span class="p">:</span> <span class="n">ci_pointwise</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]}</span>
    <span class="p">)</span>
    <span class="n">apo_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_apos</span><span class="p">)</span>

    <span class="c1"># ATE confidence intervals</span>
    <span class="n">causal_contrast_model</span> <span class="o">=</span> <span class="n">dml_obj</span><span class="o">.</span><span class="n">causal_contrast</span><span class="p">(</span><span class="n">reference_levels</span><span class="o">=</span><span class="n">reference_level</span><span class="p">)</span>
    <span class="n">ates</span> <span class="o">=</span> <span class="n">causal_contrast_model</span><span class="o">.</span><span class="n">thetas</span>
    <span class="n">ci_ates</span> <span class="o">=</span> <span class="n">causal_contrast_model</span><span class="o">.</span><span class="n">confint</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="mf">0.95</span><span class="p">)</span>
    <span class="n">df_ates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
        <span class="s1">&#39;learner&#39;</span><span class="p">:</span> <span class="n">learner_name</span><span class="p">,</span>
        <span class="s1">&#39;treatment_level&#39;</span><span class="p">:</span> <span class="n">treatment_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span>
        <span class="s1">&#39;ate&#39;</span><span class="p">:</span> <span class="n">ates</span><span class="p">,</span>
        <span class="s1">&#39;ci_lower&#39;</span><span class="p">:</span> <span class="n">ci_ates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
        <span class="s1">&#39;ci_upper&#39;</span><span class="p">:</span> <span class="n">ci_ates</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    <span class="p">})</span>
    <span class="n">causal_contrast_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df_ates</span><span class="p">)</span>

<span class="c1"># Combine all results</span>
<span class="n">df_all_apos</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">apo_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_all_ates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">causal_contrast_results</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">df_all_ates</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

============================================================
Fitting model: RandomForest
============================================================
RandomForest fitted in 46.82 seconds

============================================================
Fitting model: Linear
============================================================
Linear fitted in 0.11 seconds

============================================================
Fitting model: LightGBM
============================================================
LightGBM fitted in 3.12 seconds

============================================================
Fitting model: TabPFN
============================================================
TabPFN fitted in 183.38 seconds
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>learner</th>
      <th>treatment_level</th>
      <th>ate</th>
      <th>ci_lower</th>
      <th>ci_upper</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>RandomForest</td>
      <td>1.0</td>
      <td>2.253828</td>
      <td>-2.699097</td>
      <td>7.206752</td>
    </tr>
    <tr>
      <th>1</th>
      <td>RandomForest</td>
      <td>2.0</td>
      <td>7.498048</td>
      <td>2.237756</td>
      <td>12.758340</td>
    </tr>
    <tr>
      <th>2</th>
      <td>RandomForest</td>
      <td>3.0</td>
      <td>11.756539</td>
      <td>6.289006</td>
      <td>17.224073</td>
    </tr>
    <tr>
      <th>3</th>
      <td>RandomForest</td>
      <td>4.0</td>
      <td>7.678953</td>
      <td>2.767027</td>
      <td>12.590880</td>
    </tr>
    <tr>
      <th>4</th>
      <td>RandomForest</td>
      <td>5.0</td>
      <td>6.865101</td>
      <td>0.994615</td>
      <td>12.735587</td>
    </tr>
    <tr>
      <th>5</th>
      <td>Linear</td>
      <td>1.0</td>
      <td>3.932233</td>
      <td>-1.962948</td>
      <td>9.827414</td>
    </tr>
    <tr>
      <th>6</th>
      <td>Linear</td>
      <td>2.0</td>
      <td>8.720447</td>
      <td>3.747057</td>
      <td>13.693837</td>
    </tr>
    <tr>
      <th>7</th>
      <td>Linear</td>
      <td>3.0</td>
      <td>10.625888</td>
      <td>6.871080</td>
      <td>14.380695</td>
    </tr>
    <tr>
      <th>8</th>
      <td>Linear</td>
      <td>4.0</td>
      <td>11.339177</td>
      <td>7.917038</td>
      <td>14.761317</td>
    </tr>
    <tr>
      <th>9</th>
      <td>Linear</td>
      <td>5.0</td>
      <td>8.254858</td>
      <td>4.324910</td>
      <td>12.184806</td>
    </tr>
    <tr>
      <th>10</th>
      <td>LightGBM</td>
      <td>1.0</td>
      <td>1.276002</td>
      <td>-4.056172</td>
      <td>6.608177</td>
    </tr>
    <tr>
      <th>11</th>
      <td>LightGBM</td>
      <td>2.0</td>
      <td>6.166088</td>
      <td>1.817977</td>
      <td>10.514199</td>
    </tr>
    <tr>
      <th>12</th>
      <td>LightGBM</td>
      <td>3.0</td>
      <td>10.974491</td>
      <td>6.011016</td>
      <td>15.937967</td>
    </tr>
    <tr>
      <th>13</th>
      <td>LightGBM</td>
      <td>4.0</td>
      <td>9.726078</td>
      <td>5.797966</td>
      <td>13.654191</td>
    </tr>
    <tr>
      <th>14</th>
      <td>LightGBM</td>
      <td>5.0</td>
      <td>8.085730</td>
      <td>3.570351</td>
      <td>12.601109</td>
    </tr>
    <tr>
      <th>15</th>
      <td>TabPFN</td>
      <td>1.0</td>
      <td>1.621060</td>
      <td>0.289549</td>
      <td>2.952572</td>
    </tr>
    <tr>
      <th>16</th>
      <td>TabPFN</td>
      <td>2.0</td>
      <td>7.064673</td>
      <td>6.089229</td>
      <td>8.040118</td>
    </tr>
    <tr>
      <th>17</th>
      <td>TabPFN</td>
      <td>3.0</td>
      <td>10.021728</td>
      <td>8.609947</td>
      <td>11.433509</td>
    </tr>
    <tr>
      <th>18</th>
      <td>TabPFN</td>
      <td>4.0</td>
      <td>10.454991</td>
      <td>9.231879</td>
      <td>11.678104</td>
    </tr>
    <tr>
      <th>19</th>
      <td>TabPFN</td>
      <td>5.0</td>
      <td>9.751194</td>
      <td>8.762049</td>
      <td>10.740339</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</section>
<section id="Visualizing-Average-Potential-Outcomes">
<h3>Visualizing Average Potential Outcomes<a class="headerlink" href="#Visualizing-Average-Potential-Outcomes" title="Link to this heading">#</a></h3>
<p>Let’s compare the estimated APOs across all methods with their true values. The plot shows:</p>
<ul class="simple">
<li><p><strong>Estimated APOs</strong>: Point estimates with 95% confidence intervals for each method</p></li>
<li><p><strong>True APOs</strong>: Red horizontal lines showing the oracle values</p></li>
<li><p><strong>Treatment levels</strong>: Different dosage levels of the treatment (0 = no treatment)</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot APOs and 95% CIs for all models</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">)</span>
<span class="n">learners</span> <span class="o">=</span> <span class="n">df_all_apos</span><span class="p">[</span><span class="s1">&#39;learner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">n_learners</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">learners</span><span class="p">)</span>
<span class="n">jitter_strength</span> <span class="o">=</span> <span class="mf">0.12</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">learner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learners</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_all_apos</span><span class="p">[</span><span class="n">df_all_apos</span><span class="p">[</span><span class="s1">&#39;learner&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">learner</span><span class="p">]</span>
    <span class="c1"># Jitter x positions for each learner</span>
    <span class="n">jitter</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_learners</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">jitter_strength</span>
    <span class="n">x_jittered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment_level&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">jitter</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
        <span class="n">x_jittered</span><span class="p">,</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;apo&#39;</span><span class="p">],</span>
        <span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;apo&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;apo&#39;</span><span class="p">]],</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
        <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">capthick</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">ecolor</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">learner</span><span class="si">}</span><span class="s2"> APO ±95% CI&quot;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

<span class="c1"># Get treatment levels for proper line positioning</span>
<span class="n">treatment_levels_plot</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_all_apos</span><span class="p">[</span><span class="s1">&#39;treatment_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">x_range</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">total_width</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Add true APOs as red horizontal lines</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">treatment_levels_plot</span><span class="p">):</span>
    <span class="c1"># Center each line around its treatment level with a reasonable width</span>
    <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.6</span>  <span class="c1"># Width of each horizontal line relative to treatment level spacing</span>
    <span class="n">x_center</span> <span class="o">=</span> <span class="n">level</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">-</span> <span class="n">line_width</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">x_end</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">line_width</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># Convert to relative coordinates (0-1) for xmin/xmax</span>
    <span class="n">xmin_rel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">x_start</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">total_width</span><span class="p">)</span>
    <span class="n">xmax_rel</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">total_width</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">apos</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">xmin</span><span class="o">=</span><span class="n">xmin_rel</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax_rel</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True APO&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimated APO and 95% Confidence Interval by Treatment Level&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Treatment Level&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Average Potential Outcome (APO)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_all_apos</span><span class="p">[</span><span class="s1">&#39;treatment_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_learners_py_tabpfn_21_0.png" src="../../_images/examples_learners_py_tabpfn_21_0.png" />
</div>
</div>
<p>It is quite clear to see, that without tuning the hyperparameters of the models, the TabPFN model achieves the best performance (smallest confidence intervals) across all treatment levels.</p>
</section>
<section id="Visualizing-Average-Treatment-Effects">
<h3>Visualizing Average Treatment Effects<a class="headerlink" href="#Visualizing-Average-Treatment-Effects" title="Link to this heading">#</a></h3>
<p>Now let’s examine the Average Treatment Effects (ATEs), which represent the causal effect of each treatment level compared to the reference level (no treatment). The ATE for treatment level <span class="math notranslate nohighlight">\(d\)</span> is defined as:</p>
<div class="math notranslate nohighlight">
\[\text{ATE}_d = \mathbb{E}[Y(d)] - \mathbb{E}[Y(0)]\]</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Plot ATEs and 95% CIs for all models</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">)</span>
<span class="n">learners</span> <span class="o">=</span> <span class="n">df_all_ates</span><span class="p">[</span><span class="s1">&#39;learner&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="n">n_learners</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">learners</span><span class="p">)</span>
<span class="n">jitter_strength</span> <span class="o">=</span> <span class="mf">0.12</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">learner</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learners</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_all_ates</span><span class="p">[</span><span class="n">df_all_ates</span><span class="p">[</span><span class="s1">&#39;learner&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">learner</span><span class="p">]</span>
    <span class="c1"># Jitter x positions for each learner</span>
    <span class="n">jitter</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="p">(</span><span class="n">n_learners</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">jitter_strength</span>
    <span class="n">x_jittered</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;treatment_level&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">jitter</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span>
        <span class="n">x_jittered</span><span class="p">,</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">],</span>
        <span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ci_lower&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ci_upper&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;ate&#39;</span><span class="p">]],</span>
        <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span>
        <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
        <span class="n">capthick</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">ecolor</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span>
        <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">palette</span><span class="p">)],</span>
        <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">learner</span><span class="si">}</span><span class="s2"> ATE ±95% CI&quot;</span><span class="p">,</span>
        <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span>
    <span class="p">)</span>

<span class="c1"># Get treatment levels for proper line positioning</span>
<span class="n">treatment_levels_plot</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df_all_ates</span><span class="p">[</span><span class="s1">&#39;treatment_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<span class="n">x_range</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">()</span>
<span class="n">total_width</span> <span class="o">=</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Add true ATEs as red horizontal lines</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">treatment_levels_plot</span><span class="p">):</span>
    <span class="c1"># Center each line around its treatment level with a reasonable width</span>
    <span class="n">line_width</span> <span class="o">=</span> <span class="mf">0.6</span>  <span class="c1"># Width of each horizontal line relative to treatment level spacing</span>
    <span class="n">x_center</span> <span class="o">=</span> <span class="n">level</span>
    <span class="n">x_start</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">-</span> <span class="n">line_width</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">x_end</span> <span class="o">=</span> <span class="n">x_center</span> <span class="o">+</span> <span class="n">line_width</span><span class="o">/</span><span class="mi">2</span>

    <span class="c1"># Convert to relative coordinates (0-1) for xmin/xmax</span>
    <span class="n">xmin_rel</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">x_start</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">total_width</span><span class="p">)</span>
    <span class="n">xmax_rel</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">x_end</span> <span class="o">-</span> <span class="n">x_range</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">total_width</span><span class="p">)</span>

    <span class="c1"># Use average_ites[level] for the true ATE (treatment levels start from 1 for ATEs)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">average_ites</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">xmin</span><span class="o">=</span><span class="n">xmin_rel</span><span class="p">,</span> <span class="n">xmax</span><span class="o">=</span><span class="n">xmax_rel</span><span class="p">,</span>
                <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;True ATE&#39;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Estimated ATE and 95% Confidence Interval by Treatment Level&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Treatment Level (vs. 0)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;ATE&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">df_all_ates</span><span class="p">[</span><span class="s1">&#39;treatment_level&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_learners_py_tabpfn_24_0.png" src="../../_images/examples_learners_py_tabpfn_24_0.png" />
</div>
</div>
</section>
<section id="Model-Performance-Evaluation">
<h3>Model Performance Evaluation<a class="headerlink" href="#Model-Performance-Evaluation" title="Link to this heading">#</a></h3>
<p>To understand why different methods perform differently, let’s examine the performance of the underlying machine learning models used for the nuisance functions. DoubleML provides access to performance metrics for each component:</p>
<ul class="simple">
<li><p><strong>RMSE g0</strong>: Root Mean Square Error for the outcome model when treatment <span class="math notranslate nohighlight">\(D \neq d\)</span></p></li>
<li><p><strong>RMSE g1</strong>: Root Mean Square Error for the outcome model when treatment <span class="math notranslate nohighlight">\(D = d\)</span></p></li>
<li><p><strong>LogLoss m</strong>: Logarithmic loss for the propensity score model (treatment assignment prediction)</p></li>
</ul>
<p>Better performance on these nuisance functions typically translates to more accurate causal estimates.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a comprehensive table with RMSE for g0, g1 and log loss for all learners and treatment levels</span>
<span class="n">performance_results</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">idx_learner</span><span class="p">,</span> <span class="n">learner_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">learner_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="k">for</span> <span class="n">idx_treat</span><span class="p">,</span> <span class="n">treatment_level</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">treatment_levels</span><span class="p">):</span>
        <span class="c1"># Get the specific model for this learner and treatment level</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">model_list</span><span class="p">[</span><span class="n">idx_learner</span><span class="p">]</span><span class="o">.</span><span class="n">modellist</span><span class="p">[</span><span class="n">idx_treat</span><span class="p">]</span>

        <span class="c1"># Extract performance metrics from nuisance_loss</span>
        <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">nuisance_loss</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># RMSE for g0 (outcome model for treatment level != d)</span>
            <span class="n">rmse_g0</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nuisance_loss</span><span class="p">[</span><span class="s1">&#39;ml_g_d_lvl0&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># RMSE for g1 (outcome model for treatment level = d)</span>
            <span class="n">rmse_g1</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nuisance_loss</span><span class="p">[</span><span class="s1">&#39;ml_g_d_lvl1&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Log loss for propensity score model</span>
            <span class="n">logloss_m</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">nuisance_loss</span><span class="p">[</span><span class="s1">&#39;ml_m&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rmse_g0</span> <span class="o">=</span> <span class="n">rmse_g1</span> <span class="o">=</span> <span class="n">logloss_m</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Store results</span>
        <span class="n">performance_results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;Learner&#39;</span><span class="p">:</span> <span class="n">learner_name</span><span class="p">,</span>
            <span class="s1">&#39;Treatment_Level&#39;</span><span class="p">:</span> <span class="n">treatment_level</span><span class="p">,</span>
            <span class="s1">&#39;RMSE_g0&#39;</span><span class="p">:</span> <span class="n">rmse_g0</span><span class="p">,</span>
            <span class="s1">&#39;RMSE_g1&#39;</span><span class="p">:</span> <span class="n">rmse_g1</span><span class="p">,</span>
            <span class="s1">&#39;LogLoss_m&#39;</span><span class="p">:</span> <span class="n">logloss_m</span>
        <span class="p">})</span>

<span class="c1"># Create DataFrame and display as a nicely formatted table</span>
<span class="n">df_performance</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">performance_results</span><span class="p">)</span>

<span class="c1"># Round values for better readability</span>
<span class="n">df_performance</span><span class="p">[</span><span class="s1">&#39;RMSE_g0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_performance</span><span class="p">[</span><span class="s1">&#39;RMSE_g0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">df_performance</span><span class="p">[</span><span class="s1">&#39;RMSE_g1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_performance</span><span class="p">[</span><span class="s1">&#39;RMSE_g1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="n">df_performance</span><span class="p">[</span><span class="s1">&#39;LogLoss_m&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_performance</span><span class="p">[</span><span class="s1">&#39;LogLoss_m&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">RMSE g0 by Learner and Treatment Level:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">pivot_rmse_g0</span> <span class="o">=</span> <span class="n">df_performance</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Learner&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Treatment_Level&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;RMSE_g0&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pivot_rmse_g0</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">RMSE g1 by Learner and Treatment Level:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">pivot_rmse_g1</span> <span class="o">=</span> <span class="n">df_performance</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Learner&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Treatment_Level&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;RMSE_g1&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pivot_rmse_g1</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">LogLoss m by Learner and Treatment Level:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="mi">80</span><span class="p">)</span>
<span class="n">pivot_logloss</span> <span class="o">=</span> <span class="n">df_performance</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s1">&#39;Learner&#39;</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;Treatment_Level&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;LogLoss_m&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">pivot_logloss</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


RMSE g0 by Learner and Treatment Level:
================================================================================
Treatment_Level      0.0      1.0      2.0      3.0      4.0      5.0
Learner
LightGBM         16.6043  12.6722  16.4420  16.1879  16.1063  16.3937
Linear           21.4232  17.3711  20.5572  21.3341  21.3044  21.3389
RandomForest     17.8429  14.2921  17.1360  17.0445  17.4103  17.7712
TabPFN            9.3977   2.8226   9.5238   9.4965   9.2663   9.2945


RMSE g1 by Learner and Treatment Level:
================================================================================
Treatment_Level      0.0      1.0      2.0      3.0      4.0      5.0
Learner
LightGBM         16.2032  30.3334  18.8350  16.5337  15.6930  13.1095
Linear           16.3087  29.3359  21.6232  17.8452  16.6807  14.6180
RandomForest     21.0889  31.6349  22.8979  20.8461  19.2861  17.7393
TabPFN            3.9209  15.6921   4.9981   7.4276   5.9365   3.2138


LogLoss m by Learner and Treatment Level:
================================================================================
Treatment_Level     0.0     1.0     2.0     3.0     4.0     5.0
Learner
LightGBM         0.4996  0.4506  0.4417  0.4663  0.4782  0.4302
Linear           0.4770  0.4391  0.4247  0.4450  0.4637  0.4234
RandomForest     0.5011  0.4401  0.4235  0.4649  0.4766  0.4344
TabPFN           0.4772  0.4348  0.4286  0.4481  0.4652  0.4218
</pre></div></div>
</div>
</section>
<section id="Performance-Summary-and-Insights">
<h3>Performance Summary and Insights<a class="headerlink" href="#Performance-Summary-and-Insights" title="Link to this heading">#</a></h3>
<p>Let’s summarize the average performance across all treatment levels to identify the best-performing methods:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Best performing learners for each metric</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Best performing learners (averaged across treatment levels):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span>

<span class="c1"># Calculate average metrics across treatment levels for each learner</span>
<span class="n">summary_stats</span> <span class="o">=</span> <span class="n">df_performance</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Learner&#39;</span><span class="p">)[[</span><span class="s1">&#39;RMSE_g0&#39;</span><span class="p">,</span> <span class="s1">&#39;RMSE_g1&#39;</span><span class="p">,</span> <span class="s1">&#39;LogLoss_m&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_stats</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>

Best performing learners (averaged across treatment levels):
------------------------------------------------------------
              RMSE_g0  RMSE_g1  LogLoss_m
Learner
LightGBM      15.7344  18.4513     0.4611
Linear        20.5548  19.4020     0.4455
RandomForest  16.9162  22.2489     0.4568
TabPFN         8.3002   6.8648     0.4460
</pre></div></div>
</div>
</section>
</section>
<section id="Key-Takeaways">
<h2>Key Takeaways<a class="headerlink" href="#Key-Takeaways" title="Link to this heading">#</a></h2>
<p>This example demonstrates several important findings about using TabPFN for causal inference.</p>
<ul class="simple">
<li><p><strong>Outcome modeling</strong>: TabPFN significantly outperforms traditional methods for both g0 and g1 functions, with much lower RMSE values</p></li>
<li><p><strong>Causal estimates</strong>: The superior nuisance function performance translates to more accurate APO and ATE estimates</p></li>
<li><p><strong>No hyperparameter tuning</strong>: TabPFN achieves these results without any model-specific tuning</p></li>
</ul>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../py_double_ml_sensitivity_booking.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Python: Sensitivity Analysis for Causal ML</p>
      </div>
    </a>
    <a class="right-next"
       href="../py_double_ml_basic_iv.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Python: Basic Instrumental Variables calculation</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Imports-and-Setup">Imports and Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Data-Generating-Process-(DGP)">Data Generating Process (DGP)</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Visualizing-the-Treatment-Effect-Structure">Visualizing the Treatment Effect Structure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Creating-the-DoubleMLData-Object">Creating the DoubleMLData Object</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#DoubleML-with-TabPFN">DoubleML with TabPFN</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Machine-Learning-Methods-Comparison">Machine Learning Methods Comparison</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Estimation-of-Average-Potential-Outcomes">Estimation of Average Potential Outcomes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Visualizing-Average-Potential-Outcomes">Visualizing Average Potential Outcomes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Visualizing-Average-Treatment-Effects">Visualizing Average Treatment Effects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Model-Performance-Evaluation">Model Performance Evaluation</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Performance-Summary-and-Insights">Performance Summary and Insights</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Key-Takeaways">Key Takeaways</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/DoubleML/doubleml-docs/edit/dev/doc/examples/learners/py_tabpfn.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/examples/learners/py_tabpfn.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, Bach, P., Chernozhukov, V., Klaassen, S., Kurz, M. S., and Spindler, M..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>