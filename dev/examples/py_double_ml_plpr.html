
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Python: Static Panel Models with Fixed Effects &#8212; DoubleML  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyter-sphinx.css" />
    <link rel="stylesheet" type="text/css" href="../_static/thebelab.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />
    <link rel="stylesheet" type="text/css" href="../_static/css/custom.css?v=c49bcd98" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=1ecd1175"></script>
    <script src="../_static/thebelab-helper.js"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'examples/py_double_ml_plpr';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.4';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://docs.doubleml.org/dev/_static/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'dev';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Python: Sample Selection Models" href="py_double_ml_ssm.html" />
    <link rel="prev" title="Python: Log-Odds Effects for Logistic PLR models" href="py_double_ml_lplr.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>
<aside class="bd-header-announcement" aria-label="Announcement">
  <div class="bd-header-announcement__content">Interested to learn more? We offer <a href='https://trainings.doubleml.org/'>DoubleML Trainings!</a></div>
</aside>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class=" navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../_static/logo_dark.png" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">DoubleML</p>
  
</a></div>
    
  </div>
  
  <div class=" navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/install.html">
     Install
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/intro.html">
     Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../workflow/workflow.html">
     Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../guide/guide.html">
     User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
     Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/api.html">
     Python API
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://docs.doubleml.org/r/stable/">
     R API
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://docs.doubleml.org/doubleml-coverage/">
     Coverage Repository
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../literature/literature.html">
     Literature
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-internal" href="../release/release.html">
     Release notes
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/DoubleML/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py/discussions" title="Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discussions</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/install.html">
     Install
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../intro/intro.html">
     Getting Started
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../workflow/workflow.html">
     Workflow
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../guide/guide.html">
     User Guide
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
     Examples
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../api/api.html">
     Python API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://docs.doubleml.org/r/stable/">
     R API
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://docs.doubleml.org/doubleml-coverage/">
     Coverage Repository
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../literature/literature.html">
     Literature
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release/release.html">
     Release notes
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/DoubleML/" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-python fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DoubleML/doubleml-for-py/discussions" title="Discussions" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-solid fa-comments fa-lg" aria-hidden="true"></i>
            <span class="sr-only">Discussions</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item"><p class="logo" style="text-align:center;"><a href="../index.html">
    <img class="logo" src="../logo.png" alt="Logo" width="65%" height="65%">
</a></p>

<script type="text/javascript">
    // Change the logo depending on the theme
    var logo = document.querySelector('img.logo');
    var observer = new MutationObserver(function(mutations) {
        const dark = document.documentElement.dataset.theme == 'dark';
        if (dark) {
            logo.src = "../logo_dark.png";
        } else {
            logo.src = "../logo.png";
        }
    });
    observer.observe(document.documentElement, {attributes: true, attributeFilter: ['data-theme']});
</script></div>
        <div class="sidebar-primary-item">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_basics.html">Python: Basics of Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pension.html">Python: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_sensitivity.html">Python: Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_apo.html">Python: Average Potential Outcome (APO) Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_irm_vs_apo.html">Python: IRM and APO Model Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_lplr.html">Python: Log-Odds Effects for Logistic PLR models</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Python: Static Panel Models with Fixed Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_ssm.html">Python: Sample Selection Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="learners/py_optuna.html">Python: Hyperparametertuning with Optuna</a></li>
<li class="toctree-l1"><a class="reference internal" href="learners/py_learner.html">Python: Choice of learners</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_firststage.html">Python: First Stage and Causal Estimation</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_multiway_cluster.html">Python: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_sensitivity_booking.html">Python: Sensitivity Analysis for Causal ML</a></li>




<li class="toctree-l1"><a class="reference internal" href="learners/py_tabpfn.html">Python: Causal Machine Learning with TabPFN</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_basic_iv.html">Python: Basic Instrumental Variables calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_robust_iv.html">Python: Confidence Intervals for Instrumental Variables Models That Are Robust to Weak Instruments</a></li>


<li class="toctree-l1"><a class="reference internal" href="py_double_ml_plm_irm_hetfx.html">Python: PLM and IRM for Multiple Treatments</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_meets_flaml.html">DoubleML meets FLAML - How to tune learners automatically within <code class="docutils literal notranslate"><span class="pre">DoubleML</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_rdflex.html">Flexible Covariate Adjustment in Regression Discontinuity Designs (RDD)</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate.html">Python: Group Average Treatment Effects (GATEs) for IRM models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate_plr.html">Python: Group Average Treatment Effects (GATEs) for PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cate.html">Python: Conditional Average Treatment Effects (CATEs) for IRM models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cate_plr.html">Python: Conditional Average Treatment Effects (CATEs) for PLR models</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_gate_sensitivity.html">Python: GATE Sensitivity Analysis</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_policy_tree.html">Python: Policy Learning with Trees</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pension_qte.html">Python: Impact of 401(k) on Financial Wealth (Quantile Effects)</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_pq.html">Python: Potential Quantiles and Quantile Treatment Effects</a></li>
<li class="toctree-l1"><a class="reference internal" href="py_double_ml_cvar.html">Python: Conditional Value at Risk of potential outcomes</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="did/py_panel_simple.html">Python: Panel Data Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_panel.html">Python: Panel Data with Multiple Time Periods</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_panel_data_example.html">Python: Real-Data Example for Multi-Period Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_rep_cs.html">Python: Repeated Cross-Sectional Data with Multiple Time Periods</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_basics.html">R: Basics of Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_pension.html">R: Impact of 401(k) on Financial Wealth</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_did.html">R: DoubleML for Difference-in-Differences</a></li>

<li class="toctree-l1"><a class="reference internal" href="R_double_ml_multiway_cluster.html">R: Cluster Robust Double Machine Learning</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_ssm.html">R: Sample Selection Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_basic_iv.html">R: Basic Instrumental Variables Calculation</a></li>
</ul>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="R_double_ml_pipeline.html">R: Ensemble Learners and More with <code class="docutils literal notranslate"><span class="pre">mlr3pipelines</span></code></a></li>
<li class="toctree-l1"><a class="reference internal" href="double_ml_bonus_data.html">DML: Bonus Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_did.html">Python: Difference-in-Differences</a></li>
<li class="toctree-l1"><a class="reference internal" href="did/py_did_pretest.html">Python: Difference-in-Differences Pre-Testing</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Examples</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Python:...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
      <div class="admonition note">
    <p class="admonition-title">Note</p>
    <ul class="simple">

Download Jupyter notebook:
<a class="reference external" href="https://docs.doubleml.org/stable/examples/py_double_ml_plpr.ipynb">https://docs.doubleml.org/stable/examples/py_double_ml_plpr.ipynb</a>.

    </ul>
    </div><section id="Python:-Static-Panel-Models-with-Fixed-Effects">
<h1>Python: Static Panel Models with Fixed Effects<a class="headerlink" href="#Python:-Static-Panel-Models-with-Fixed-Effects" title="Link to this heading">#</a></h1>
<p>In this example, we illustrate how the <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> package can be used to estimate treatment effects for static panel models with fixed effects in a partially linear panel regression <a class="reference external" href="https://docs.doubleml.org/stable/guide/models.html#partially-linear-models-plm">DoubleMLPLPR</a> model. The model is based on <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">optuna</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">clone</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">PolynomialFeatures</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.compose</span><span class="w"> </span><span class="kn">import</span> <span class="n">ColumnTransformer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.pipeline</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.linear_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">LassoCV</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lightgbm</span><span class="w"> </span><span class="kn">import</span> <span class="n">LGBMRegressor</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">doubleml.data</span><span class="w"> </span><span class="kn">import</span> <span class="n">DoubleMLPanelData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">doubleml.plm.datasets</span><span class="w"> </span><span class="kn">import</span> <span class="n">make_plpr_CP2025</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">doubleml</span><span class="w"> </span><span class="kn">import</span> <span class="n">DoubleMLPLPR</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<section id="Data">
<h2>Data<a class="headerlink" href="#Data" title="Link to this heading">#</a></h2>
<p>We will use the implemented data generating process <a class="reference external" href="https://docs.doubleml.org/stable/api/datasets.html#dataset-generators">make_plpr_CP2025</a> to generate data similar to the simulation in <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a>. For exposition, we use the simple linear <code class="docutils literal notranslate"><span class="pre">dgp_type=&quot;dgp1&quot;</span></code>, with 150 units, 10 time periods per unit, and a true treatment effect of <code class="docutils literal notranslate"><span class="pre">theta=0.5</span></code>.</p>
<p>We set <code class="docutils literal notranslate"><span class="pre">time_type=&quot;int&quot;</span></code> such that the time variable values will be integers. It’s also possible to use <code class="docutils literal notranslate"><span class="pre">&quot;float&quot;</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;datetime&quot;</span></code> time variables with <a class="reference external" href="https://docs.doubleml.org/stable/api/dml_models.html#doubleml-plm">DoubleMLPLPR</a>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">make_plpr_CP2025</span><span class="p">(</span><span class="n">num_id</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dim_x</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dgp_type</span><span class="o">=</span><span class="s2">&quot;dgp1&quot;</span><span class="p">,</span> <span class="n">time_type</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>time</th>
      <th>y</th>
      <th>d</th>
      <th>x1</th>
      <th>x2</th>
      <th>x3</th>
      <th>x4</th>
      <th>x5</th>
      <th>x6</th>
      <th>...</th>
      <th>x21</th>
      <th>x22</th>
      <th>x23</th>
      <th>x24</th>
      <th>x25</th>
      <th>x26</th>
      <th>x27</th>
      <th>x28</th>
      <th>x29</th>
      <th>x30</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>-1.290479</td>
      <td>0.908307</td>
      <td>1.710715</td>
      <td>-1.853675</td>
      <td>-1.473907</td>
      <td>1.366514</td>
      <td>-0.322024</td>
      <td>2.944020</td>
      <td>...</td>
      <td>-1.828362</td>
      <td>-3.010547</td>
      <td>-0.840202</td>
      <td>-3.085159</td>
      <td>1.169952</td>
      <td>-0.954107</td>
      <td>-3.925198</td>
      <td>-0.779510</td>
      <td>-0.430700</td>
      <td>1.004298</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>-2.850646</td>
      <td>-1.316777</td>
      <td>-0.325043</td>
      <td>4.178599</td>
      <td>-1.159857</td>
      <td>-0.139527</td>
      <td>-0.230115</td>
      <td>-0.631976</td>
      <td>...</td>
      <td>-0.724172</td>
      <td>-0.421045</td>
      <td>-2.012480</td>
      <td>-2.081784</td>
      <td>-2.734123</td>
      <td>-0.879470</td>
      <td>-2.141218</td>
      <td>4.598401</td>
      <td>-4.222797</td>
      <td>-2.523024</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>-4.338502</td>
      <td>-1.756120</td>
      <td>-0.897590</td>
      <td>1.505972</td>
      <td>-0.925189</td>
      <td>1.511500</td>
      <td>-2.206561</td>
      <td>0.132579</td>
      <td>...</td>
      <td>1.766109</td>
      <td>-2.252858</td>
      <td>-2.919826</td>
      <td>-1.974066</td>
      <td>-0.773881</td>
      <td>0.244633</td>
      <td>-1.727550</td>
      <td>1.665467</td>
      <td>0.562291</td>
      <td>-1.553616</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>-2.713236</td>
      <td>0.934866</td>
      <td>1.987849</td>
      <td>2.596228</td>
      <td>-0.220666</td>
      <td>-0.480717</td>
      <td>-3.966273</td>
      <td>-0.911226</td>
      <td>...</td>
      <td>0.856124</td>
      <td>0.727759</td>
      <td>-0.501579</td>
      <td>1.077504</td>
      <td>2.268052</td>
      <td>-3.821422</td>
      <td>1.629055</td>
      <td>-0.220834</td>
      <td>-1.185091</td>
      <td>-5.462884</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>-5.782997</td>
      <td>-4.357881</td>
      <td>-3.086559</td>
      <td>3.796975</td>
      <td>-1.539641</td>
      <td>-2.425617</td>
      <td>-1.020599</td>
      <td>-1.666200</td>
      <td>...</td>
      <td>2.617215</td>
      <td>-1.231835</td>
      <td>-0.891350</td>
      <td>0.246981</td>
      <td>2.489642</td>
      <td>0.319735</td>
      <td>-2.810366</td>
      <td>0.585826</td>
      <td>3.643749</td>
      <td>0.147147</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 34 columns</p>
</div></div>
</div>
<p>To create a corresponding <a class="reference external" href="https://docs.doubleml.org/stable/api/generated/doubleml.data.DoubleMLPanelData.html">DoubleMLPanelData</a> object, we need to set <code class="docutils literal notranslate"><span class="pre">static_panel=True</span></code> and specify <code class="docutils literal notranslate"><span class="pre">id_col</span></code> and <code class="docutils literal notranslate"><span class="pre">time_col</span></code> columns.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_obj</span> <span class="o">=</span> <span class="n">DoubleMLPanelData</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">d_cols</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">t_col</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">static_panel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Model">
<h2>Model<a class="headerlink" href="#Model" title="Link to this heading">#</a></h2>
<p>The partially linear panel regression (PLPR) model extends the partially linear model to panel data by introducing fixed effects <span class="math notranslate nohighlight">\(\alpha_i^*\)</span>.</p>
<p>The PLPR model takes the form</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    Y_{it} &amp;= \theta_0 D_{it} + g_1(X_{it}) + \alpha_i^* + U_{it}, \\
    D_{it} &amp;= m_1(X_{it}) + \gamma_i + V_{it},
\end{align*}\end{split}\]</div>
<p>where</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(Y_{it}\)</span> outcome, <span class="math notranslate nohighlight">\(D_{it}\)</span> treatment, <span class="math notranslate nohighlight">\(X_{it}\)</span> covariates, <span class="math notranslate nohighlight">\(\theta_0\)</span> causal treatment effect</p></li>
<li><p><span class="math notranslate nohighlight">\(g_1\)</span> and <span class="math notranslate nohighlight">\(m_1\)</span> nuisance functions</p></li>
<li><p><span class="math notranslate nohighlight">\(\alpha_i^*\)</span>, <span class="math notranslate nohighlight">\(\gamma_i\)</span> unobserved individual heterogeneity, correlated with covariates</p></li>
<li><p><span class="math notranslate nohighlight">\(U_{it}\)</span>, <span class="math notranslate nohighlight">\(V_{it}\)</span> error terms</p></li>
</ul>
<p>Further note <span class="math notranslate nohighlight">\(\mathbb{E}[U_{it} \mid D_{it}, X_{it}, \alpha_i^*] = 0\)</span> and <span class="math notranslate nohighlight">\(\mathbb{E}[V_{it} \mid X_{it}, \gamma_i]=0\)</span>, but <span class="math notranslate nohighlight">\(\mathbb{E}[\alpha_i^* \mid D_{it}, X_{it}] \neq 0\)</span>.</p>
<p>Alternatively we can write the partialling-out PLPR as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    Y_{it} &amp;= \theta_0 V_{it} + \ell_1(X_{it}) + \alpha_i + U_{it}, \\
    V_{it} &amp;= D_{it} - m_1(X_{it}) - \gamma_i,
\end{align*}\end{split}\]</div>
<p>with nuisance function <span class="math notranslate nohighlight">\(\ell_1\)</span> and fixed effect <span class="math notranslate nohighlight">\(\alpha_i\)</span>.</p>
<section id="Assumptions">
<h3>Assumptions<a class="headerlink" href="#Assumptions" title="Link to this heading">#</a></h3>
<p>Define <span class="math notranslate nohighlight">\(\xi_i\)</span> as time-invariant heterogeneity terms influencing outcome and treatment and <span class="math notranslate nohighlight">\(L_{t-1}(W_i) = \{ W_{i1}, \dots, W_{it-1} \}\)</span> as lags of a random variable <span class="math notranslate nohighlight">\(W_{it}\)</span> at wave <span class="math notranslate nohighlight">\(t\)</span>.</p>
<ul>
<li><p><em>No feedback to predictors</em></p>
<div class="math notranslate nohighlight">
\[X_{it} \perp L_{t-1} (Y_i, D_i) \mid L_{t-1} (X_i), \xi_i\]</div>
</li>
<li><p><em>Static panel</em></p>
<div class="math notranslate nohighlight">
\[Y_{it}, D_{it} \perp L_{t-1} (Y_i, X_i, D_i) \mid X_{it}, \xi_i\]</div>
</li>
<li><p><em>Selection on observables and omitted time-invariant variables</em></p>
<div class="math notranslate nohighlight">
\[Y_{it} (.) \perp D_{it} \mid X_{it}, \xi_i\]</div>
</li>
<li><p><em>Homogeneity and linearity of the treatment effect</em></p>
<div class="math notranslate nohighlight">
\[\mathbb{E} [Y_{it}(d) - Y_{it}(0) \mid X_{it}, \xi_i] = d \theta_0\]</div>
</li>
<li><p><em>Additive Separability</em></p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
\mathbb{E} [Y_{it}(0) \mid X_{it}, \xi_i] &amp;= g_1(X_{it}) + \alpha^*_i \quad \text{where } \alpha^*_i = \alpha^*(\xi_i), \\
\mathbb{E} [D_{it} \mid X_{it}, \xi_i] &amp;= m_1(X_{it}) + \gamma_i \quad \text{where } \gamma_i = \gamma(\xi_i)
\end{align*}\end{split}\]</div>
</li>
</ul>
<p>For more information, see <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a>.</p>
<p>To estimate the causal effect, we can create a <a class="reference external" href="https://docs.doubleml.org/stable/api/dml_models.html#doubleml-plm">DoubleMLPLPR</a> object. The model described in <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a> uses block-k-fold cross-fitting, where the entire time series of the sampled unit is allocated to one fold to allow for possible serial correlation within each unit which is common with panel data. Furthermore, cluster robust standard error are employed.
<a class="reference external" href="https://docs.doubleml.org/stable/guide/models.html#partially-linear-models-plm">DoubleMLPLPR</a> implements both aspects by using <code class="docutils literal notranslate"><span class="pre">id_col</span></code> as the cluster variable.</p>
</section>
</section>
<section id="Estimation-Approaches">
<h2>Estimation Approaches<a class="headerlink" href="#Estimation-Approaches" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a> describes multiple estimation approaches, which can be set with the <code class="docutils literal notranslate"><span class="pre">approach</span></code> parameter. Depending on the type of <code class="docutils literal notranslate"><span class="pre">approach</span></code>, different data transformations are performed along the way.</p>
<section id="Correlated-Random-Effects">
<h3>Correlated Random Effects<a class="headerlink" href="#Correlated-Random-Effects" title="Link to this heading">#</a></h3>
<p>The correlated random effects (cre) approaches includes the a general approach (<code class="docutils literal notranslate"><span class="pre">cre_general</span></code>) and an approach relying on normality assumptions (<code class="docutils literal notranslate"><span class="pre">cre_normal</span></code>).</p>
<section id="cre_general">
<h4><code class="docutils literal notranslate"><span class="pre">cre_general</span></code><a class="headerlink" href="#cre_general" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">cre_general</span></code> approach:</p>
<ul class="simple">
<li><p>Learning <span class="math notranslate nohighlight">\(\ell_1\)</span> from <span class="math notranslate nohighlight">\(\{ Y_{it}, X_{it}, \bar{X}_i : t=1,\dots, T \}_{i=1}^N\)</span>.</p></li>
<li><p>First learning <span class="math notranslate nohighlight">\(\tilde{m}_1\)</span> from <span class="math notranslate nohighlight">\(\{ D_{it}, X_{it}, \bar{X}_i : t=1,\dots, T \}_{i=1}^N\)</span>, with predictions <span class="math notranslate nohighlight">\(\hat{m}_{1,it} = \tilde{m}_1 (X_{it}, \bar{X}_i)\)</span></p>
<ul>
<li><p>Calculate <span class="math notranslate nohighlight">\(\hat{\bar{m}}_i = T^{-1} \sum_{t=1}^T \hat{m}_{1,it}\)</span>,</p></li>
<li><p>Calculate final nuisance part as <span class="math notranslate nohighlight">\(\hat{m}^*_1 (X_{it}, \bar{X}_i, \bar{D}_i) = \hat{m}_{1,it} + \bar{D}_i - \hat{\bar{m}}_i\)</span>.</p></li>
</ul>
</li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">learner</span> <span class="o">=</span> <span class="n">LassoCV</span><span class="p">()</span>
<span class="n">ml_l</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>
<span class="n">ml_m</span> <span class="o">=</span> <span class="n">clone</span><span class="p">(</span><span class="n">learner</span><span class="p">)</span>

<span class="n">dml_plpr_cre_general</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">data_obj</span><span class="p">,</span> <span class="n">ml_l</span><span class="o">=</span><span class="n">ml_l</span><span class="p">,</span> <span class="n">ml_m</span><span class="o">=</span><span class="n">ml_m</span><span class="p">,</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;cre_general&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can look at the the transformed data using the <code class="docutils literal notranslate"><span class="pre">data_transform</span></code> property after the <code class="docutils literal notranslate"><span class="pre">DoubleMLPLPR</span></code> object was created.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_cre_general</span><span class="o">.</span><span class="n">data_transform</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>time</th>
      <th>y</th>
      <th>d</th>
      <th>x1</th>
      <th>x2</th>
      <th>x3</th>
      <th>x4</th>
      <th>x5</th>
      <th>x6</th>
      <th>...</th>
      <th>x21_mean</th>
      <th>x22_mean</th>
      <th>x23_mean</th>
      <th>x24_mean</th>
      <th>x25_mean</th>
      <th>x26_mean</th>
      <th>x27_mean</th>
      <th>x28_mean</th>
      <th>x29_mean</th>
      <th>x30_mean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>-1.290479</td>
      <td>0.908307</td>
      <td>1.710715</td>
      <td>-1.853675</td>
      <td>-1.473907</td>
      <td>1.366514</td>
      <td>-0.322024</td>
      <td>2.944020</td>
      <td>...</td>
      <td>1.24018</td>
      <td>-0.52821</td>
      <td>-0.734145</td>
      <td>0.227494</td>
      <td>1.164763</td>
      <td>0.412979</td>
      <td>-1.272608</td>
      <td>0.459816</td>
      <td>-0.829863</td>
      <td>-1.145189</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>-2.850646</td>
      <td>-1.316777</td>
      <td>-0.325043</td>
      <td>4.178599</td>
      <td>-1.159857</td>
      <td>-0.139527</td>
      <td>-0.230115</td>
      <td>-0.631976</td>
      <td>...</td>
      <td>1.24018</td>
      <td>-0.52821</td>
      <td>-0.734145</td>
      <td>0.227494</td>
      <td>1.164763</td>
      <td>0.412979</td>
      <td>-1.272608</td>
      <td>0.459816</td>
      <td>-0.829863</td>
      <td>-1.145189</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>-4.338502</td>
      <td>-1.756120</td>
      <td>-0.897590</td>
      <td>1.505972</td>
      <td>-0.925189</td>
      <td>1.511500</td>
      <td>-2.206561</td>
      <td>0.132579</td>
      <td>...</td>
      <td>1.24018</td>
      <td>-0.52821</td>
      <td>-0.734145</td>
      <td>0.227494</td>
      <td>1.164763</td>
      <td>0.412979</td>
      <td>-1.272608</td>
      <td>0.459816</td>
      <td>-0.829863</td>
      <td>-1.145189</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>-2.713236</td>
      <td>0.934866</td>
      <td>1.987849</td>
      <td>2.596228</td>
      <td>-0.220666</td>
      <td>-0.480717</td>
      <td>-3.966273</td>
      <td>-0.911226</td>
      <td>...</td>
      <td>1.24018</td>
      <td>-0.52821</td>
      <td>-0.734145</td>
      <td>0.227494</td>
      <td>1.164763</td>
      <td>0.412979</td>
      <td>-1.272608</td>
      <td>0.459816</td>
      <td>-0.829863</td>
      <td>-1.145189</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>-5.782997</td>
      <td>-4.357881</td>
      <td>-3.086559</td>
      <td>3.796975</td>
      <td>-1.539641</td>
      <td>-2.425617</td>
      <td>-1.020599</td>
      <td>-1.666200</td>
      <td>...</td>
      <td>1.24018</td>
      <td>-0.52821</td>
      <td>-0.734145</td>
      <td>0.227494</td>
      <td>1.164763</td>
      <td>0.412979</td>
      <td>-1.272608</td>
      <td>0.459816</td>
      <td>-0.829863</td>
      <td>-1.145189</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 64 columns</p>
</div></div>
</div>
<p>We can see that the covariates inlcude the original <span class="math notranslate nohighlight">\(X_{it}\)</span> and additionally the unit mean <span class="math notranslate nohighlight">\(\bar{X}_i\)</span>.</p>
<p>After fitting the model, we can print the <code class="docutils literal notranslate"><span class="pre">DoubleMLPLPR</span></code> object. The data summary corresponds to the transformed data. Additional Information at the end also includes a pre-transformation data summary.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_cre_general</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_plpr_cre_general</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
================== DoubleMLPLPR Object ==================

------------------ Data Summary      ------------------
Outcome variable: y
Treatment variable(s): [&#39;d&#39;]
Covariates: [&#39;x1&#39;, &#39;x2&#39;, &#39;x3&#39;, &#39;x4&#39;, &#39;x5&#39;, &#39;x6&#39;, &#39;x7&#39;, &#39;x8&#39;, &#39;x9&#39;, &#39;x10&#39;, &#39;x11&#39;, &#39;x12&#39;, &#39;x13&#39;, &#39;x14&#39;, &#39;x15&#39;, &#39;x16&#39;, &#39;x17&#39;, &#39;x18&#39;, &#39;x19&#39;, &#39;x20&#39;, &#39;x21&#39;, &#39;x22&#39;, &#39;x23&#39;, &#39;x24&#39;, &#39;x25&#39;, &#39;x26&#39;, &#39;x27&#39;, &#39;x28&#39;, &#39;x29&#39;, &#39;x30&#39;, &#39;x1_mean&#39;, &#39;x2_mean&#39;, &#39;x3_mean&#39;, &#39;x4_mean&#39;, &#39;x5_mean&#39;, &#39;x6_mean&#39;, &#39;x7_mean&#39;, &#39;x8_mean&#39;, &#39;x9_mean&#39;, &#39;x10_mean&#39;, &#39;x11_mean&#39;, &#39;x12_mean&#39;, &#39;x13_mean&#39;, &#39;x14_mean&#39;, &#39;x15_mean&#39;, &#39;x16_mean&#39;, &#39;x17_mean&#39;, &#39;x18_mean&#39;, &#39;x19_mean&#39;, &#39;x20_mean&#39;, &#39;x21_mean&#39;, &#39;x22_mean&#39;, &#39;x23_mean&#39;, &#39;x24_mean&#39;, &#39;x25_mean&#39;, &#39;x26_mean&#39;, &#39;x27_mean&#39;, &#39;x28_mean&#39;, &#39;x29_mean&#39;, &#39;x30_mean&#39;]
Instrument variable(s): None
Time variable: time
Id variable: id
Static panel data: True
No. Unique Ids: 150
No. Observations: 1500

------------------ Score &amp; Algorithm ------------------
Score function: partialling out
Static panel model approach: cre_general

------------------ Machine Learner   ------------------
Learner ml_l: LassoCV()
Learner ml_m: LassoCV()
Out-of-sample Performance:
Regression:
Learner ml_l RMSE: [[1.8336022]]
Learner ml_m RMSE: [[0.99534683]]

------------------ Resampling        ------------------
No. folds per cluster: 5
No. folds: 5
No. repeated sample splits: 1

------------------ Fit Summary       ------------------
       coef   std err          t         P&gt;|t|     2.5 %    97.5 %
d  0.490173  0.026161  18.737077  2.468215e-78  0.438899  0.541447

------------------ Additional Information -------------
Cluster variable(s): [&#39;id&#39;]

Pre-Transformation Data Summary:
Outcome variable: y
Treatment variable(s): [&#39;d&#39;]
Covariates: [&#39;x1&#39;, &#39;x2&#39;, &#39;x3&#39;, &#39;x4&#39;, &#39;x5&#39;, &#39;x6&#39;, &#39;x7&#39;, &#39;x8&#39;, &#39;x9&#39;, &#39;x10&#39;, &#39;x11&#39;, &#39;x12&#39;, &#39;x13&#39;, &#39;x14&#39;, &#39;x15&#39;, &#39;x16&#39;, &#39;x17&#39;, &#39;x18&#39;, &#39;x19&#39;, &#39;x20&#39;, &#39;x21&#39;, &#39;x22&#39;, &#39;x23&#39;, &#39;x24&#39;, &#39;x25&#39;, &#39;x26&#39;, &#39;x27&#39;, &#39;x28&#39;, &#39;x29&#39;, &#39;x30&#39;]
No. Observations: 1500

</pre></div></div>
</div>
</section>
<section id="cre_normal">
<h4><code class="docutils literal notranslate"><span class="pre">cre_normal</span></code><a class="headerlink" href="#cre_normal" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">cre_normal</span></code> approach:</p>
<p>Under the assumption that the conditional distribution <span class="math notranslate nohighlight">\(D_{i1}, \dots, D_{iT} \mid X_{i1}, \dots X_{iT}\)</span> is multivariate normal (see <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a> for further details):</p>
<ul class="simple">
<li><p>Learn <span class="math notranslate nohighlight">\(\ell_1\)</span> from <span class="math notranslate nohighlight">\(\{ Y_{it}, X_{it}, \bar{X}_i : t=1,\dots, T \}_{i=1}^N\)</span>,</p></li>
<li><p>Learn <span class="math notranslate nohighlight">\(m^*_{1}\)</span> from <span class="math notranslate nohighlight">\(\{ D_{it}, X_{it}, \bar{X}_i, \bar{D}_i: t=1,\dots, T \}_{i=1}^N\)</span>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_cre_normal</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">data_obj</span><span class="p">,</span> <span class="n">ml_l</span><span class="o">=</span><span class="n">ml_l</span><span class="p">,</span> <span class="n">ml_m</span><span class="o">=</span><span class="n">ml_m</span><span class="p">,</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;cre_normal&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dml_plpr_cre_normal</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_plpr_cre_normal</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
       coef   std err          t         P&gt;|t|    2.5 %    97.5 %
d  0.505807  0.027168  18.617927  2.299468e-77  0.45256  0.559055
</pre></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">cre_normal</span></code> approach uses additionally inlcudes <span class="math notranslate nohighlight">\(\bar{D}_i\)</span> in the treatment nuisance estimation. The corresponding data can be assesses by the <code class="docutils literal notranslate"><span class="pre">d_mean</span></code> property.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_cre_normal</span><span class="o">.</span><span class="n">d_mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[-0.94278854],
       [-0.94278854],
       [-0.94278854],
       ...,
       [ 0.15320478],
       [ 0.15320478],
       [ 0.15320478]], shape=(1500, 1))
</pre></div></div>
</div>
</section>
</section>
<section id="Transformation-Approaches">
<h3>Transformation Approaches<a class="headerlink" href="#Transformation-Approaches" title="Link to this heading">#</a></h3>
<p>The transformation approaches include first differences (<code class="docutils literal notranslate"><span class="pre">fd_exact</span></code>) and within-group (<code class="docutils literal notranslate"><span class="pre">wg_approx</span></code>) transformations.</p>
<section id="fd_exact">
<h4><code class="docutils literal notranslate"><span class="pre">fd_exact</span></code><a class="headerlink" href="#fd_exact" title="Link to this heading">#</a></h4>
<p>Consider first differences (FD) transformation (<code class="docutils literal notranslate"><span class="pre">fd_exact</span></code>) <span class="math notranslate nohighlight">\(Q(Y_{it})= Y_{it} - Y_{it-1}\)</span>, under the assumptions from above, <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a> show that <span class="math notranslate nohighlight">\(\mathbb{E}[Y_{it}-Y_{it-1} | X_{it-1},X_{it}] =\Delta \ell_1 (X_{it-1}, X_{it})\)</span> and <span class="math notranslate nohighlight">\(\mathbb{E}[D_{it}-D_{it-1} | X_{it-1},X_{it}] =\Delta m_1 (X_{it-1}, X_{it})\)</span>. Therefore, the transformed nuisance function can be learnt as</p>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\Delta \ell_1 (X_{it-1}, X_{it})\)</span> from <span class="math notranslate nohighlight">\(\{ Y_{it}-Y_{it-1}, X_{it-1}, X_{it} : t=2, \dots , T \}_{i=1}^N\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(\Delta m_1 (X_{it-1}, X_{it})\)</span> from <span class="math notranslate nohighlight">\(\{ D_{it}-D_{it-1}, X_{it-1}, X_{it} : t=2, \dots , T \}_{i=1}^N\)</span>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_fd_exact</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">data_obj</span><span class="p">,</span> <span class="n">ml_l</span><span class="o">=</span><span class="n">ml_l</span><span class="p">,</span> <span class="n">ml_m</span><span class="o">=</span><span class="n">ml_m</span><span class="p">,</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;fd_exact&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dml_plpr_fd_exact</span><span class="o">.</span><span class="n">data_transform</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>time</th>
      <th>y_diff</th>
      <th>d_diff</th>
      <th>x1</th>
      <th>x2</th>
      <th>x3</th>
      <th>x4</th>
      <th>x5</th>
      <th>x6</th>
      <th>...</th>
      <th>x21_lag</th>
      <th>x22_lag</th>
      <th>x23_lag</th>
      <th>x24_lag</th>
      <th>x25_lag</th>
      <th>x26_lag</th>
      <th>x27_lag</th>
      <th>x28_lag</th>
      <th>x29_lag</th>
      <th>x30_lag</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>2</td>
      <td>-1.560167</td>
      <td>-2.225084</td>
      <td>-0.325043</td>
      <td>4.178599</td>
      <td>-1.159857</td>
      <td>-0.139527</td>
      <td>-0.230115</td>
      <td>-0.631976</td>
      <td>...</td>
      <td>-1.828362</td>
      <td>-3.010547</td>
      <td>-0.840202</td>
      <td>-3.085159</td>
      <td>1.169952</td>
      <td>-0.954107</td>
      <td>-3.925198</td>
      <td>-0.779510</td>
      <td>-0.430700</td>
      <td>1.004298</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>3</td>
      <td>-1.487856</td>
      <td>-0.439343</td>
      <td>-0.897590</td>
      <td>1.505972</td>
      <td>-0.925189</td>
      <td>1.511500</td>
      <td>-2.206561</td>
      <td>0.132579</td>
      <td>...</td>
      <td>-0.724172</td>
      <td>-0.421045</td>
      <td>-2.012480</td>
      <td>-2.081784</td>
      <td>-2.734123</td>
      <td>-0.879470</td>
      <td>-2.141218</td>
      <td>4.598401</td>
      <td>-4.222797</td>
      <td>-2.523024</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>4</td>
      <td>1.625266</td>
      <td>2.690986</td>
      <td>1.987849</td>
      <td>2.596228</td>
      <td>-0.220666</td>
      <td>-0.480717</td>
      <td>-3.966273</td>
      <td>-0.911226</td>
      <td>...</td>
      <td>1.766109</td>
      <td>-2.252858</td>
      <td>-2.919826</td>
      <td>-1.974066</td>
      <td>-0.773881</td>
      <td>0.244633</td>
      <td>-1.727550</td>
      <td>1.665467</td>
      <td>0.562291</td>
      <td>-1.553616</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>5</td>
      <td>-3.069761</td>
      <td>-5.292747</td>
      <td>-3.086559</td>
      <td>3.796975</td>
      <td>-1.539641</td>
      <td>-2.425617</td>
      <td>-1.020599</td>
      <td>-1.666200</td>
      <td>...</td>
      <td>0.856124</td>
      <td>0.727759</td>
      <td>-0.501579</td>
      <td>1.077504</td>
      <td>2.268052</td>
      <td>-3.821422</td>
      <td>1.629055</td>
      <td>-0.220834</td>
      <td>-1.185091</td>
      <td>-5.462884</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>6</td>
      <td>-1.094799</td>
      <td>0.551051</td>
      <td>0.289315</td>
      <td>-2.823134</td>
      <td>-3.137179</td>
      <td>-1.425923</td>
      <td>-0.730116</td>
      <td>0.232687</td>
      <td>...</td>
      <td>2.617215</td>
      <td>-1.231835</td>
      <td>-0.891350</td>
      <td>0.246981</td>
      <td>2.489642</td>
      <td>0.319735</td>
      <td>-2.810366</td>
      <td>0.585826</td>
      <td>3.643749</td>
      <td>0.147147</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 64 columns</p>
</div></div>
</div>
<p>We see that the outcome and treatment variables are now labeled <code class="docutils literal notranslate"><span class="pre">y_diff</span></code> and <code class="docutils literal notranslate"><span class="pre">d_diff</span></code> to indicate the first-difference transformation. Moreover, lagged covariates <span class="math notranslate nohighlight">\(X_{it-1}\)</span> are added and rows for the first time period are dropped.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_fd_exact</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_plpr_fd_exact</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            coef   std err          t         P&gt;|t|     2.5 %    97.5 %
d_diff  0.511822  0.032746  15.630162  4.536510e-55  0.447641  0.576002
</pre></div></div>
</div>
</section>
<section id="wg_approx">
<h4><code class="docutils literal notranslate"><span class="pre">wg_approx</span></code><a class="headerlink" href="#wg_approx" title="Link to this heading">#</a></h4>
<p>For within-group (WG) transformation (<code class="docutils literal notranslate"><span class="pre">wg_approx</span></code>) <span class="math notranslate nohighlight">\(Q(X_{it})= X_{it} - \bar{X}_{i}\)</span>, where <span class="math notranslate nohighlight">\(\bar{X}_{i} = T^{-1} \sum_{t=1}^T X_{it}\)</span>, approximate the model as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{align*}
    Q(Y_{it}) &amp;\approx \theta_0 Q(D_{it}) + g_1 (Q(X_{it})) + Q(U_{it}), \\
    Q(D_{it}) &amp;\approx m_1 (Q(X_{it})) + Q(V_{it}).
\end{align*}\end{split}\]</div>
<p>Similarly for the partialling-out PLPR</p>
<div class="math notranslate nohighlight">
\[Q(Y_{it}) \approx \theta_0 Q(V_{it}) + \ell_1 (Q(X_{it})) + Q(U_{it}).\]</div>
<ul class="simple">
<li><p><span class="math notranslate nohighlight">\(\ell_1\)</span> can be learnt from transformed data <span class="math notranslate nohighlight">\(\{ Q(Y_{it}), Q(X_{it}) : t=1,\dots,T \}_{i=1}^N\)</span>,</p></li>
<li><p><span class="math notranslate nohighlight">\(m_1\)</span> can be learnt from transformed data <span class="math notranslate nohighlight">\(\{ Q(D_{it}), Q(X_{it}) : t=1,\dots,T \}_{i=1}^N\)</span>.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_wg_approx</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">data_obj</span><span class="p">,</span> <span class="n">ml_l</span><span class="o">=</span><span class="n">ml_l</span><span class="p">,</span> <span class="n">ml_m</span><span class="o">=</span><span class="n">ml_m</span><span class="p">,</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;wg_approx&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">dml_plpr_wg_approx</span><span class="o">.</span><span class="n">data_transform</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>time</th>
      <th>y_demean</th>
      <th>d_demean</th>
      <th>x1_demean</th>
      <th>x2_demean</th>
      <th>x3_demean</th>
      <th>x4_demean</th>
      <th>x5_demean</th>
      <th>x6_demean</th>
      <th>...</th>
      <th>x21_demean</th>
      <th>x22_demean</th>
      <th>x23_demean</th>
      <th>x24_demean</th>
      <th>x25_demean</th>
      <th>x26_demean</th>
      <th>x27_demean</th>
      <th>x28_demean</th>
      <th>x29_demean</th>
      <th>x30_demean</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>1.543571</td>
      <td>1.760660</td>
      <td>2.207607</td>
      <td>-2.039516</td>
      <td>-0.642847</td>
      <td>1.014204</td>
      <td>0.384166</td>
      <td>1.826013</td>
      <td>...</td>
      <td>-3.162933</td>
      <td>-2.475942</td>
      <td>0.000728</td>
      <td>-3.344219</td>
      <td>0.082829</td>
      <td>-1.351303</td>
      <td>-2.670511</td>
      <td>-1.275344</td>
      <td>0.407596</td>
      <td>2.187878</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>-0.016596</td>
      <td>-0.464424</td>
      <td>0.171849</td>
      <td>3.992759</td>
      <td>-0.328797</td>
      <td>-0.491837</td>
      <td>0.476074</td>
      <td>-1.749982</td>
      <td>...</td>
      <td>-2.058743</td>
      <td>0.113560</td>
      <td>-1.171550</td>
      <td>-2.340844</td>
      <td>-3.821246</td>
      <td>-1.276666</td>
      <td>-0.886531</td>
      <td>4.102567</td>
      <td>-3.384501</td>
      <td>-1.339444</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>-1.504452</td>
      <td>-0.903767</td>
      <td>-0.400698</td>
      <td>1.320131</td>
      <td>-0.094129</td>
      <td>1.159190</td>
      <td>-1.500371</td>
      <td>-0.985427</td>
      <td>...</td>
      <td>0.431538</td>
      <td>-1.718253</td>
      <td>-2.078895</td>
      <td>-2.233126</td>
      <td>-1.861004</td>
      <td>-0.152563</td>
      <td>-0.472863</td>
      <td>1.169632</td>
      <td>1.400587</td>
      <td>-0.370036</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>0.120814</td>
      <td>1.787219</td>
      <td>2.484741</td>
      <td>2.410387</td>
      <td>0.610394</td>
      <td>-0.833027</td>
      <td>-3.260084</td>
      <td>-2.029232</td>
      <td>...</td>
      <td>-0.478447</td>
      <td>1.262364</td>
      <td>0.339352</td>
      <td>0.818443</td>
      <td>1.180930</td>
      <td>-4.218618</td>
      <td>2.883741</td>
      <td>-0.716668</td>
      <td>-0.346795</td>
      <td>-4.279304</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>-2.948947</td>
      <td>-3.505528</td>
      <td>-2.589667</td>
      <td>3.611134</td>
      <td>-0.708582</td>
      <td>-2.777927</td>
      <td>-0.314410</td>
      <td>-2.784206</td>
      <td>...</td>
      <td>1.282645</td>
      <td>-0.697230</td>
      <td>-0.050420</td>
      <td>-0.012080</td>
      <td>1.402519</td>
      <td>-0.077461</td>
      <td>-1.555679</td>
      <td>0.089991</td>
      <td>4.482045</td>
      <td>1.330727</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 34 columns</p>
</div></div>
</div>
<p>We see that the outcome, treatment and covariate variables are now labeled <code class="docutils literal notranslate"><span class="pre">y_demean</span></code>, <code class="docutils literal notranslate"><span class="pre">d_demean</span></code>, <code class="docutils literal notranslate"><span class="pre">xi_demean</span></code> to indicate the within-group transformations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_wg_approx</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dml_plpr_wg_approx</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              coef   std err          t         P&gt;|t|     2.5 %    97.5 %
d_demean  0.495323  0.025841  19.167824  6.872435e-82  0.444675  0.545972
</pre></div></div>
</div>
<p>For the simple linear data generating process <code class="docutils literal notranslate"><span class="pre">dgp_type=&quot;dgp1&quot;</span></code>, we can see that all approaches lead to estimated close the true effect of <code class="docutils literal notranslate"><span class="pre">theta=0.5</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">data_original</span></code> property additionally includes the original data before any transformation was applied.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dml_plpr_wg_approx</span><span class="o">.</span><span class="n">data_original</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>id</th>
      <th>time</th>
      <th>y</th>
      <th>d</th>
      <th>x1</th>
      <th>x2</th>
      <th>x3</th>
      <th>x4</th>
      <th>x5</th>
      <th>x6</th>
      <th>...</th>
      <th>x21</th>
      <th>x22</th>
      <th>x23</th>
      <th>x24</th>
      <th>x25</th>
      <th>x26</th>
      <th>x27</th>
      <th>x28</th>
      <th>x29</th>
      <th>x30</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1</td>
      <td>-1.290479</td>
      <td>0.908307</td>
      <td>1.710715</td>
      <td>-1.853675</td>
      <td>-1.473907</td>
      <td>1.366514</td>
      <td>-0.322024</td>
      <td>2.944020</td>
      <td>...</td>
      <td>-1.828362</td>
      <td>-3.010547</td>
      <td>-0.840202</td>
      <td>-3.085159</td>
      <td>1.169952</td>
      <td>-0.954107</td>
      <td>-3.925198</td>
      <td>-0.779510</td>
      <td>-0.430700</td>
      <td>1.004298</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>2</td>
      <td>-2.850646</td>
      <td>-1.316777</td>
      <td>-0.325043</td>
      <td>4.178599</td>
      <td>-1.159857</td>
      <td>-0.139527</td>
      <td>-0.230115</td>
      <td>-0.631976</td>
      <td>...</td>
      <td>-0.724172</td>
      <td>-0.421045</td>
      <td>-2.012480</td>
      <td>-2.081784</td>
      <td>-2.734123</td>
      <td>-0.879470</td>
      <td>-2.141218</td>
      <td>4.598401</td>
      <td>-4.222797</td>
      <td>-2.523024</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>3</td>
      <td>-4.338502</td>
      <td>-1.756120</td>
      <td>-0.897590</td>
      <td>1.505972</td>
      <td>-0.925189</td>
      <td>1.511500</td>
      <td>-2.206561</td>
      <td>0.132579</td>
      <td>...</td>
      <td>1.766109</td>
      <td>-2.252858</td>
      <td>-2.919826</td>
      <td>-1.974066</td>
      <td>-0.773881</td>
      <td>0.244633</td>
      <td>-1.727550</td>
      <td>1.665467</td>
      <td>0.562291</td>
      <td>-1.553616</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>4</td>
      <td>-2.713236</td>
      <td>0.934866</td>
      <td>1.987849</td>
      <td>2.596228</td>
      <td>-0.220666</td>
      <td>-0.480717</td>
      <td>-3.966273</td>
      <td>-0.911226</td>
      <td>...</td>
      <td>0.856124</td>
      <td>0.727759</td>
      <td>-0.501579</td>
      <td>1.077504</td>
      <td>2.268052</td>
      <td>-3.821422</td>
      <td>1.629055</td>
      <td>-0.220834</td>
      <td>-1.185091</td>
      <td>-5.462884</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>5</td>
      <td>-5.782997</td>
      <td>-4.357881</td>
      <td>-3.086559</td>
      <td>3.796975</td>
      <td>-1.539641</td>
      <td>-2.425617</td>
      <td>-1.020599</td>
      <td>-1.666200</td>
      <td>...</td>
      <td>2.617215</td>
      <td>-1.231835</td>
      <td>-0.891350</td>
      <td>0.246981</td>
      <td>2.489642</td>
      <td>0.319735</td>
      <td>-2.810366</td>
      <td>0.585826</td>
      <td>3.643749</td>
      <td>0.147147</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 34 columns</p>
</div></div>
</div>
</section>
</section>
</section>
<section id="Feature-preprocessing-pipelines">
<h2>Feature preprocessing pipelines<a class="headerlink" href="#Feature-preprocessing-pipelines" title="Link to this heading">#</a></h2>
<p>We can incorporate preprocessing pipelines. For example, when using Lasso, we may want to include polynomial and interaction terms. Here, we create a class that allows us to include, for example, polynomials of order 3 and interactions between all variables.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PolyPlus</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;PolynomialFeatures(degree=k) and additional terms x_i^(k+1).&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">degree</span> <span class="o">=</span> <span class="n">degree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_degree</span> <span class="o">=</span> <span class="n">degree</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_only</span> <span class="o">=</span> <span class="n">interaction_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">include_bias</span> <span class="o">=</span> <span class="n">include_bias</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span> <span class="o">=</span> <span class="n">PolynomialFeatures</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="n">degree</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="n">interaction_only</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="n">include_bias</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_features_in_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">X_extra</span> <span class="o">=</span> <span class="n">X</span> <span class="o">**</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_degree</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">X_poly</span><span class="p">,</span> <span class="n">X_extra</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_feature_names_out</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_features</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">input_features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="n">input_features</span>
            <span class="k">if</span> <span class="n">input_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;x</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_features_in_</span><span class="p">)]</span>
        <span class="p">)</span>
        <span class="n">poly_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">poly</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">(</span><span class="n">input_features</span><span class="p">)</span>
        <span class="n">extra_names</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">^</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">extra_degree</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">input_features</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">poly_names</span><span class="p">,</span> <span class="n">extra_names</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>For this example we use the non-linear and discontinuous <code class="docutils literal notranslate"><span class="pre">dgp_type=&quot;dgp3&quot;</span></code>, with 30 covariates and a true treatment effect <code class="docutils literal notranslate"><span class="pre">theta=0.5</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dim_x</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="n">data_dgp3</span> <span class="o">=</span> <span class="n">make_plpr_CP2025</span><span class="p">(</span><span class="n">num_id</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dim_x</span><span class="o">=</span><span class="n">dim_x</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">dgp_type</span><span class="o">=</span><span class="s2">&quot;dgp3&quot;</span><span class="p">)</span>
<span class="n">dml_data_dgp3</span> <span class="o">=</span> <span class="n">DoubleMLPanelData</span><span class="p">(</span><span class="n">data_dgp3</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">d_cols</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">t_col</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">static_panel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We can apply the polynomial and intercation transformation for specific sets of covariates. For example, for the <code class="docutils literal notranslate"><span class="pre">fd_exact</span></code> approach, we can apply it to the original <span class="math notranslate nohighlight">\(X_{it}\)</span> and lags <span class="math notranslate nohighlight">\(X_{it-1}\)</span> seperately using <code class="docutils literal notranslate"><span class="pre">ColumnTransformer</span></code>.</p>
<p>To achieve this, we pass need to pass the corresponding indices for these two sets. <code class="docutils literal notranslate"><span class="pre">DoubleMLPLPR</span></code> stacks sets <span class="math notranslate nohighlight">\(X_{it}\)</span> and <span class="math notranslate nohighlight">\(X_{it-1}\)</span> column-wise. Given our example data has 30 covariates, this means that the first 30 features in the nuisance estimation correspond to the original <span class="math notranslate nohighlight">\(X_{it}\)</span>, and the last 30 correspond to lags <span class="math notranslate nohighlight">\(X_{it-1}\)</span>. Therefore we define the indices <code class="docutils literal notranslate"><span class="pre">indices_x</span></code> and <code class="docutils literal notranslate"><span class="pre">indices_x_tr</span></code> as below.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">indices_x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim_x</span><span class="p">)]</span>
<span class="n">indices_x_tr</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">+</span> <span class="n">dim_x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">indices_x</span><span class="p">]</span>

<span class="n">preprocessor</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;poly_x&quot;</span><span class="p">,</span>
            <span class="n">PolyPlus</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">indices_x</span><span class="p">,</span>
        <span class="p">),</span>
        <span class="p">(</span>
            <span class="s2">&quot;poly_x_tr&quot;</span><span class="p">,</span>
            <span class="n">PolyPlus</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">indices_x_tr</span><span class="p">,</span>
        <span class="p">),</span>
    <span class="p">],</span>
    <span class="n">remainder</span><span class="o">=</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<p>This preprocessor can be applied for approaches <code class="docutils literal notranslate"><span class="pre">cre_general</span></code> and <code class="docutils literal notranslate"><span class="pre">cre_normal</span></code> in the same fashion. In this case the two sets of covariates would be the original <span class="math notranslate nohighlight">\(X_{it}\)</span> and the unit mean <span class="math notranslate nohighlight">\(\bar{X}_i\)</span>.</p>
<p><strong>Remark</strong>: Note that we set <code class="docutils literal notranslate"><span class="pre">remainder=&quot;passthrough&quot;</span></code> such that all remaining features, not part of <code class="docutils literal notranslate"><span class="pre">indices_x</span></code> and <code class="docutils literal notranslate"><span class="pre">indices_x_tr</span></code>, would not be preprocessed but still included in the nuisance estimation. This is particularly important for the <code class="docutils literal notranslate"><span class="pre">cre_normal</span></code> approach, as <span class="math notranslate nohighlight">\(\bar{D}_i\)</span> is further added to <span class="math notranslate nohighlight">\(X_{it}\)</span> and <span class="math notranslate nohighlight">\(\bar{X}_i\)</span> in the treatment nuisance model.</p>
<p>Finally, we can create the learner using a pipeline and fit the model.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ml_lasso</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">preprocessor</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">ml_lasso</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style>#sk-container-id-1 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-1 {
  color: var(--sklearn-color-text);
}

#sk-container-id-1 pre {
  padding: 0;
}

#sk-container-id-1 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-1 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-1 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-1 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-1 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-1 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-1 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-1 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-1 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-1 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-1 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-1 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-1 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-1 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-1 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-1 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-1 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-1 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-1 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-1 div.sk-label label.sk-toggleable__label,
#sk-container-id-1 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-1 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-1 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-1 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-1 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-1 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-1 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-1 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-1 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-1 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-1 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-1 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-1 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-1" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>Pipeline(steps=[(&#x27;columntransformer&#x27;,
                 ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                                   transformers=[(&#x27;poly_x&#x27;, PolyPlus(),
                                                  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                                                   10, 11, 12, 13, 14, 15, 16,
                                                   17, 18, 19, 20, 21, 22, 23,
                                                   24, 25, 26, 27, 28, 29]),
                                                 (&#x27;poly_x_tr&#x27;, PolyPlus(),
                                                  [30, 31, 32, 33, 34, 35, 36,
                                                   37, 38, 39, 40, 41, 42, 43,
                                                   44, 45, 46, 47, 48, 49, 50,
                                                   51, 52, 53, 54, 55, 56, 57,
                                                   58, 59])])),
                (&#x27;standardscaler&#x27;, StandardScaler()),
                (&#x27;lassocv&#x27;, LassoCV(cv=2, n_jobs=5))])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-1" type="checkbox" ><label for="sk-estimator-id-1" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>Pipeline</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.pipeline.Pipeline.html">?<span>Documentation for Pipeline</span></a><span class="sk-estimator-doc-link ">i<span>Not fitted</span></span></div></label><div class="sk-toggleable__content "><pre>Pipeline(steps=[(&#x27;columntransformer&#x27;,
                 ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                                   transformers=[(&#x27;poly_x&#x27;, PolyPlus(),
                                                  [0, 1, 2, 3, 4, 5, 6, 7, 8, 9,
                                                   10, 11, 12, 13, 14, 15, 16,
                                                   17, 18, 19, 20, 21, 22, 23,
                                                   24, 25, 26, 27, 28, 29]),
                                                 (&#x27;poly_x_tr&#x27;, PolyPlus(),
                                                  [30, 31, 32, 33, 34, 35, 36,
                                                   37, 38, 39, 40, 41, 42, 43,
                                                   44, 45, 46, 47, 48, 49, 50,
                                                   51, 52, 53, 54, 55, 56, 57,
                                                   58, 59])])),
                (&#x27;standardscaler&#x27;, StandardScaler()),
                (&#x27;lassocv&#x27;, LassoCV(cv=2, n_jobs=5))])</pre></div> </div></div><div class="sk-serial"><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-2" type="checkbox" ><label for="sk-estimator-id-2" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>columntransformer: ColumnTransformer</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.compose.ColumnTransformer.html">?<span>Documentation for columntransformer: ColumnTransformer</span></a></div></label><div class="sk-toggleable__content "><pre>ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                  transformers=[(&#x27;poly_x&#x27;, PolyPlus(),
                                 [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,
                                  14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24,
                                  25, 26, 27, 28, 29]),
                                (&#x27;poly_x_tr&#x27;, PolyPlus(),
                                 [30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40,
                                  41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51,
                                  52, 53, 54, 55, 56, 57, 58, 59])])</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-3" type="checkbox" ><label for="sk-estimator-id-3" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>poly_x</div></div></label><div class="sk-toggleable__content "><pre>[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29]</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-4" type="checkbox" ><label for="sk-estimator-id-4" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>PolyPlus</div></div></label><div class="sk-toggleable__content "><pre>PolyPlus()</pre></div> </div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-5" type="checkbox" ><label for="sk-estimator-id-5" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>poly_x_tr</div></div></label><div class="sk-toggleable__content "><pre>[30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59]</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-6" type="checkbox" ><label for="sk-estimator-id-6" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>PolyPlus</div></div></label><div class="sk-toggleable__content "><pre>PolyPlus()</pre></div> </div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-7" type="checkbox" ><label for="sk-estimator-id-7" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>remainder</div></div></label><div class="sk-toggleable__content "><pre></pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-8" type="checkbox" ><label for="sk-estimator-id-8" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>passthrough</div></div></label><div class="sk-toggleable__content "><pre>passthrough</pre></div> </div></div></div></div></div></div></div><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-9" type="checkbox" ><label for="sk-estimator-id-9" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>StandardScaler</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.preprocessing.StandardScaler.html">?<span>Documentation for StandardScaler</span></a></div></label><div class="sk-toggleable__content "><pre>StandardScaler()</pre></div> </div></div><div class="sk-item"><div class="sk-estimator  sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-10" type="checkbox" ><label for="sk-estimator-id-10" class="sk-toggleable__label  sk-toggleable__label-arrow"><div><div>LassoCV</div></div><div><a class="sk-estimator-doc-link " rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.linear_model.LassoCV.html">?<span>Documentation for LassoCV</span></a></div></label><div class="sk-toggleable__content "><pre>LassoCV(cv=2, n_jobs=5)</pre></div> </div></div></div></div></div></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_lasso_fd</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_dgp3</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_lasso</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_lasso</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;fd_exact&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plpr_lasso_fd</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_models</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">plpr_lasso_fd</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
            coef   std err          t          P&gt;|t|     2.5 %    97.5 %
d_diff  0.517696  0.018044  28.690074  5.074285e-181  0.482329  0.553062
</pre></div></div>
</div>
<p>Given that we apply the polynomial and interactions preprossing to two sets of 30 columns each, the number of features is 1050.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_lasso_fd</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;ml_m&quot;</span><span class="p">][</span><span class="s2">&quot;d_diff&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lassocv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_features_in_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1050
</pre></div></div>
</div>
<p>As describes above, for the <code class="docutils literal notranslate"><span class="pre">cre_normal</span></code> approach adds <span class="math notranslate nohighlight">\(\bar{X}_i\)</span> to the features used in the treatment nuisance estimation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_lasso_cre_normal</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_dgp3</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_lasso</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_lasso</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;cre_normal&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plpr_lasso_cre_normal</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_models</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">plpr_lasso_cre_normal</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
<span class="n">plpr_lasso_cre_normal</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;ml_m&quot;</span><span class="p">][</span><span class="s2">&quot;d&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lassocv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_features_in_</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
       coef   std err          t         P&gt;|t|     2.5 %    97.5 %
d  0.560037  0.028292  19.794714  3.306228e-87  0.504585  0.615488
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1051
</pre></div></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">wg_approx</span></code> approach, there is only one set of features. We can create a similar learner for this setting.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">preprocessor_wg</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;poly_x&quot;</span><span class="p">,</span>
            <span class="n">PolyPlus</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">indices_x</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">remainder</span><span class="o">=</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">ml_lasso_wg</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">preprocessor_wg</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_lasso_wg</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_dgp3</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_lasso_wg</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_lasso_wg</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;wg_approx&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_models</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">summary</span><span class="p">)</span>
<span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;ml_l&quot;</span><span class="p">][</span><span class="s2">&quot;d_demean&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lassocv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_features_in_</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
              coef   std err          t  P&gt;|t|     2.5 %    97.5 %
d_demean  1.151822  0.014172  81.277037    0.0  1.124047  1.179598
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
525
</pre></div></div>
</div>
<p>We can see that for the more complicated data generating process <code class="docutils literal notranslate"><span class="pre">dgp3</span></code>, the approximation approach performs worse compared to the other approaches.</p>
<p>As another example, below we should how to select a specific covariate subset for preprocessing. This can be useful in case of the data includes dummy covariates, where adding polynomials might not be appropriate.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x_cols</span> <span class="o">=</span> <span class="n">dml_data_dgp3</span><span class="o">.</span><span class="n">x_cols</span>
<span class="n">x_cols_to_pre</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;x3&quot;</span><span class="p">,</span> <span class="s2">&quot;x6&quot;</span><span class="p">,</span> <span class="s2">&quot;x22&quot;</span><span class="p">]</span>

<span class="n">indices_x_pre</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">x_cols</span><span class="p">)</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">x_cols_to_pre</span><span class="p">]</span>

<span class="n">preprocessor_alt</span> <span class="o">=</span> <span class="n">ColumnTransformer</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span>
            <span class="s2">&quot;poly_x&quot;</span><span class="p">,</span>
            <span class="n">PolyPlus</span><span class="p">(</span><span class="n">degree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">include_bias</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interaction_only</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
            <span class="n">indices_x_pre</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">remainder</span><span class="o">=</span><span class="s2">&quot;passthrough&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">ml_lasso_alt</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span>
    <span class="n">preprocessor_alt</span><span class="p">,</span> <span class="n">StandardScaler</span><span class="p">(),</span> <span class="n">LassoCV</span><span class="p">(</span><span class="n">cv</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="p">)</span>

<span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">learner</span><span class="p">[</span><span class="s2">&quot;ml_l&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_lasso_alt</span>
<span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">learner</span><span class="p">[</span><span class="s2">&quot;ml_m&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_lasso_alt</span>

<span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">store_models</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;ml_l&quot;</span><span class="p">][</span><span class="s2">&quot;d_demean&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s2">&quot;lassocv&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">n_features_in_</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
39
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;ml_l&quot;</span><span class="p">][</span><span class="s2">&quot;d_demean&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;columntransformer&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<style>#sk-container-id-2 {
  /* Definition of color scheme common for light and dark mode */
  --sklearn-color-text: #000;
  --sklearn-color-text-muted: #666;
  --sklearn-color-line: gray;
  /* Definition of color scheme for unfitted estimators */
  --sklearn-color-unfitted-level-0: #fff5e6;
  --sklearn-color-unfitted-level-1: #f6e4d2;
  --sklearn-color-unfitted-level-2: #ffe0b3;
  --sklearn-color-unfitted-level-3: chocolate;
  /* Definition of color scheme for fitted estimators */
  --sklearn-color-fitted-level-0: #f0f8ff;
  --sklearn-color-fitted-level-1: #d4ebff;
  --sklearn-color-fitted-level-2: #b3dbfd;
  --sklearn-color-fitted-level-3: cornflowerblue;

  /* Specific color for light theme */
  --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, white)));
  --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, black)));
  --sklearn-color-icon: #696969;

  @media (prefers-color-scheme: dark) {
    /* Redefinition of color scheme for dark theme */
    --sklearn-color-text-on-default-background: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-background: var(--sg-background-color, var(--theme-background, var(--jp-layout-color0, #111)));
    --sklearn-color-border-box: var(--sg-text-color, var(--theme-code-foreground, var(--jp-content-font-color1, white)));
    --sklearn-color-icon: #878787;
  }
}

#sk-container-id-2 {
  color: var(--sklearn-color-text);
}

#sk-container-id-2 pre {
  padding: 0;
}

#sk-container-id-2 input.sk-hidden--visually {
  border: 0;
  clip: rect(1px 1px 1px 1px);
  clip: rect(1px, 1px, 1px, 1px);
  height: 1px;
  margin: -1px;
  overflow: hidden;
  padding: 0;
  position: absolute;
  width: 1px;
}

#sk-container-id-2 div.sk-dashed-wrapped {
  border: 1px dashed var(--sklearn-color-line);
  margin: 0 0.4em 0.5em 0.4em;
  box-sizing: border-box;
  padding-bottom: 0.4em;
  background-color: var(--sklearn-color-background);
}

#sk-container-id-2 div.sk-container {
  /* jupyter's `normalize.less` sets `[hidden] { display: none; }`
     but bootstrap.min.css set `[hidden] { display: none !important; }`
     so we also need the `!important` here to be able to override the
     default hidden behavior on the sphinx rendered scikit-learn.org.
     See: https://github.com/scikit-learn/scikit-learn/issues/21755 */
  display: inline-block !important;
  position: relative;
}

#sk-container-id-2 div.sk-text-repr-fallback {
  display: none;
}

div.sk-parallel-item,
div.sk-serial,
div.sk-item {
  /* draw centered vertical line to link estimators */
  background-image: linear-gradient(var(--sklearn-color-text-on-default-background), var(--sklearn-color-text-on-default-background));
  background-size: 2px 100%;
  background-repeat: no-repeat;
  background-position: center center;
}

/* Parallel-specific style estimator block */

#sk-container-id-2 div.sk-parallel-item::after {
  content: "";
  width: 100%;
  border-bottom: 2px solid var(--sklearn-color-text-on-default-background);
  flex-grow: 1;
}

#sk-container-id-2 div.sk-parallel {
  display: flex;
  align-items: stretch;
  justify-content: center;
  background-color: var(--sklearn-color-background);
  position: relative;
}

#sk-container-id-2 div.sk-parallel-item {
  display: flex;
  flex-direction: column;
}

#sk-container-id-2 div.sk-parallel-item:first-child::after {
  align-self: flex-end;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:last-child::after {
  align-self: flex-start;
  width: 50%;
}

#sk-container-id-2 div.sk-parallel-item:only-child::after {
  width: 0;
}

/* Serial-specific style estimator block */

#sk-container-id-2 div.sk-serial {
  display: flex;
  flex-direction: column;
  align-items: center;
  background-color: var(--sklearn-color-background);
  padding-right: 1em;
  padding-left: 1em;
}


/* Toggleable style: style used for estimator/Pipeline/ColumnTransformer box that is
clickable and can be expanded/collapsed.
- Pipeline and ColumnTransformer use this feature and define the default style
- Estimators will overwrite some part of the style using the `sk-estimator` class
*/

/* Pipeline and ColumnTransformer style (default) */

#sk-container-id-2 div.sk-toggleable {
  /* Default theme specific background. It is overwritten whether we have a
  specific estimator or a Pipeline/ColumnTransformer */
  background-color: var(--sklearn-color-background);
}

/* Toggleable label */
#sk-container-id-2 label.sk-toggleable__label {
  cursor: pointer;
  display: flex;
  width: 100%;
  margin-bottom: 0;
  padding: 0.5em;
  box-sizing: border-box;
  text-align: center;
  align-items: start;
  justify-content: space-between;
  gap: 0.5em;
}

#sk-container-id-2 label.sk-toggleable__label .caption {
  font-size: 0.6rem;
  font-weight: lighter;
  color: var(--sklearn-color-text-muted);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:before {
  /* Arrow on the left of the label */
  content: "▸";
  float: left;
  margin-right: 0.25em;
  color: var(--sklearn-color-icon);
}

#sk-container-id-2 label.sk-toggleable__label-arrow:hover:before {
  color: var(--sklearn-color-text);
}

/* Toggleable content - dropdown */

#sk-container-id-2 div.sk-toggleable__content {
  max-height: 0;
  max-width: 0;
  overflow: hidden;
  text-align: left;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content pre {
  margin: 0.2em;
  border-radius: 0.25em;
  color: var(--sklearn-color-text);
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-toggleable__content.fitted pre {
  /* unfitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

#sk-container-id-2 input.sk-toggleable__control:checked~div.sk-toggleable__content {
  /* Expand drop-down */
  max-height: 200px;
  max-width: 100%;
  overflow: auto;
}

#sk-container-id-2 input.sk-toggleable__control:checked~label.sk-toggleable__label-arrow:before {
  content: "▾";
}

/* Pipeline/ColumnTransformer-specific style */

#sk-container-id-2 div.sk-label input.sk-toggleable__control:checked~label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-label.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator-specific style */

/* Colorize estimator box */
#sk-container-id-2 div.sk-estimator input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted input.sk-toggleable__control:checked~label.sk-toggleable__label {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

#sk-container-id-2 div.sk-label label.sk-toggleable__label,
#sk-container-id-2 div.sk-label label {
  /* The background is the default theme color */
  color: var(--sklearn-color-text-on-default-background);
}

/* On hover, darken the color of the background */
#sk-container-id-2 div.sk-label:hover label.sk-toggleable__label {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-unfitted-level-2);
}

/* Label box, darken color on hover, fitted */
#sk-container-id-2 div.sk-label.fitted:hover label.sk-toggleable__label.fitted {
  color: var(--sklearn-color-text);
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Estimator label */

#sk-container-id-2 div.sk-label label {
  font-family: monospace;
  font-weight: bold;
  display: inline-block;
  line-height: 1.2em;
}

#sk-container-id-2 div.sk-label-container {
  text-align: center;
}

/* Estimator-specific */
#sk-container-id-2 div.sk-estimator {
  font-family: monospace;
  border: 1px dotted var(--sklearn-color-border-box);
  border-radius: 0.25em;
  box-sizing: border-box;
  margin-bottom: 0.5em;
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-0);
}

#sk-container-id-2 div.sk-estimator.fitted {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-0);
}

/* on hover */
#sk-container-id-2 div.sk-estimator:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-2);
}

#sk-container-id-2 div.sk-estimator.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-2);
}

/* Specification for estimator info (e.g. "i" and "?") */

/* Common style for "i" and "?" */

.sk-estimator-doc-link,
a:link.sk-estimator-doc-link,
a:visited.sk-estimator-doc-link {
  float: right;
  font-size: smaller;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1em;
  height: 1em;
  width: 1em;
  text-decoration: none !important;
  margin-left: 0.5em;
  text-align: center;
  /* unfitted */
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
  color: var(--sklearn-color-unfitted-level-1);
}

.sk-estimator-doc-link.fitted,
a:link.sk-estimator-doc-link.fitted,
a:visited.sk-estimator-doc-link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
div.sk-estimator:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover,
div.sk-label-container:hover .sk-estimator-doc-link:hover,
.sk-estimator-doc-link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

div.sk-estimator.fitted:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover,
div.sk-label-container:hover .sk-estimator-doc-link.fitted:hover,
.sk-estimator-doc-link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

/* Span, style for the box shown on hovering the info icon */
.sk-estimator-doc-link span {
  display: none;
  z-index: 9999;
  position: relative;
  font-weight: normal;
  right: .2ex;
  padding: .5ex;
  margin: .5ex;
  width: min-content;
  min-width: 20ex;
  max-width: 50ex;
  color: var(--sklearn-color-text);
  box-shadow: 2pt 2pt 4pt #999;
  /* unfitted */
  background: var(--sklearn-color-unfitted-level-0);
  border: .5pt solid var(--sklearn-color-unfitted-level-3);
}

.sk-estimator-doc-link.fitted span {
  /* fitted */
  background: var(--sklearn-color-fitted-level-0);
  border: var(--sklearn-color-fitted-level-3);
}

.sk-estimator-doc-link:hover span {
  display: block;
}

/* "?"-specific style due to the `<a>` HTML tag */

#sk-container-id-2 a.estimator_doc_link {
  float: right;
  font-size: 1rem;
  line-height: 1em;
  font-family: monospace;
  background-color: var(--sklearn-color-background);
  border-radius: 1rem;
  height: 1rem;
  width: 1rem;
  text-decoration: none;
  /* unfitted */
  color: var(--sklearn-color-unfitted-level-1);
  border: var(--sklearn-color-unfitted-level-1) 1pt solid;
}

#sk-container-id-2 a.estimator_doc_link.fitted {
  /* fitted */
  border: var(--sklearn-color-fitted-level-1) 1pt solid;
  color: var(--sklearn-color-fitted-level-1);
}

/* On hover */
#sk-container-id-2 a.estimator_doc_link:hover {
  /* unfitted */
  background-color: var(--sklearn-color-unfitted-level-3);
  color: var(--sklearn-color-background);
  text-decoration: none;
}

#sk-container-id-2 a.estimator_doc_link.fitted:hover {
  /* fitted */
  background-color: var(--sklearn-color-fitted-level-3);
}
</style><div id="sk-container-id-2" class="sk-top-container"><div class="sk-text-repr-fallback"><pre>ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                  transformers=[(&#x27;poly_x&#x27;, PolyPlus(), [2, 5, 21])])</pre><b>In a Jupyter environment, please rerun this cell to show the HTML representation or trust the notebook. <br />On GitHub, the HTML representation is unable to render, please try loading this page with nbviewer.org.</b></div><div class="sk-container" hidden><div class="sk-item sk-dashed-wrapped"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-11" type="checkbox" ><label for="sk-estimator-id-11" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>ColumnTransformer</div></div><div><a class="sk-estimator-doc-link fitted" rel="noreferrer" target="_blank" href="https://scikit-learn.org/1.6/modules/generated/sklearn.compose.ColumnTransformer.html">?<span>Documentation for ColumnTransformer</span></a><span class="sk-estimator-doc-link fitted">i<span>Fitted</span></span></div></label><div class="sk-toggleable__content fitted"><pre>ColumnTransformer(remainder=&#x27;passthrough&#x27;,
                  transformers=[(&#x27;poly_x&#x27;, PolyPlus(), [2, 5, 21])])</pre></div> </div></div><div class="sk-parallel"><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-12" type="checkbox" ><label for="sk-estimator-id-12" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>poly_x</div></div></label><div class="sk-toggleable__content fitted"><pre>[2, 5, 21]</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-13" type="checkbox" ><label for="sk-estimator-id-13" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>PolyPlus</div></div></label><div class="sk-toggleable__content fitted"><pre>PolyPlus()</pre></div> </div></div></div></div></div><div class="sk-parallel-item"><div class="sk-item"><div class="sk-label-container"><div class="sk-label fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-14" type="checkbox" ><label for="sk-estimator-id-14" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>remainder</div></div></label><div class="sk-toggleable__content fitted"><pre>[0, 1, 3, 4, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 22, 23, 24, 25, 26, 27, 28, 29]</pre></div> </div></div><div class="sk-serial"><div class="sk-item"><div class="sk-estimator fitted sk-toggleable"><input class="sk-toggleable__control sk-hidden--visually" id="sk-estimator-id-15" type="checkbox" ><label for="sk-estimator-id-15" class="sk-toggleable__label fitted sk-toggleable__label-arrow"><div><div>passthrough</div></div></label><div class="sk-toggleable__content fitted"><pre>passthrough</pre></div> </div></div></div></div></div></div></div></div></div></div>
</div>
<p>We can also look at the resulting features.</p>
<p><strong>Remark</strong>: Note, however, that the feature names here refer only to the corresponding <code class="docutils literal notranslate"><span class="pre">x_cols</span></code> indices, not the column names from the <code class="docutils literal notranslate"><span class="pre">pd.DataFrame</span></code> because <a class="reference external" href="https://docs.doubleml.org/stable/index.html">DoubleML</a> uses <code class="docutils literal notranslate"><span class="pre">np.array</span></code>’s for fitting the model. Therefore the difference to the names from <code class="docutils literal notranslate"><span class="pre">x_cols_to_pre</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_lasso_wg</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="s2">&quot;ml_l&quot;</span><span class="p">][</span><span class="s2">&quot;d_demean&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">named_steps</span><span class="p">[</span><span class="s1">&#39;columntransformer&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_feature_names_out</span><span class="p">()</span>
<br/></pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;poly_x__x2&#39;, &#39;poly_x__x5&#39;, &#39;poly_x__x21&#39;, &#39;poly_x__x2^2&#39;,
       &#39;poly_x__x2 x5&#39;, &#39;poly_x__x2 x21&#39;, &#39;poly_x__x5^2&#39;,
       &#39;poly_x__x5 x21&#39;, &#39;poly_x__x21^2&#39;, &#39;poly_x__x2^3&#39;, &#39;poly_x__x5^3&#39;,
       &#39;poly_x__x21^3&#39;, &#39;remainder__x0&#39;, &#39;remainder__x1&#39;, &#39;remainder__x3&#39;,
       &#39;remainder__x4&#39;, &#39;remainder__x6&#39;, &#39;remainder__x7&#39;, &#39;remainder__x8&#39;,
       &#39;remainder__x9&#39;, &#39;remainder__x10&#39;, &#39;remainder__x11&#39;,
       &#39;remainder__x12&#39;, &#39;remainder__x13&#39;, &#39;remainder__x14&#39;,
       &#39;remainder__x15&#39;, &#39;remainder__x16&#39;, &#39;remainder__x17&#39;,
       &#39;remainder__x18&#39;, &#39;remainder__x19&#39;, &#39;remainder__x20&#39;,
       &#39;remainder__x22&#39;, &#39;remainder__x23&#39;, &#39;remainder__x24&#39;,
       &#39;remainder__x25&#39;, &#39;remainder__x26&#39;, &#39;remainder__x27&#39;,
       &#39;remainder__x28&#39;, &#39;remainder__x29&#39;], dtype=object)
</pre></div></div>
</div>
</section>
<section id="Hyperparameter-tuning">
<h2>Hyperparameter tuning<a class="headerlink" href="#Hyperparameter-tuning" title="Link to this heading">#</a></h2>
<p>In this section we will use the <code class="docutils literal notranslate"><span class="pre">tune_ml_models()</span></code> method to tune hyperparameters using the <a class="reference external" href="https://optuna.org/">Optuna</a> package. More details can found in the <a class="reference external" href="https://docs.doubleml.org/stable/examples/learners/py_optuna.html">Python: Hyperparametertuning with Optuna</a> example notebook.</p>
<p>As an example, we use <a class="reference external" href="https://lightgbm.readthedocs.io/en/stable/">LightGBM</a> regressors and compare the estimates for the different static panel model approaches, when applied to the non-linear and discontinuous <code class="docutils literal notranslate"><span class="pre">dgp3</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dim_x</span> <span class="o">=</span> <span class="mi">30</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
<span class="n">data_tune</span> <span class="o">=</span> <span class="n">make_plpr_CP2025</span><span class="p">(</span><span class="n">num_id</span><span class="o">=</span><span class="mi">4000</span><span class="p">,</span> <span class="n">num_t</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dim_x</span><span class="o">=</span><span class="n">dim_x</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">dgp_type</span><span class="o">=</span><span class="s2">&quot;dgp3&quot;</span><span class="p">)</span>
<span class="n">dml_data_tune</span> <span class="o">=</span> <span class="n">DoubleMLPanelData</span><span class="p">(</span><span class="n">data_tune</span><span class="p">,</span> <span class="n">y_col</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="n">d_cols</span><span class="o">=</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="n">t_col</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="n">id_col</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">static_panel</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ml_boost</span> <span class="o">=</span> <span class="n">LGBMRegressor</span><span class="p">(</span><span class="n">random_state</span><span class="o">=</span><span class="mi">314</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># parameter space for both ml models</span>
<span class="k">def</span><span class="w"> </span><span class="nf">ml_params</span><span class="p">(</span><span class="n">trial</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="s2">&quot;n_estimators&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
        <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;max_depth&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;max_depth&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span>
        <span class="s2">&quot;min_child_samples&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_int</span><span class="p">(</span><span class="s2">&quot;min_child_samples&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
        <span class="s2">&quot;reg_lambda&quot;</span><span class="p">:</span> <span class="n">trial</span><span class="o">.</span><span class="n">suggest_float</span><span class="p">(</span><span class="s2">&quot;reg_lambda&quot;</span><span class="p">,</span> <span class="mf">1e-2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">}</span>

<span class="n">param_space</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;ml_l&quot;</span><span class="p">:</span> <span class="n">ml_params</span><span class="p">,</span>
    <span class="s2">&quot;ml_m&quot;</span><span class="p">:</span> <span class="n">ml_params</span>
<span class="p">}</span>

<span class="n">optuna_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;n_trials&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;show_progress_bar&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s2">&quot;verbosity&quot;</span><span class="p">:</span> <span class="n">optuna</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>  <span class="c1"># Suppress Optuna logs</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_tune_cre_general</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_tune</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;cre_general&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">plpr_tune_cre_general</span><span class="o">.</span><span class="n">tune_ml_models</span><span class="p">(</span>
    <span class="n">ml_param_space</span><span class="o">=</span><span class="n">param_space</span><span class="p">,</span>
    <span class="n">optuna_settings</span><span class="o">=</span><span class="n">optuna_settings</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plpr_tune_cre_general</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">plpr_tune_cre_general</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "0e715d42cedf4f24b082a3742b6ba7a1", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c57d57e08ecf42fb9cd962f8743efa55", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>std err</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>2.5 %</th>
      <th>97.5 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>d</th>
      <td>0.495091</td>
      <td>0.007491</td>
      <td>66.088483</td>
      <td>0.0</td>
      <td>0.480408</td>
      <td>0.509774</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>0.509102</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_tune_cre_normal</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_tune</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;cre_normal&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">plpr_tune_cre_normal</span><span class="o">.</span><span class="n">tune_ml_models</span><span class="p">(</span>
    <span class="n">ml_param_space</span><span class="o">=</span><span class="n">param_space</span><span class="p">,</span>
    <span class="n">optuna_settings</span><span class="o">=</span><span class="n">optuna_settings</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plpr_tune_cre_normal</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">plpr_tune_cre_normal</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "c36de95d4af446f29d9f84c53133e9ed", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "cac1a8fb1bf34487b59b1551fb614da5", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>std err</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>2.5 %</th>
      <th>97.5 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>d</th>
      <td>0.489759</td>
      <td>0.010002</td>
      <td>48.968271</td>
      <td>0.0</td>
      <td>0.470156</td>
      <td>0.509362</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_tune_fd</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_tune</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;fd_exact&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">plpr_tune_fd</span><span class="o">.</span><span class="n">tune_ml_models</span><span class="p">(</span>
    <span class="n">ml_param_space</span><span class="o">=</span><span class="n">param_space</span><span class="p">,</span>
    <span class="n">optuna_settings</span><span class="o">=</span><span class="n">optuna_settings</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plpr_tune_fd</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">plpr_tune_fd</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "39ffcc1fef014cdc8010286cf9fe469c", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "860738384eec45e5893f926360202fa3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>std err</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>2.5 %</th>
      <th>97.5 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>d_diff</th>
      <td>0.549295</td>
      <td>0.008736</td>
      <td>62.878843</td>
      <td>0.0</td>
      <td>0.532174</td>
      <td>0.566417</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plpr_tune_wg</span> <span class="o">=</span> <span class="n">DoubleMLPLPR</span><span class="p">(</span><span class="n">dml_data_tune</span><span class="p">,</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">clone</span><span class="p">(</span><span class="n">ml_boost</span><span class="p">),</span> <span class="n">approach</span><span class="o">=</span><span class="s2">&quot;wg_approx&quot;</span><span class="p">,</span> <span class="n">n_folds</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="n">plpr_tune_wg</span><span class="o">.</span><span class="n">tune_ml_models</span><span class="p">(</span>
    <span class="n">ml_param_space</span><span class="o">=</span><span class="n">param_space</span><span class="p">,</span>
    <span class="n">optuna_settings</span><span class="o">=</span><span class="n">optuna_settings</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">plpr_tune_wg</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">plpr_tune_wg</span><span class="o">.</span><span class="n">summary</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "072390e43ee2426caf19fa0ffbb35cc4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "bbb6ac2639ac4a91957b849b4cd874f3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>coef</th>
      <th>std err</th>
      <th>t</th>
      <th>P&gt;|t|</th>
      <th>2.5 %</th>
      <th>97.5 %</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>d_demean</th>
      <td>1.133962</td>
      <td>0.005109</td>
      <td>221.970892</td>
      <td>0.0</td>
      <td>1.123949</td>
      <td>1.143975</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">palette</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">color_palette</span><span class="p">(</span><span class="s2">&quot;colorblind&quot;</span><span class="p">)</span>

<span class="n">ci_cre_general</span> <span class="o">=</span> <span class="n">plpr_tune_cre_general</span><span class="o">.</span><span class="n">confint</span><span class="p">()</span>
<span class="n">ci_cre_normal</span> <span class="o">=</span> <span class="n">plpr_tune_cre_normal</span><span class="o">.</span><span class="n">confint</span><span class="p">()</span>
<span class="n">ci_fd</span> <span class="o">=</span> <span class="n">plpr_tune_fd</span><span class="o">.</span><span class="n">confint</span><span class="p">()</span>
<span class="n">ci_wg</span> <span class="o">=</span> <span class="n">plpr_tune_wg</span><span class="o">.</span><span class="n">confint</span><span class="p">()</span>

<span class="n">comparison_data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Model&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;cre_general&quot;</span><span class="p">,</span> <span class="s2">&quot;cre_normal&quot;</span><span class="p">,</span> <span class="s2">&quot;fd_exact&quot;</span><span class="p">,</span> <span class="s2">&quot;wg_approx&quot;</span><span class="p">],</span>
    <span class="s2">&quot;theta&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">plpr_tune_cre_general</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plpr_tune_cre_normal</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plpr_tune_fd</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plpr_tune_wg</span><span class="o">.</span><span class="n">coef</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="s2">&quot;se&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">plpr_tune_cre_general</span><span class="o">.</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plpr_tune_cre_normal</span><span class="o">.</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plpr_tune_fd</span><span class="o">.</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">plpr_tune_wg</span><span class="o">.</span><span class="n">se</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
    <span class="s2">&quot;ci_lower&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ci_cre_general</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ci_cre_normal</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ci_fd</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">ci_wg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]],</span>
    <span class="s2">&quot;ci_upper&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">ci_cre_general</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ci_cre_normal</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ci_fd</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">ci_wg</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>
<span class="p">}</span>
<span class="n">df_comparison</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparison_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;True treatment effect: </span><span class="si">{</span><span class="n">theta</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_comparison</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="c1"># Create comparison plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">df_comparison</span><span class="p">)):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">df_comparison</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">],</span>
                 <span class="n">yerr</span><span class="o">=</span><span class="p">[[</span><span class="n">df_comparison</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_comparison</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;ci_lower&quot;</span><span class="p">]],</span>
                       <span class="p">[</span><span class="n">df_comparison</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;ci_upper&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_comparison</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;theta&quot;</span><span class="p">]]],</span>
                 <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">capsize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ecolor</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                 <span class="n">label</span><span class="o">=</span><span class="n">df_comparison</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">palette</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;True effect&quot;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Comparison across DoubleMLPLPR approaches&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Coefficient Value&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span> <span class="n">df_comparison</span><span class="p">[</span><span class="s2">&quot;Model&quot;</span><span class="p">],</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;right&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
True treatment effect: 0.5

      Model    theta       se  ci_lower  ci_upper
cre_general 0.495091 0.007491  0.480408  0.509774
 cre_normal 0.489759 0.010002  0.470156  0.509362
   fd_exact 0.549295 0.008736  0.532174  0.566417
  wg_approx 1.133962 0.005109  1.123949  1.143975
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/examples_py_double_ml_plpr_65_1.png" src="../_images/examples_py_double_ml_plpr_65_1.png" />
</div>
</div>
<p>We again see that the <code class="docutils literal notranslate"><span class="pre">wg_approx</span></code> leads to a biased estimate in the non-linear and discontinuous <code class="docutils literal notranslate"><span class="pre">dgp3</span></code> setting. The approaches <code class="docutils literal notranslate"><span class="pre">cre_general</span></code>, <code class="docutils literal notranslate"><span class="pre">cre_normal</span></code>, <code class="docutils literal notranslate"><span class="pre">fd_exact</span></code>, in combination with <a class="reference external" href="https://lightgbm.readthedocs.io/en/stable/">LightGBM</a> regressors, tuned using the <a class="reference external" href="https://optuna.org/">Optuna</a> package, lead to estimate close to the true treatment effect.</p>
<p>This is line with the simulation results in <a class="reference external" href="https://doi.org/10.1093/ectj/utaf011">Clarke and Polselli (2025)</a>, albeit only for only one dataset in this example.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="py_double_ml_lplr.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Python: Log-Odds Effects for Logistic PLR models</p>
      </div>
    </a>
    <a class="right-next"
       href="py_double_ml_ssm.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Python: Sample Selection Models</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Data">Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Model">Model</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Assumptions">Assumptions</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Estimation-Approaches">Estimation Approaches</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Correlated-Random-Effects">Correlated Random Effects</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cre_general"><code class="docutils literal notranslate"><span class="pre">cre_general</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#cre_normal"><code class="docutils literal notranslate"><span class="pre">cre_normal</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Transformation-Approaches">Transformation Approaches</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#fd_exact"><code class="docutils literal notranslate"><span class="pre">fd_exact</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#wg_approx"><code class="docutils literal notranslate"><span class="pre">wg_approx</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Feature-preprocessing-pipelines">Feature preprocessing pipelines</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Hyperparameter-tuning">Hyperparameter tuning</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/DoubleML/doubleml-docs/edit/dev/doc/examples/py_double_ml_plpr.ipynb">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/examples/py_double_ml_plpr.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2023, Bach, P., Chernozhukov, V., Klaassen, S., Kurz, M. S., and Spindler, M..
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.4.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>